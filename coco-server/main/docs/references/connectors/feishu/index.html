<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Feishu/Lark Connector #  The Feishu/Lark connector indexes cloud documents from Feishu and Lark, including documents, spreadsheets, mind notes, multi-dimensional tables, and knowledge bases.
Features #   üîç Smart Search: Keyword-based search for cloud documents üìö Multiple Document Types: Support for doc, sheet, slides, mindnote, bitable, file, docx, folder, shortcut üîê Dual Authentication: OAuth 2.0 and user access token authentication (choose one) ‚ö° Efficient Sync: Scheduled and manual synchronization üîÑ Recursive Search: Automatically search folder contents recursively üîÑ Token Auto-refresh: OAuth authentication supports automatic refresh of access_token and refresh_token üåê Dynamic Redirect: Supports dynamic OAuth redirect URI construction for multi-environment deployment üèóÔ∏è Unified Architecture: Feishu and Lark share base implementation with 95% code reuse  Supported Platforms #  Feishu #   Domain: open."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Feishu/Lark"><meta property="og:description" content="Feishu/Lark Connector #  The Feishu/Lark connector indexes cloud documents from Feishu and Lark, including documents, spreadsheets, mind notes, multi-dimensional tables, and knowledge bases.
Features #   üîç Smart Search: Keyword-based search for cloud documents üìö Multiple Document Types: Support for doc, sheet, slides, mindnote, bitable, file, docx, folder, shortcut üîê Dual Authentication: OAuth 2.0 and user access token authentication (choose one) ‚ö° Efficient Sync: Scheduled and manual synchronization üîÑ Recursive Search: Automatically search folder contents recursively üîÑ Token Auto-refresh: OAuth authentication supports automatic refresh of access_token and refresh_token üåê Dynamic Redirect: Supports dynamic OAuth redirect URI construction for multi-environment deployment üèóÔ∏è Unified Architecture: Feishu and Lark share base implementation with 95% code reuse  Supported Platforms #  Feishu #   Domain: open."><meta property="og:type" content="article"><meta property="og:url" content="/coco-server/main/docs/references/connectors/feishu/"><title>Feishu/Lark | Coco Server</title><link rel=manifest href=/coco-server/main/manifest.json><link rel=icon href=/coco-server/main/favicon.png type=image/x-icon><link rel=stylesheet href=/coco-server/main/book.min.d80e87b12a4b49d9913d0bdd98bd83b7a44988be784760ba15522b377313dcf9.css integrity="sha256-2A6HsSpLSdmRPQvdmL2Dt6RJiL54R2C6FVIrN3MT3Pk="><script defer src=/coco-server/main/js/jquery-2.x.min.js></script><script defer src=/coco-server/main/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/coco-server/main><img src=/coco-server/main/img/logo-en.svg alt=Logo></a></h2><div id=searchbox style=margin-bottom:10px;outline:none></div><div class=heading><select class=version-selector>
<option value>main (latest)</option>
<option value=v0.7.1>v0.7.1</option>
<option value=v0.7.0>v0.7.0</option>
<option value=v0.6.0>v0.6.0</option>
<option value=v0.5.0>v0.5.0</option>
<option value=v0.4.0>v0.4.0</option>
<option value=v0.3.0>v0.3.0</option>
<option value=v0.2.2>v0.2.2</option></select></div><ul><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>Getting Started</a>
<span>‚ñæ</span></label><ul><li><a href=/coco-server/main/docs/getting-started/install/>Installation</a></li><li><a href=/coco-server/main/docs/getting-started/setup/>Setup Wizard</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle checked>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a href=/coco-server/main/docs/references/>References</a>
<span>‚ñæ</span></label><ul><li><input type=checkbox id=section-97bb467845ddef2c28eba43b4c87ba98 class=toggle>
<label for=section-97bb467845ddef2c28eba43b4c87ba98 class="flex justify-between"><a>System</a>
<span>‚ñæ</span></label><ul><li><a href=/coco-server/main/docs/references/system/install/>System Initialization</a></li><li><a href=/coco-server/main/docs/references/system/settings/>System Settings</a></li></ul></li><li><input type=checkbox id=section-830be57e26216c4b31d75f7e80eea5a9 class=toggle>
<label for=section-830be57e26216c4b31d75f7e80eea5a9 class="flex justify-between"><a>Account</a>
<span>‚ñæ</span></label><ul><li><a href=/coco-server/main/docs/references/account/authentication/>Authentication</a></li><li><a href=/coco-server/main/docs/references/account/access_token/>API Token</a></li><li><a href=/coco-server/main/docs/references/account/password/>Modify Password</a></li><li><a href=/coco-server/main/docs/references/account/profile/>Profile</a></li><li><a href=/coco-server/main/docs/references/account/logout/>Logout</a></li></ul></li><li><a href=/coco-server/main/docs/references/assistant/>Assistant</a></li><li><a href=/coco-server/main/docs/references/document/>Document</a></li><li><a href=/coco-server/main/docs/references/search/>Search</a></li><li><a href=/coco-server/main/docs/references/datasource/>Datasource</a></li><li><a href=/coco-server/main/docs/references/integration/>Integration</a></li><li><a href=/coco-server/main/docs/references/mcp_server/>MCP Server</a></li><li><a href=/coco-server/main/docs/references/model_provider/>Model Provider</a></li><li><a href=/coco-server/main/docs/references/attachment/>Attachment</a></li><li><input type=checkbox id=section-6163ea64c3eeec962ea0b7215fc64522 class=toggle checked>
<label for=section-6163ea64c3eeec962ea0b7215fc64522 class="flex justify-between"><a href=/coco-server/main/docs/references/connectors/>Connectors</a>
<span>‚ñæ</span></label><ul><li><a href=/coco-server/main/docs/references/connectors/google_drive/>Google Drive</a></li><li><a href=/coco-server/main/docs/references/connectors/hugo_site/>Hugo Site</a></li><li><a href=/coco-server/main/docs/references/connectors/rss/>RSS</a></li><li><a href=/coco-server/main/docs/references/connectors/confluence/>Confluence</a></li><li><a href=/coco-server/main/docs/references/connectors/local_fs/>Local FS</a></li><li><a href=/coco-server/main/docs/references/connectors/network_drive/>Network Drive</a></li><li><a href=/coco-server/main/docs/references/connectors/notion/>Notion</a></li><li><a href=/coco-server/main/docs/references/connectors/s3/>S3</a></li><li><a href=/coco-server/main/docs/references/connectors/yuque/>Yuque</a></li><li><a href=/coco-server/main/docs/references/connectors/feishu/ class=active>Feishu/Lark</a></li><li><a href=/coco-server/main/docs/references/connectors/mysql/>MySQL</a></li><li><a href=/coco-server/main/docs/references/connectors/postgresql/>PostgreSQL</a></li><li><a href=/coco-server/main/docs/references/connectors/mssql/>MS SQL</a></li><li><a href=/coco-server/main/docs/references/connectors/oracle/>Oracle</a></li><li><a href=/coco-server/main/docs/references/connectors/github/>GitHub</a></li><li><a href=/coco-server/main/docs/references/connectors/salesforce/>Salesforce</a></li><li><a href=/coco-server/main/docs/references/connectors/gitlab/>GitLab</a></li><li><a href=/coco-server/main/docs/references/connectors/gitea/>Gitea</a></li></ul></li></ul></li><li><input type=checkbox id=section-7dd85575c84e6825eb9419e748eb5977 class=toggle>
<label for=section-7dd85575c84e6825eb9419e748eb5977 class="flex justify-between"><a href=/coco-server/main/docs/tutorials/>Tutorials</a>
<span>‚ñæ</span></label><ul><li><a href=/coco-server/main/docs/tutorials/howto_create_your_own_datasource/>How to integrate Coco AI with your own datasource</a></li></ul></li><li><a href=/coco-server/main/docs/release-notes/>Release Notes</a><ul></ul></li></ul><ul><li><a href=https://github.com/infinilabs/coco-server target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/coco-server/main/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Feishu/Lark</strong>
<label for=toc-control><img src=/coco-server/main/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#feishulark-connector>Feishu/Lark Connector</a><ul><li><a href=#features>Features</a></li><li><a href=#supported-platforms>Supported Platforms</a><ul><li><a href=#feishu>Feishu</a></li><li><a href=#lark>Lark</a></li></ul></li><li><a href=#authentication-methods>Authentication Methods</a><ul><li><a href=#1-oauth-20-authentication-recommended>1. OAuth 2.0 Authentication (Recommended)</a></li><li><a href=#2-user-access-token-authentication-alternative>2. User Access Token Authentication (Alternative)</a></li></ul></li><li><a href=#feishulark-app-permission-configuration>Feishu/Lark App Permission Configuration</a><ul><li><a href=#required-permissions>Required Permissions</a></li><li><a href=#permission-application-steps>Permission Application Steps</a></li><li><a href=#permission-description>Permission Description</a></li></ul></li><li><a href=#configuration-architecture>Configuration Architecture</a><ul><li><a href=#connector-level-oauth-configuration>Connector Level (OAuth Configuration)</a></li><li><a href=#datasource-level-auto-generated>Datasource Level (Auto-generated)</a></li></ul></li><li><a href=#register-connectors>Register Connectors</a><ul><li><a href=#register-feishu-connector>Register Feishu Connector</a></li><li><a href=#register-lark-connector>Register Lark Connector</a></li></ul></li><li><a href=#update-coco-server-config>Update coco-server config</a><ul><li><a href=#feishu-configuration>Feishu Configuration</a></li><li><a href=#lark-configuration>Lark Configuration</a></li></ul></li><li><a href=#create-a-datasource>Create a Datasource</a><ul><li><a href=#method-1-oauth-authentication-recommended>Method 1: OAuth Authentication (Recommended)</a></li><li><a href=#method-2-user-access-token-authentication-legacy>Method 2: User Access Token Authentication (Legacy)</a></li></ul></li><li><a href=#configuration-parameters>Configuration Parameters</a><ul><li><a href=#required-parameters>Required Parameters</a></li><li><a href=#oauth-auto-filled-fields>OAuth Auto-filled Fields</a></li><li><a href=#sync-configuration>Sync Configuration</a></li></ul></li><li><a href=#supported-document-types>Supported Document Types</a></li><li><a href=#usage-instructions>Usage Instructions</a><ul><li><a href=#method-1-oauth-authentication-recommended-1>Method 1: OAuth Authentication (Recommended)</a></li><li><a href=#method-2-user-access-token>Method 2: User Access Token</a></li></ul></li><li><a href=#technical-implementation>Technical Implementation</a><ul><li><a href=#architecture-design>Architecture Design</a></li><li><a href=#oauth-route-registration>OAuth Route Registration</a></li><li><a href=#token-lifecycle-management>Token Lifecycle Management</a></li><li><a href=#special-type-processing>Special Type Processing</a></li></ul></li><li><a href=#important-notes>Important Notes</a></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#common-issues>Common Issues</a></li><li><a href=#log-debugging>Log Debugging</a></li></ul></li><li><a href=#extensibility>Extensibility</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=feishulark-connector>Feishu/Lark Connector
<a class=anchor href=#feishulark-connector>#</a></h1><p>The Feishu/Lark connector indexes cloud documents from Feishu and Lark, including documents, spreadsheets, mind notes, multi-dimensional tables, and knowledge bases.</p><h2 id=features>Features
<a class=anchor href=#features>#</a></h2><ul><li>üîç <strong>Smart Search</strong>: Keyword-based search for cloud documents</li><li>üìö <strong>Multiple Document Types</strong>: Support for doc, sheet, slides, mindnote, bitable, file, docx, folder, shortcut</li><li>üîê <strong>Dual Authentication</strong>: OAuth 2.0 and user access token authentication (choose one)</li><li>‚ö° <strong>Efficient Sync</strong>: Scheduled and manual synchronization</li><li>üîÑ <strong>Recursive Search</strong>: Automatically search folder contents recursively</li><li>üîÑ <strong>Token Auto-refresh</strong>: OAuth authentication supports automatic refresh of access_token and refresh_token</li><li>üåê <strong>Dynamic Redirect</strong>: Supports dynamic OAuth redirect URI construction for multi-environment deployment</li><li>üèóÔ∏è <strong>Unified Architecture</strong>: Feishu and Lark share base implementation with 95% code reuse</li></ul><h2 id=supported-platforms>Supported Platforms
<a class=anchor href=#supported-platforms>#</a></h2><h3 id=feishu>Feishu
<a class=anchor href=#feishu>#</a></h3><ul><li><strong>Domain</strong>: <code>open.feishu.cn</code> / <code>accounts.feishu.cn</code></li><li><strong>Connector ID</strong>: <code>feishu</code></li><li><strong>Region</strong>: Mainland China</li></ul><h3 id=lark>Lark
<a class=anchor href=#lark>#</a></h3><ul><li><strong>Domain</strong>: <code>open.larksuite.com</code> / <code>accounts.larksuite.com</code></li><li><strong>Connector ID</strong>: <code>lark</code></li><li><strong>Region</strong>: Overseas regions</li></ul><h2 id=authentication-methods>Authentication Methods
<a class=anchor href=#authentication-methods>#</a></h2><p>The Feishu/Lark connector supports two authentication methods. <strong>You must choose one</strong>:</p><h3 id=1-oauth-20-authentication-recommended>1. OAuth 2.0 Authentication (Recommended)
<a class=anchor href=#1-oauth-20-authentication-recommended>#</a></h3><p>Uses OAuth flow to automatically obtain user access tokens with automatic refresh support and expiration time management.</p><h4 id=requirements>Requirements
<a class=anchor href=#requirements>#</a></h4><ul><li><code>client_id</code>: Feishu/Lark app Client ID</li><li><code>client_secret</code>: Feishu/Lark app Client Secret</li><li><code>document_types</code>: List of document types to synchronize</li></ul><h4 id=authentication-flow>Authentication Flow
<a class=anchor href=#authentication-flow>#</a></h4><ol><li>User creates Feishu/Lark datasource with <code>client_id</code> and <code>client_secret</code></li><li>Clicks &ldquo;Connect&rdquo; button, system redirects to Feishu/Lark authorization page</li><li>User completes authorization, system automatically obtains <code>access_token</code> and <code>refresh_token</code></li><li>System automatically updates datasource configuration with complete OAuth information and expiration times</li></ol><h4 id=advantages>Advantages
<a class=anchor href=#advantages>#</a></h4><ul><li>High security, no manual token management required</li><li>Automatic access_token and refresh_token refresh support</li><li>Automatic token expiration time management</li><li>Automatic user information retrieval</li><li>Compliant with OAuth 2.0 standards</li><li>Supports multi-environment deployment (dynamic redirect URI)</li></ul><h3 id=2-user-access-token-authentication-alternative>2. User Access Token Authentication (Alternative)
<a class=anchor href=#2-user-access-token-authentication-alternative>#</a></h3><p>Directly uses user access tokens, suitable for scenarios with existing tokens.</p><h4 id=requirements-1>Requirements
<a class=anchor href=#requirements-1>#</a></h4><ul><li><code>user_access_token</code>: User&rsquo;s access token</li><li><code>document_types</code>: List of document types to synchronize</li></ul><h4 id=use-cases>Use Cases
<a class=anchor href=#use-cases>#</a></h4><ul><li>Already have valid user access tokens</li><li>Don&rsquo;t want to use OAuth flow</li><li>Testing or development environments</li></ul><h4 id=considerations>Considerations
<a class=anchor href=#considerations>#</a></h4><ul><li>Manual token expiration management required</li><li>Manual token updates needed after expiration</li><li>Relatively lower security</li></ul><h2 id=feishulark-app-permission-configuration>Feishu/Lark App Permission Configuration
<a class=anchor href=#feishulark-app-permission-configuration>#</a></h2><h3 id=required-permissions>Required Permissions
<a class=anchor href=#required-permissions>#</a></h3><p>The Feishu/Lark connector requires the following permissions to function properly:</p><table><thead><tr><th>Permission</th><th>Permission Code</th><th>Description</th><th>Purpose</th></tr></thead><tbody><tr><td><strong>Cloud Document Access</strong></td><td><code>drive:drive</code></td><td>Access user&rsquo;s cloud documents, spreadsheets, slides, etc.</td><td>Read and index cloud document content</td></tr><tr><td><strong>Knowledge Base Retrieval</strong></td><td><code>space:document:retrieve</code></td><td>Retrieve documents from knowledge bases</td><td>Access knowledge bases and space documents</td></tr><tr><td><strong>Offline Access</strong></td><td><code>offline_access</code></td><td>Access resources when user is offline</td><td>Support background sync tasks</td></tr></tbody></table><h3 id=permission-application-steps>Permission Application Steps
<a class=anchor href=#permission-application-steps>#</a></h3><h4 id=feishu-app>Feishu App
<a class=anchor href=#feishu-app>#</a></h4><ol><li><p><strong>Login to Feishu Open Platform</strong></p><ul><li>Visit
<a href=https://open.feishu.cn/>https://open.feishu.cn/</a></li><li>Login with Feishu account</li></ul></li><li><p><strong>Create Application</strong></p><ul><li>Click &ldquo;Create Application&rdquo;</li><li>Select &ldquo;Enterprise Self-built Application&rdquo;</li><li>Fill in application name and description</li></ul></li><li><p><strong>Apply for Permissions</strong></p><ul><li>Go to &ldquo;Permission Management&rdquo; page</li><li>Search and add the three permissions above</li><li>Submit permission application</li></ul></li><li><p><strong>Publish Application</strong></p><ul><li>After completing permission application, publish application to enterprise</li><li>Record the app&rsquo;s <code>Client ID</code> and <code>Client Secret</code></li></ul></li></ol><h4 id=lark-app>Lark App
<a class=anchor href=#lark-app>#</a></h4><ol><li><p><strong>Login to Lark Open Platform</strong></p><ul><li>Visit
<a href=https://open.larksuite.com/>https://open.larksuite.com/</a></li><li>Login with Lark account</li></ul></li><li><p><strong>Create Application</strong></p><ul><li>Click &ldquo;Create Application&rdquo;</li><li>Select &ldquo;Enterprise Self-built Application&rdquo;</li><li>Fill in application name and description</li></ul></li><li><p><strong>Apply for Permissions</strong></p><ul><li>Go to &ldquo;Permission Management&rdquo; page</li><li>Search and add the three permissions above</li><li>Submit permission application</li></ul></li><li><p><strong>Publish Application</strong></p><ul><li>After completing permission application, publish application to enterprise</li><li>Record the app&rsquo;s <code>Client ID</code> and <code>Client Secret</code></li></ul></li></ol><h3 id=permission-description>Permission Description
<a class=anchor href=#permission-description>#</a></h3><ul><li><strong><code>drive:drive</code></strong>: This is the core permission for accessing cloud documents, allowing the app to read user&rsquo;s documents, spreadsheets, slides, and other files</li><li><strong><code>space:document:retrieve</code></strong>: Used to access documents in knowledge bases and spaces, expanding document access scope</li><li><strong><code>offline_access</code></strong>: Allows the app to access resources when user is offline, which is crucial for background sync tasks</li></ul><h2 id=configuration-architecture>Configuration Architecture
<a class=anchor href=#configuration-architecture>#</a></h2><h3 id=connector-level-oauth-configuration>Connector Level (OAuth Configuration)
<a class=anchor href=#connector-level-oauth-configuration>#</a></h3><p>The OAuth configuration is now managed at the connector level. This provides better security and centralized management.</p><h4 id=feishu-connector-configuration>Feishu Connector Configuration
<a class=anchor href=#feishu-connector-configuration>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>connector</span>:
  <span style=color:#f92672>feishu</span>:
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>interval</span>: <span style=color:#e6db74>&#34;30s&#34;</span>
    <span style=color:#f92672>page_size</span>: <span style=color:#ae81ff>100</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#75715e># OAuth Configuration (Required for OAuth flow)</span>
      <span style=color:#f92672>auth_url</span>: <span style=color:#e6db74>&#34;https://accounts.feishu.cn/open-apis/authen/v1/authorize&#34;</span>
      <span style=color:#f92672>token_url</span>: <span style=color:#e6db74>&#34;https://open.feishu.cn/open-apis/authen/v2/oauth/token&#34;</span>
      <span style=color:#f92672>redirect_url</span>: <span style=color:#e6db74>&#34;/connector/feishu/oauth_redirect&#34;</span>
      <span style=color:#f92672>client_id</span>: <span style=color:#e6db74>&#34;cli_xxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>client_secret</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>document_types</span>: [<span style=color:#e6db74>&#34;doc&#34;</span>, <span style=color:#e6db74>&#34;sheet&#34;</span>, <span style=color:#e6db74>&#34;slides&#34;</span>, <span style=color:#e6db74>&#34;mindnote&#34;</span>, <span style=color:#e6db74>&#34;bitable&#34;</span>]
      <span style=color:#f92672>user_access_token</span>: <span style=color:#e6db74>&#34;&#34;</span>  <span style=color:#75715e># Optional, for direct token authentication</span>
</code></pre></div><h4 id=lark-connector-configuration>Lark Connector Configuration
<a class=anchor href=#lark-connector-configuration>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>connector</span>:
  <span style=color:#f92672>lark</span>:
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>interval</span>: <span style=color:#e6db74>&#34;30s&#34;</span>
    <span style=color:#f92672>page_size</span>: <span style=color:#ae81ff>100</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#75715e># OAuth Configuration (Required for OAuth flow)</span>
      <span style=color:#f92672>auth_url</span>: <span style=color:#e6db74>&#34;https://accounts.larksuite.com/open-apis/authen/v1/authorize&#34;</span>
      <span style=color:#f92672>token_url</span>: <span style=color:#e6db74>&#34;https://open.larksuite.com/open-apis/authen/v2/oauth/token&#34;</span>
      <span style=color:#f92672>redirect_url</span>: <span style=color:#e6db74>&#34;/connector/lark/oauth_redirect&#34;</span>
      <span style=color:#f92672>client_id</span>: <span style=color:#e6db74>&#34;cli_xxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>client_secret</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>document_types</span>: [<span style=color:#e6db74>&#34;doc&#34;</span>, <span style=color:#e6db74>&#34;sheet&#34;</span>, <span style=color:#e6db74>&#34;slides&#34;</span>, <span style=color:#e6db74>&#34;mindnote&#34;</span>, <span style=color:#e6db74>&#34;bitable&#34;</span>]
      <span style=color:#f92672>user_access_token</span>: <span style=color:#e6db74>&#34;&#34;</span>  <span style=color:#75715e># Optional, for direct token authentication</span>
</code></pre></div><h3 id=datasource-level-auto-generated>Datasource Level (Auto-generated)
<a class=anchor href=#datasource-level-auto-generated>#</a></h3><p>When using OAuth authentication, datasources are automatically created during the OAuth flow. The system automatically generates:</p><h4 id=auto-generated-feishu-datasource>Auto-generated Feishu Datasource
<a class=anchor href=#auto-generated-feishu-datasource>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>datasource</span>:
  <span style=color:#f92672>id</span>: <span style=color:#e6db74>&#34;auto-generated-id&#34;</span>
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;User&#39;s Feishu&#34;</span>  <span style=color:#75715e># Auto-generated based on user profile</span>
  <span style=color:#f92672>type</span>: <span style=color:#e6db74>&#34;connector&#34;</span>
  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>sync</span>:
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>connector</span>:
    <span style=color:#f92672>id</span>: <span style=color:#e6db74>&#34;feishu&#34;</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#75715e># OAuth tokens (auto-filled during OAuth flow)</span>
      <span style=color:#f92672>access_token</span>: <span style=color:#e6db74>&#34;u-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>refresh_token</span>: <span style=color:#e6db74>&#34;r-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>token_expiry</span>: <span style=color:#e6db74>&#34;2024-01-01T12:00:00Z&#34;</span>
      <span style=color:#f92672>refresh_token_expiry</span>: <span style=color:#e6db74>&#34;2024-01-31T12:00:00Z&#34;</span>
      <span style=color:#f92672>profile</span>:
        <span style=color:#f92672>user_id</span>: <span style=color:#e6db74>&#34;ou_xxxxxxxxxxxxxxxx&#34;</span>
        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;User Name&#34;</span>
        <span style=color:#f92672>email</span>: <span style=color:#e6db74>&#34;user@example.com&#34;</span>
</code></pre></div><h4 id=auto-generated-lark-datasource>Auto-generated Lark Datasource
<a class=anchor href=#auto-generated-lark-datasource>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>datasource</span>:
  <span style=color:#f92672>id</span>: <span style=color:#e6db74>&#34;auto-generated-id&#34;</span>
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;User&#39;s Lark&#34;</span>  <span style=color:#75715e># Auto-generated based on user profile</span>
  <span style=color:#f92672>type</span>: <span style=color:#e6db74>&#34;connector&#34;</span>
  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>sync</span>:
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>connector</span>:
    <span style=color:#f92672>id</span>: <span style=color:#e6db74>&#34;lark&#34;</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#75715e># OAuth tokens (auto-filled during OAuth flow)</span>
      <span style=color:#f92672>access_token</span>: <span style=color:#e6db74>&#34;u-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>refresh_token</span>: <span style=color:#e6db74>&#34;r-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>token_expiry</span>: <span style=color:#e6db74>&#34;2024-01-01T12:00:00Z&#34;</span>
      <span style=color:#f92672>refresh_token_expiry</span>: <span style=color:#e6db74>&#34;2024-01-31T12:00:00Z&#34;</span>
      <span style=color:#f92672>profile</span>:
        <span style=color:#f92672>user_id</span>: <span style=color:#e6db74>&#34;ou_xxxxxxxxxxxxxxxx&#34;</span>
        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;User Name&#34;</span>
        <span style=color:#f92672>email</span>: <span style=color:#e6db74>&#34;user@example.com&#34;</span>
</code></pre></div><h2 id=register-connectors>Register Connectors
<a class=anchor href=#register-connectors>#</a></h2><h3 id=register-feishu-connector>Register Feishu Connector
<a class=anchor href=#register-feishu-connector>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -XPUT <span style=color:#e6db74>&#34;http://localhost:9000/connector/feishu?replace=true&#34;</span> -d <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>  &#34;name&#34;: &#34;Feishu Connector&#34;,
</span><span style=color:#e6db74>  &#34;description&#34;: &#34;Index Feishu cloud documents with OAuth 2.0 support.&#34;,
</span><span style=color:#e6db74>  &#34;icon&#34;: &#34;/assets/connector/feishu/icon.png&#34;,
</span><span style=color:#e6db74>  &#34;category&#34;: &#34;cloud_storage&#34;,
</span><span style=color:#e6db74>  &#34;tags&#34;: [&#34;feishu&#34;, &#34;docs&#34;, &#34;cloud&#34;],
</span><span style=color:#e6db74>  &#34;url&#34;: &#34;http://coco.rs/connectors/feishu&#34;,
</span><span style=color:#e6db74>  &#34;assets&#34;: {&#34;icons&#34;: {&#34;default&#34;: &#34;/assets/connector/feishu/icon.png&#34;}},
</span><span style=color:#e6db74>  &#34;config&#34;: {
</span><span style=color:#e6db74>    &#34;auth_url&#34;: &#34;https://accounts.feishu.cn/open-apis/authen/v1/authorize&#34;,
</span><span style=color:#e6db74>    &#34;token_url&#34;: &#34;https://open.feishu.cn/open-apis/authen/v2/oauth/token&#34;,
</span><span style=color:#e6db74>    &#34;redirect_url&#34;: &#34;/connector/feishu/oauth_redirect&#34;,
</span><span style=color:#e6db74>    &#34;client_id&#34;: &#34;cli_xxxxxxxxxxxxxxxx&#34;,
</span><span style=color:#e6db74>    &#34;client_secret&#34;: &#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;,
</span><span style=color:#e6db74>    &#34;document_types&#34;: [&#34;doc&#34;, &#34;sheet&#34;, &#34;slides&#34;, &#34;mindnote&#34;, &#34;bitable&#34;],
</span><span style=color:#e6db74>    &#34;user_access_token&#34;: &#34;&#34;
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h3 id=register-lark-connector>Register Lark Connector
<a class=anchor href=#register-lark-connector>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -XPUT <span style=color:#e6db74>&#34;http://localhost:9000/connector/lark?replace=true&#34;</span> -d <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>  &#34;name&#34;: &#34;Lark Connector&#34;,
</span><span style=color:#e6db74>  &#34;description&#34;: &#34;Index Lark cloud documents with OAuth 2.0 support.&#34;,
</span><span style=color:#e6db74>  &#34;icon&#34;: &#34;/assets/connector/lark/icon.png&#34;,
</span><span style=color:#e6db74>  &#34;category&#34;: &#34;cloud_storage&#34;,
</span><span style=color:#e6db74>  &#34;tags&#34;: [&#34;lark&#34;, &#34;docs&#34;, &#34;cloud&#34;],
</span><span style=color:#e6db74>  &#34;url&#34;: &#34;http://coco.rs/connectors/lark&#34;,
</span><span style=color:#e6db74>  &#34;assets&#34;: {&#34;icons&#34;: {&#34;default&#34;: &#34;/assets/connector/lark/icon.png&#34;}},
</span><span style=color:#e6db74>  &#34;config&#34;: {
</span><span style=color:#e6db74>    &#34;auth_url&#34;: &#34;https://accounts.larksuite.com/open-apis/authen/v1/authorize&#34;,
</span><span style=color:#e6db74>    &#34;token_url&#34;: &#34;https://open.larksuite.com/open-apis/authen/v2/oauth/token&#34;,
</span><span style=color:#e6db74>    &#34;redirect_url&#34;: &#34;/connector/lark/oauth_redirect&#34;,
</span><span style=color:#e6db74>    &#34;client_id&#34;: &#34;cli_xxxxxxxxxxxxxxxx&#34;,
</span><span style=color:#e6db74>    &#34;client_secret&#34;: &#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;,
</span><span style=color:#e6db74>    &#34;document_types&#34;: [&#34;doc&#34;, &#34;sheet&#34;, &#34;slides&#34;, &#34;mindnote&#34;, &#34;bitable&#34;],
</span><span style=color:#e6db74>    &#34;user_access_token&#34;: &#34;&#34;
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><blockquote><p>Use <code>feishu</code> or <code>lark</code> as the unique connector ID.</p></blockquote><h2 id=update-coco-server-config>Update coco-server config
<a class=anchor href=#update-coco-server-config>#</a></h2><h3 id=feishu-configuration>Feishu Configuration
<a class=anchor href=#feishu-configuration>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>connector</span>:
  <span style=color:#f92672>feishu</span>:
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>queue</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>indexing_documents</span>
    <span style=color:#f92672>interval</span>: <span style=color:#e6db74>&#34;30s&#34;</span>
    <span style=color:#f92672>page_size</span>: <span style=color:#ae81ff>100</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#f92672>auth_url</span>: <span style=color:#e6db74>&#34;https://accounts.feishu.cn/open-apis/authen/v1/authorize&#34;</span>
      <span style=color:#f92672>token_url</span>: <span style=color:#e6db74>&#34;https://open.feishu.cn/open-apis/authen/v2/oauth/token&#34;</span>
      <span style=color:#f92672>redirect_url</span>: <span style=color:#e6db74>&#34;/connector/feishu/oauth_redirect&#34;</span>
      <span style=color:#f92672>client_id</span>: <span style=color:#e6db74>&#34;cli_xxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>client_secret</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>document_types</span>: [<span style=color:#e6db74>&#34;doc&#34;</span>, <span style=color:#e6db74>&#34;sheet&#34;</span>, <span style=color:#e6db74>&#34;slides&#34;</span>, <span style=color:#e6db74>&#34;mindnote&#34;</span>, <span style=color:#e6db74>&#34;bitable&#34;</span>]
      <span style=color:#f92672>user_access_token</span>: <span style=color:#e6db74>&#34;&#34;</span>
</code></pre></div><h3 id=lark-configuration>Lark Configuration
<a class=anchor href=#lark-configuration>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>connector</span>:
  <span style=color:#f92672>lark</span>:
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>queue</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>indexing_documents</span>
    <span style=color:#f92672>interval</span>: <span style=color:#e6db74>&#34;30s&#34;</span>
    <span style=color:#f92672>page_size</span>: <span style=color:#ae81ff>100</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#f92672>auth_url</span>: <span style=color:#e6db74>&#34;https://accounts.larksuite.com/open-apis/authen/v1/authorize&#34;</span>
      <span style=color:#f92672>token_url</span>: <span style=color:#e6db74>&#34;https://open.larksuite.com/open-apis/authen/v2/oauth/token&#34;</span>
      <span style=color:#f92672>redirect_url</span>: <span style=color:#e6db74>&#34;/connector/lark/oauth_redirect&#34;</span>
      <span style=color:#f92672>client_id</span>: <span style=color:#e6db74>&#34;cli_xxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>client_secret</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
      <span style=color:#f92672>document_types</span>: [<span style=color:#e6db74>&#34;doc&#34;</span>, <span style=color:#e6db74>&#34;sheet&#34;</span>, <span style=color:#e6db74>&#34;slides&#34;</span>, <span style=color:#e6db74>&#34;mindnote&#34;</span>, <span style=color:#e6db74>&#34;bitable&#34;</span>]
      <span style=color:#f92672>user_access_token</span>: <span style=color:#e6db74>&#34;&#34;</span>
</code></pre></div><h2 id=create-a-datasource>Create a Datasource
<a class=anchor href=#create-a-datasource>#</a></h2><h3 id=method-1-oauth-authentication-recommended>Method 1: OAuth Authentication (Recommended)
<a class=anchor href=#method-1-oauth-authentication-recommended>#</a></h3><p>With the new architecture, datasources are automatically created during the OAuth flow. Users simply need to:</p><ol><li><strong>Configure the Connector</strong>: Set up OAuth credentials in the connector configuration</li><li><strong>Click Connect</strong>: Users click the &ldquo;Connect&rdquo; button in the datasource creation interface</li><li><strong>OAuth Authorization</strong>: Complete the OAuth authorization flow</li><li><strong>Auto-creation</strong>: System automatically creates the datasource with OAuth tokens</li></ol><p><strong>No manual datasource creation required</strong> - the system handles everything automatically!</p><h3 id=method-2-user-access-token-authentication-legacy>Method 2: User Access Token Authentication (Legacy)
<a class=anchor href=#method-2-user-access-token-authentication-legacy>#</a></h3><p>For users who prefer direct token authentication, datasources can still be created manually:</p><h4 id=feishu-datasource>Feishu Datasource
<a class=anchor href=#feishu-datasource>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -XPOST <span style=color:#e6db74>&#34;http://localhost:9000/datasource/&#34;</span> -d <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>  &#34;name&#34;: &#34;Feishu Cloud Documents&#34;,
</span><span style=color:#e6db74>  &#34;type&#34;: &#34;connector&#34;,
</span><span style=color:#e6db74>  &#34;connector&#34;: {
</span><span style=color:#e6db74>    &#34;id&#34;: &#34;feishu&#34;,
</span><span style=color:#e6db74>    &#34;config&#34;: {
</span><span style=color:#e6db74>      &#34;user_access_token&#34;: &#34;u-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;,
</span><span style=color:#e6db74>      &#34;document_types&#34;: [&#34;doc&#34;, &#34;sheet&#34;, &#34;slides&#34;, &#34;mindnote&#34;, &#34;bitable&#34;, &#34;file&#34;, &#34;docx&#34;, &#34;folder&#34;, &#34;shortcut&#34;]
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h4 id=lark-datasource>Lark Datasource
<a class=anchor href=#lark-datasource>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -XPOST <span style=color:#e6db74>&#34;http://localhost:9000/datasource/&#34;</span> -d <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>  &#34;name&#34;: &#34;Lark Cloud Documents&#34;,
</span><span style=color:#e6db74>  &#34;type&#34;: &#34;connector&#34;,
</span><span style=color:#e6db74>  &#34;connector&#34;: {
</span><span style=color:#e6db74>    &#34;id&#34;: &#34;lark&#34;,
</span><span style=color:#e6db74>    &#34;config&#34;: {
</span><span style=color:#e6db74>      &#34;user_access_token&#34;: &#34;u-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;,
</span><span style=color:#e6db74>      &#34;document_types&#34;: [&#34;doc&#34;, &#34;sheet&#34;, &#34;slides&#34;, &#34;mindnote&#34;, &#34;bitable&#34;, &#34;file&#34;, &#34;docx&#34;, &#34;folder&#34;, &#34;shortcut&#34;]
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h2 id=configuration-parameters>Configuration Parameters
<a class=anchor href=#configuration-parameters>#</a></h2><h3 id=required-parameters>Required Parameters
<a class=anchor href=#required-parameters>#</a></h3><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Authentication Method</th></tr></thead><tbody><tr><td><code>client_id</code></td><td>string</td><td>Feishu/Lark app Client ID</td><td>OAuth Authentication</td></tr><tr><td><code>client_secret</code></td><td>string</td><td>Feishu/Lark app Client Secret</td><td>OAuth Authentication</td></tr><tr><td><code>user_access_token</code></td><td>string</td><td>User access token</td><td>Token Authentication</td></tr><tr><td><code>document_types</code></td><td>[]string</td><td>List of document types to synchronize</td><td>Both methods</td></tr></tbody></table><h3 id=oauth-auto-filled-fields>OAuth Auto-filled Fields
<a class=anchor href=#oauth-auto-filled-fields>#</a></h3><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Source</th></tr></thead><tbody><tr><td><code>access_token</code></td><td>string</td><td>Access token for API calls</td><td>Automatically obtained via OAuth</td></tr><tr><td><code>refresh_token</code></td><td>string</td><td>Refresh token for token updates</td><td>Automatically obtained via OAuth</td></tr><tr><td><code>token_expiry</code></td><td>string</td><td>Access token expiration time (RFC3339 format)</td><td>Automatically obtained via OAuth</td></tr><tr><td><code>refresh_token_expiry</code></td><td>string</td><td>Refresh token expiration time (RFC3339 format)</td><td>Automatically obtained via OAuth</td></tr><tr><td><code>profile</code></td><td>object</td><td>User information (ID, name, email, etc.)</td><td>Automatically obtained via OAuth</td></tr></tbody></table><h3 id=sync-configuration>Sync Configuration
<a class=anchor href=#sync-configuration>#</a></h3><table><thead><tr><th>Field</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>page_size</code></td><td>int</td><td>100</td><td>Number of files per page</td></tr><tr><td><code>interval</code></td><td>string</td><td>&ldquo;30s&rdquo;</td><td>Synchronization interval</td></tr></tbody></table><h2 id=supported-document-types>Supported Document Types
<a class=anchor href=#supported-document-types>#</a></h2><p>The Feishu/Lark connector supports the following cloud document types:</p><ul><li><strong>doc</strong>: Feishu/Lark documents</li><li><strong>sheet</strong>: Feishu/Lark spreadsheets</li><li><strong>slides</strong>: Feishu/Lark presentations</li><li><strong>mindnote</strong>: Feishu/Lark mind notes</li><li><strong>bitable</strong>: Feishu/Lark multi-dimensional tables</li><li><strong>file</strong>: Regular files</li><li><strong>docx</strong>: Word documents</li><li><strong>folder</strong>: Folders (supports recursive search)</li><li><strong>shortcut</strong>: Shortcuts (directly use API returned URLs)</li></ul><h2 id=usage-instructions>Usage Instructions
<a class=anchor href=#usage-instructions>#</a></h2><h3 id=method-1-oauth-authentication-recommended-1>Method 1: OAuth Authentication (Recommended)
<a class=anchor href=#method-1-oauth-authentication-recommended-1>#</a></h3><h4 id=step-1-create-feishulark-app>Step 1: Create Feishu/Lark App
<a class=anchor href=#step-1-create-feishulark-app>#</a></h4><ol><li>Visit the corresponding open platform:<ul><li>Feishu:
<a href=https://open.feishu.cn/>Feishu Open Platform</a></li><li>Lark:
<a href=https://open.larksuite.com/>Lark Open Platform</a></li></ul></li><li>Create a new app, apply for the following permissions:<ul><li><strong><code>drive:drive</code></strong> - Cloud document access permission</li><li><strong><code>space:document:retrieve</code></strong> - Knowledge base document retrieval permission</li><li><strong><code>offline_access</code></strong> - Offline access permission</li></ul></li><li>Record the app&rsquo;s <code>Client ID</code> and <code>Client Secret</code></li></ol><h4 id=step-2-configure-connector>Step 2: Configure Connector
<a class=anchor href=#step-2-configure-connector>#</a></h4><ol><li>Go to Connector Management in the system interface</li><li>Edit the Feishu or Lark connector configuration</li><li>Configure the following fields:<ul><li><code>client_id</code>: Your app&rsquo;s Client ID</li><li><code>client_secret</code>: Your app&rsquo;s Client Secret</li><li><code>document_types</code>: List of document types to sync</li><li><code>auth_url</code>, <code>token_url</code>, <code>redirect_url</code>: OAuth endpoints (pre-configured)</li></ul></li><li>Save connector configuration</li></ol><h4 id=step-3-create-datasource-oauth-flow>Step 3: Create Datasource (OAuth Flow)
<a class=anchor href=#step-3-create-datasource-oauth-flow>#</a></h4><ol><li>Go to Data Source Management and click &ldquo;Add Data Source&rdquo;</li><li>Select Feishu or Lark connector</li><li>Click the &ldquo;Connect&rdquo; button (no manual configuration needed)</li><li>System redirects to Feishu/Lark authorization page</li><li>User completes authorization</li><li>System automatically creates datasource with OAuth tokens and user profile information</li></ol><h3 id=method-2-user-access-token>Method 2: User Access Token
<a class=anchor href=#method-2-user-access-token>#</a></h3><h4 id=step-1-obtain-user-access-token>Step 1: Obtain User Access Token
<a class=anchor href=#step-1-obtain-user-access-token>#</a></h4><ol><li>Log in to corresponding open platform</li><li>Obtain user access token</li></ol><h4 id=step-2-create-datasource>Step 2: Create Datasource
<a class=anchor href=#step-2-create-datasource>#</a></h4><ol><li>Create corresponding datasource in system management interface</li><li>Configure <code>user_access_token</code> and <code>document_types</code></li><li>Save datasource configuration</li></ol><h2 id=technical-implementation>Technical Implementation
<a class=anchor href=#technical-implementation>#</a></h2><h3 id=architecture-design>Architecture Design
<a class=anchor href=#architecture-design>#</a></h3><h4 id=refactored-architecture>Refactored Architecture
<a class=anchor href=#refactored-architecture>#</a></h4><ul><li><strong>Plugin Type Abstraction</strong>: Uses <code>PluginType</code> enum to distinguish between Feishu and Lark</li><li><strong>Dynamic API Configuration</strong>: Dynamically selects API endpoints based on plugin type</li><li><strong>Enhanced Base Plugin</strong>: Adds plugin type management and API configuration functionality to base plugin</li><li><strong>Maximum Code Reuse</strong>: 95% of code is shared, only configuration and routes differ</li><li><strong>OAuth Configuration Centralization</strong>: OAuth credentials are managed at connector level</li><li><strong>Automatic Datasource Creation</strong>: Datasources are automatically created during OAuth flow</li><li><strong>Unified OAuth Config Structure</strong>: All OAuth-related fields are merged into a single <code>OAuthConfig</code> struct</li></ul><h4 id=core-components>Core Components
<a class=anchor href=#core-components>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Plugin type definition
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PluginType</span> <span style=color:#66d9ef>string</span>
<span style=color:#66d9ef>const</span> (
    <span style=color:#a6e22e>PluginTypeFeishu</span> <span style=color:#a6e22e>PluginType</span> = <span style=color:#e6db74>&#34;feishu&#34;</span>
    <span style=color:#a6e22e>PluginTypeLark</span>   <span style=color:#a6e22e>PluginType</span> = <span style=color:#e6db74>&#34;lark&#34;</span>
)

<span style=color:#75715e>// Unified OAuth configuration structure
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>OAuthConfig</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#75715e>// OAuth endpoints
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>AuthURL</span>     <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>TokenURL</span>    <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>RedirectURL</span> <span style=color:#66d9ef>string</span>
    
    <span style=color:#75715e>// OAuth credentials
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>ClientID</span>         <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>ClientSecret</span>     <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>DocumentTypes</span>    []<span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>UserAccessToken</span>  <span style=color:#66d9ef>string</span>
}

<span style=color:#75715e>// API configuration structure
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>APIConfig</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>BaseURL</span>     <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>AuthURL</span>     <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>TokenURL</span>    <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>UserInfoURL</span> <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>DriveURL</span>    <span style=color:#66d9ef>string</span>
}

<span style=color:#75715e>// Base plugin structure
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Plugin</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#75715e>// ... existing fields
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>PluginType</span>  <span style=color:#a6e22e>PluginType</span>
    <span style=color:#a6e22e>apiConfig</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>APIConfig</span>
    <span style=color:#a6e22e>OAuthConfig</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>OAuthConfig</span>  <span style=color:#75715e>// Unified OAuth configuration
</span><span style=color:#75715e></span>}
</code></pre></div><h4 id=plugin-implementation>Plugin Implementation
<a class=anchor href=#plugin-implementation>#</a></h4><ul><li><strong>FeishuPlugin</strong>: Inherits base plugin, sets <code>PluginTypeFeishu</code></li><li><strong>LarkPlugin</strong>: Inherits base plugin, sets <code>PluginTypeLark</code></li><li><strong>Unified API Processing</strong>: All API calls use dynamically configured endpoints</li></ul><h3 id=oauth-route-registration>OAuth Route Registration
<a class=anchor href=#oauth-route-registration>#</a></h3><h4 id=feishu-routes>Feishu Routes
<a class=anchor href=#feishu-routes>#</a></h4><ul><li><strong>Route Endpoints</strong>:<ul><li><code>GET /connector/feishu/connect</code> - OAuth authorization request</li><li><code>GET /connector/feishu/oauth_redirect</code> - OAuth callback processing</li></ul></li></ul><h4 id=lark-routes>Lark Routes
<a class=anchor href=#lark-routes>#</a></h4><ul><li><p><strong>Route Endpoints</strong>:</p><ul><li><code>GET /connector/lark/connect</code> - OAuth authorization request</li><li><code>GET /connector/lark/oauth_redirect</code> - OAuth callback processing</li></ul></li><li><p><strong>Authentication Requirements</strong>: All OAuth endpoints require user login</p></li><li><p><strong>Scope Configuration</strong>: Uses <code>drive:drive space:document:retrieve offline_access</code> permission scope</p></li></ul><h3 id=token-lifecycle-management>Token Lifecycle Management
<a class=anchor href=#token-lifecycle-management>#</a></h3><ul><li><strong>Auto-refresh</strong>: Automatically refreshes access_token when expired using refresh_token</li><li><strong>Expiration Checking</strong>: Checks expiration times for both access_token and refresh_token</li><li><strong>Smart Handling</strong>: Stops synchronization and logs errors if both tokens are expired</li><li><strong>Data Persistence</strong>: Automatically saves refreshed token information to datasource configuration</li></ul><h3 id=special-type-processing>Special Type Processing
<a class=anchor href=#special-type-processing>#</a></h3><h4 id=recursive-folder-search>Recursive Folder Search
<a class=anchor href=#recursive-folder-search>#</a></h4><p>The connector automatically searches folder contents recursively, ensuring all documents in subfolders are indexed.</p><h2 id=important-notes>Important Notes
<a class=anchor href=#important-notes>#</a></h2><ol><li><strong>Authentication Method Selection</strong>: You must choose either OAuth authentication or user access token authentication, they cannot be used simultaneously</li><li><strong>OAuth Recommended</strong>: OAuth authentication is recommended for higher security, automatic token refresh, and expiration time management</li><li><strong>Connector-Level Configuration</strong>: OAuth credentials are now configured at the connector level, not at the datasource level</li><li><strong>Automatic Datasource Creation</strong>: When using OAuth, datasources are automatically created during the authorization flow</li><li><strong>Token Management</strong>: When using user access tokens, manual token expiration management is required</li><li><strong>Permission Requirements</strong>: Feishu/Lark apps need to apply for and obtain the following permissions:<ul><li><code>drive:drive</code> - Cloud document access permission</li><li><code>space:document:retrieve</code> - Knowledge base retrieval permission</li><li><code>offline_access</code> - Offline access permission</li></ul></li><li><strong>API Limits</strong>: Pay attention to Feishu/Lark API call frequency limits</li><li><strong>Platform Selection</strong>: Choose the appropriate platform based on user region (Feishu for Mainland China, Lark for overseas regions)</li></ol><h2 id=troubleshooting>Troubleshooting
<a class=anchor href=#troubleshooting>#</a></h2><h3 id=common-issues>Common Issues
<a class=anchor href=#common-issues>#</a></h3><ol><li><p><strong>Authentication Failure</strong></p><ul><li>Check if <code>client_id</code> and <code>client_secret</code> are correct</li><li>Confirm if Feishu/Lark app has applied for and obtained the following permissions:<ul><li><code>drive:drive</code> - Cloud document access permission</li><li><code>space:document:retrieve</code> - Knowledge base retrieval permission</li><li><code>offline_access</code> - Offline access permission</li></ul></li><li>Check OAuth redirect URI configuration</li><li>Confirm if application has been published to enterprise</li></ul></li><li><p><strong>Token Expiration</strong></p><ul><li>OAuth Authentication: System automatically refreshes tokens, check if refresh_token is also expired</li><li>User Access Token: Manual token updates required</li></ul></li><li><p><strong>Sync Failure</strong></p><ul><li>Check network connectivity</li><li>Confirm if token is valid</li><li>View system logs for detailed error information</li><li>Check expiration times for both tokens</li></ul></li><li><p><strong>OAuth Redirect Errors</strong></p><ul><li>Confirm redirect URI in application configuration</li><li>Check if network environment supports dynamic URI construction</li><li>View redirect URI construction process in system logs</li></ul></li><li><p><strong>Platform Selection Error</strong></p><ul><li>Confirm user region</li><li>Check if application domain configuration is correct</li><li>Verify if API endpoints are accessible</li></ul></li></ol><h3 id=log-debugging>Log Debugging
<a class=anchor href=#log-debugging>#</a></h3><p>The connector provides detailed logging, including:</p><ul><li>Each step of the OAuth flow</li><li>Token refresh process</li><li>Expiration time checking</li><li>Error details and stack information</li><li>Plugin type identification (<code>[feishu connector]</code> or <code>[lark connector]</code>)</li></ul><p>Use logs to quickly locate and resolve issues.</p><h2 id=extensibility>Extensibility
<a class=anchor href=#extensibility>#</a></h2><p>The refactored architecture supports easy addition of new plugin types:</p><ol><li><p><strong>Define New Plugin Type</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PluginTypeLarkInternational</span> <span style=color:#a6e22e>PluginType</span> = <span style=color:#e6db74>&#34;lark_international&#34;</span>
</code></pre></div></li><li><p><strong>Add API Configuration</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>PluginTypeLarkInternational</span>:
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>APIConfig</span>{
        <span style=color:#a6e22e>BaseURL</span>: <span style=color:#e6db74>&#34;https://open.larksuite.com&#34;</span>,
        <span style=color:#75715e>// ... other configurations
</span><span style=color:#75715e></span>    }
</code></pre></div></li><li><p><strong>Create New Plugin</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LarkInternationalPlugin</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>Plugin</span>
}
   
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>this</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LarkInternationalPlugin</span>) <span style=color:#a6e22e>Setup</span>() {
    <span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>SetPluginType</span>(<span style=color:#a6e22e>PluginTypeLarkInternational</span>)
    <span style=color:#75715e>// other configurations handled automatically
</span><span style=color:#75715e></span>}
</code></pre></div></li></ol><p>This design provides a solid foundation for future feature extensions and maintenance.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/infinilabs/coco-server/edit/main/docs/content.en/docs/references/connectors/feishu.md target=_blank rel=noopener><img src=/coco-server/main/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div><div class="flex align-center footer">¬©INFINI.LTD, All Rights Reserved.</div><script async src="https://www.googletagmanager.com/gtag/js?id=G-RJPTVP614C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-RJPTVP614C');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div><script type=module>
    import { searchbox } from "https://coco.infini.cloud/integration/cvn0g9ehpcehvsthrakg/widget";
    searchbox({container: "#searchbox"});
</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#feishulark-connector>Feishu/Lark Connector</a><ul><li><a href=#features>Features</a></li><li><a href=#supported-platforms>Supported Platforms</a><ul><li><a href=#feishu>Feishu</a></li><li><a href=#lark>Lark</a></li></ul></li><li><a href=#authentication-methods>Authentication Methods</a><ul><li><a href=#1-oauth-20-authentication-recommended>1. OAuth 2.0 Authentication (Recommended)</a></li><li><a href=#2-user-access-token-authentication-alternative>2. User Access Token Authentication (Alternative)</a></li></ul></li><li><a href=#feishulark-app-permission-configuration>Feishu/Lark App Permission Configuration</a><ul><li><a href=#required-permissions>Required Permissions</a></li><li><a href=#permission-application-steps>Permission Application Steps</a></li><li><a href=#permission-description>Permission Description</a></li></ul></li><li><a href=#configuration-architecture>Configuration Architecture</a><ul><li><a href=#connector-level-oauth-configuration>Connector Level (OAuth Configuration)</a></li><li><a href=#datasource-level-auto-generated>Datasource Level (Auto-generated)</a></li></ul></li><li><a href=#register-connectors>Register Connectors</a><ul><li><a href=#register-feishu-connector>Register Feishu Connector</a></li><li><a href=#register-lark-connector>Register Lark Connector</a></li></ul></li><li><a href=#update-coco-server-config>Update coco-server config</a><ul><li><a href=#feishu-configuration>Feishu Configuration</a></li><li><a href=#lark-configuration>Lark Configuration</a></li></ul></li><li><a href=#create-a-datasource>Create a Datasource</a><ul><li><a href=#method-1-oauth-authentication-recommended>Method 1: OAuth Authentication (Recommended)</a></li><li><a href=#method-2-user-access-token-authentication-legacy>Method 2: User Access Token Authentication (Legacy)</a></li></ul></li><li><a href=#configuration-parameters>Configuration Parameters</a><ul><li><a href=#required-parameters>Required Parameters</a></li><li><a href=#oauth-auto-filled-fields>OAuth Auto-filled Fields</a></li><li><a href=#sync-configuration>Sync Configuration</a></li></ul></li><li><a href=#supported-document-types>Supported Document Types</a></li><li><a href=#usage-instructions>Usage Instructions</a><ul><li><a href=#method-1-oauth-authentication-recommended-1>Method 1: OAuth Authentication (Recommended)</a></li><li><a href=#method-2-user-access-token>Method 2: User Access Token</a></li></ul></li><li><a href=#technical-implementation>Technical Implementation</a><ul><li><a href=#architecture-design>Architecture Design</a></li><li><a href=#oauth-route-registration>OAuth Route Registration</a></li><li><a href=#token-lifecycle-management>Token Lifecycle Management</a></li><li><a href=#special-type-processing>Special Type Processing</a></li></ul></li><li><a href=#important-notes>Important Notes</a></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#common-issues>Common Issues</a></li><li><a href=#log-debugging>Log Debugging</a></li></ul></li><li><a href=#extensibility>Extensibility</a></li></ul></li></ul></nav></aside></main></body></html>