<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How an Insurance Group Improved the Indexing Speed by 200x Times #  Challenges #  A large insurance group places common database fields in Elasticsearch to improve the query performance for its policy query service. The cluster is deployed on 14 physical machines, with 4 Elasticsearch instances deployed on each physical machine. The whole cluster has more than 9 billion pieces of data. The storage size of index primary shards is close to 5 TB, and about 600 million pieces of incremental data are updated every day."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="How an Insurance Group Improved the Indexing Speed by 200x Times"><meta property="og:description" content="How an Insurance Group Improved the Indexing Speed by 200x Times #  Challenges #  A large insurance group places common database fields in Elasticsearch to improve the query performance for its policy query service. The cluster is deployed on 14 physical machines, with 4 Elasticsearch instances deployed on each physical machine. The whole cluster has more than 9 billion pieces of data. The storage size of index primary shards is close to 5 TB, and about 600 million pieces of incremental data are updated every day."><meta property="og:type" content="article"><meta property="og:url" content="/gateway/v1.29.7/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/"><title>How an Insurance Group Improved the Indexing Speed by 200x Times | INFINI Gateway</title><link rel=manifest href=/gateway/v1.29.7/manifest.json><link rel=icon href=/gateway/v1.29.7/favicon.png type=image/x-icon><link rel=alternate hreflang=zh href=/gateway/v1.29.7/zh/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/ title=某保险业务索引速度百倍提升><link rel=stylesheet href=/gateway/v1.29.7/book.min.d80e87b12a4b49d9913d0bdd98bd83b7a44988be784760ba15522b377313dcf9.css integrity="sha256-2A6HsSpLSdmRPQvdmL2Dt6RJiL54R2C6FVIrN3MT3Pk="><script defer src=/gateway/v1.29.7/js/jquery-2.x.min.js></script><script defer src=/gateway/v1.29.7/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/gateway/v1.29.7><img src=/gateway/v1.29.7/img/logo-en.svg alt=Logo></a></h2><div id=searchbox style=margin-bottom:10px;outline:none></div><div class=heading><select class=version-selector>
<option value>main (latest)</option>
<option value=v1.29.7>v1.29.7</option>
<option value=v1.29.6>v1.29.6</option>
<option value=v1.29.4>v1.29.4</option>
<option value=v1.29.3>v1.29.3</option>
<option value=v1.29.2>v1.29.2</option>
<option value=v1.29.1>v1.29.1</option>
<option value=v1.29.0>v1.29.0</option>
<option value=v1.28.2>v1.28.2</option>
<option value=v1.28.0>v1.28.0</option>
<option value=v1.27.0>v1.27.0</option>
<option value=v1.26.1>v1.26.1</option></select></div><ul><li><a href=/gateway/v1.29.7/docs/overview/>Overview</a><ul></ul></li><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>Getting Started</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/getting-started/install/>Installing the Gateway</a></li><li><a href=/gateway/v1.29.7/docs/getting-started/configuration/>Configuring the Gateway</a></li><li><a href=/gateway/v1.29.7/docs/getting-started/docker/>Container Deployment</a></li><li><a href=/gateway/v1.29.7/docs/getting-started/helm/>Kubernetes Deployment</a></li><li><a href=/gateway/v1.29.7/docs/getting-started/optimization/>System Optimization</a></li><li><a href=/gateway/v1.29.7/docs/getting-started/benchmark/>Benchmark Testing</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a>References</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/references/entry/>Service Entry</a></li><li><a href=/gateway/v1.29.7/docs/references/router/>Service Router</a></li><li><a href=/gateway/v1.29.7/docs/references/flow/>Handling Flow</a></li><li><a href=/gateway/v1.29.7/docs/references/elasticsearch/>Elasticsearch</a></li><li><a href=/gateway/v1.29.7/docs/references/context/>Request Context</a></li><li><input type=checkbox id=section-a53d1bd91095fa28aef70cee327a5121 class=toggle>
<label for=section-a53d1bd91095fa28aef70cee327a5121 class="flex justify-between"><a href=/gateway/v1.29.7/docs/references/filters/>Online Filter</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/references/filters/echo/>echo</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/auto_generate_doc_id/>auto_generate_doc_id</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/basic_auth/>basic_auth</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/bulk_request_mutate/>bulk_request_mutate</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/bulk_request_throttle/>bulk_request_throttle</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/bulk_reshuffle/>bulk_reshuffle</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/bulk_response_process/>bulk_response_process</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/cache/>cache</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/clone/>clone</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/context_filter/>context_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/context_limiter/>context_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/context_parse/>context_parse</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/context_regex_replace/>context_regex_replace</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/context_switch/>context_switch</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/date_range_precision_tuning/>date_range_precision_tuning</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/drop/>drop</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/dump/>dump</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/elasticsearch/>elasticsearch</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/elasticsearch_health_check/>elasticsearch_health_check</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/flow/>flow</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/hash_mod/>hash_mod</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/http/>http</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/javascript/>javascript</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/ldap_auth/>ldap_auth</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/logging/>logging</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/queue/>queue</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/ratio/>ratio</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/record/>record</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/redirect/>redirect</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/redis_pubsub/>redis_pubsub</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_api_key_filter/>request_api_key_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_api_key_limiter/>request_api_key_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_body_json_del/>request_body_json_del</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_body_json_set/>request_body_json_set</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_body_regex_replace/>request_body_regex_replace</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_client_ip_filter/>request_client_ip_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_client_ip_limiter/>request_client_ip_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_header_filter/>request_header_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_host_filter/>request_host_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_host_limiter/>request_host_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_method_filter/>request_method_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_path_filter/>request_path_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_path_limiter/>request_path_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_reshuffle/>request_reshuffle</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_user_filter/>request_user_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/request_user_limiter/>request_user_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/response_body_regex_replace/>response_body_regex_replace</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/response_header_filter/>response_header_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/response_header_format/>response_header_format</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/response_status_filter/>response_status_filter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/retry_limiter/>retry_limiter</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/rewrite_to_bulk/>rewrite_to_bulk</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/sample/>sample</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_basic_auth/>set_basic_auth</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_context/>set_context</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_hostname/>set_hostname</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_request_header/>set_request_header</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_request_query_args/>set_request_query_args</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_response/>set_response</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/set_response_header/>set_response_header</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/sleep/>sleep</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/switch/>switch</a></li><li><a href=/gateway/v1.29.7/docs/references/filters/translog/>translog</a></li></ul></li><li><input type=checkbox id=section-82db29a871579194764c352cfff582f2 class=toggle>
<label for=section-82db29a871579194764c352cfff582f2 class="flex justify-between"><a href=/gateway/v1.29.7/docs/references/processors/>Offline Processor</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/references/processors/bulk_indexing/>bulk_indexing</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/consumer/>consumer</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/dag/>dag</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/dump_hash/>dump_hash</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/flow_replay/>flow_replay</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/flow_runner/>flow_runner</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/index_diff/>index_diff</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/indexing_merge/>indexing_merge</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/json_indexing/>json_indexing</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/merge_to_bulk/>merge_to_bulk</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/queue_consumer/>queue_consumer</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/replay/>replay</a></li><li><a href=/gateway/v1.29.7/docs/references/processors/smtp/>smtp</a></li></ul></li><li><input type=checkbox id=section-3de6688eceb9f20db2f0270adccf76e2 class=toggle>
<label for=section-3de6688eceb9f20db2f0270adccf76e2 class="flex justify-between"><a>Functional Component</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/references/modules/floating_ip/>Floating IP</a></li><li><a href=/gateway/v1.29.7/docs/references/modules/force_merge/>Index Segment Merging</a></li></ul></li><li><a href=/gateway/v1.29.7/docs/references/config/>Other Configurations</a></li></ul></li><li><input type=checkbox id=section-391bcaab6cc03bd87e3373752bfd390e class=toggle>
<label for=section-391bcaab6cc03bd87e3373752bfd390e class="flex justify-between"><a>Tutorials</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/tutorial/log4j2_filtering/>Protect Elasticsearch from Apache Log4j Vulnerability</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/online_query_rewrite/>Rewrite Your Elasticsearch Requests OnTheFly</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/request-logging/>Elasticsearch Search Requests Analysis/Audit</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/index_diff/>Document-Level Index Diff Between Two Elasticsearch Clusters</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/proxy_kibana/>Adding a TLS and Basic Security for Kibana</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/proxy_elasticsearch/>Enable HTTPS/TLS + Basic Auth for Elasticsearch easily</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/fix_count_in_search_response/>Handle Count Structure of Different Elasticsearch Versions</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/es-hadoop_integration/>Integrate with Elasticsearch-Hadoop</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/prometheus_integration/>Integration with Prometheus</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/routing_to_cluser_by_index/>Unified access indexes from different clusters in Kibana</a></li><li><a href=/gateway/v1.29.7/docs/tutorial/path_rewrite_by_javascript/>Use JavaScript for complex query rewriting</a></li></ul></li><li><input type=checkbox id=section-7e4e95606453deb85437b78d9c3f2d72 class=toggle checked>
<label for=section-7e4e95606453deb85437b78d9c3f2d72 class="flex justify-between"><a href=/gateway/v1.29.7/docs/user-cases/>User Cases</a>
<span>▾</span></label><ul><li><a href=/gateway/v1.29.7/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/ class=active>How an Insurance Group Improved the Indexing Speed by 200x Times</a></li><li><a href=/gateway/v1.29.7/docs/user-cases/stories/a_cross_region_cluster_access_locality/>Nearest Cluster Access Across Two Cloud Providers</a></li></ul></li><li><a href=/gateway/v1.29.7/docs/troubleshooting/>FAQs</a><ul></ul></li><li><a href=/gateway/v1.29.7/docs/release-notes/>Release Notes</a><ul></ul></li></ul><ul><li><a href=https://github.com/infinilabs/gateway target=_blank rel=noopener>Github</a></li></ul><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/gateway/v1.29.7/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li class=active><a href=/gateway/v1.29.7/ class="flex align-center"><img src=/gateway/v1.29.7/svg/translate.svg class=book-icon alt=Languages>
English</a></li><li><a href=/gateway/v1.29.7/zh/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/ class="flex align-center"><img src=/gateway/v1.29.7/svg/translate.svg class=book-icon alt=Languages>
简体中文</a></li></ul></div></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/gateway/v1.29.7/svg/menu.svg class=book-icon alt=Menu></label>
<strong>How an Insurance Group Improved the Indexing Speed by 200x Times</strong>
<label for=toc-control><img src=/gateway/v1.29.7/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#how-an-insurance-group-improved-the-indexing-speed-by-200x-times>How an Insurance Group Improved the Indexing Speed by 200x Times</a><ul><li><a href=#challenges>Challenges</a></li><li><a href=#scenario>Scenario</a></li><li><a href=#user-benefits>User Benefits</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=how-an-insurance-group-improved-the-indexing-speed-by-200x-times>How an Insurance Group Improved the Indexing Speed by 200x Times
<a class=anchor href=#how-an-insurance-group-improved-the-indexing-speed-by-200x-times>#</a></h1><h2 id=challenges>Challenges
<a class=anchor href=#challenges>#</a></h2><p>A large insurance group places common database fields in Elasticsearch to improve the query performance for its policy query service.
The cluster is deployed on 14 physical machines, with 4 Elasticsearch instances deployed on each physical machine. The whole cluster has more than 9 billion pieces of data.
The storage size of index primary shards is close to 5 TB, and about 600 million pieces of incremental data are updated every day. Due to the service particularity, all the service data across the country is stored in one index, resulting in up to 210 shards in the single index. The bulk rebuilding task is executed in parallel by Spark. The average write speed is about 2,000–3,000 pieces per second. One incremental rebuilding operation may take 2–3 days.
Service data updating causes a large delay and the lengthy rebuilding also affects service access during normal time periods. The technical team had tried hard to optimize Elasticsearch and also the Spark write end for several rounds, but did not get any progress in the indexing speed improvement.</p><h2 id=scenario>Scenario
<a class=anchor href=#scenario>#</a></h2><p>The analysis shows that the cluster performance is good. However, after write requests in a single batch are received by Elasticsearch, they need to be encapsulated and forwarded according to the node where the primary shard is located.
There are too many service index shards and each data node eventually gets a very small number of request documents. One bulk write request of the client is divided into hundreds of small bulk requests. According to the short board theory of the barrel, the processing speed of the slowest node slows down the whole bulk write operation. INFINI Gateway knows where a document should go to.</p><p>INFINI Gateway is capable of splitting and merging requests in advance. It splits and merges requests in advance, sends the requests to local queues based on the target node, and then writes the requests to the target Elasticsearch cluster through the queue consumption program to convert random bulk requests into sequential requests that are precisely delivered. See the figure below.</p><p><img src=/gateway/v1.29.7/img/bulk_reshuffle.jpg alt></p><p>After receiving a request from Spark, INFINI Gateway first stores the request on the local disk to prevent data loss. Meanwhile, INFINI Gateway can locally calculate the routing information of each document and the target data nodes. The new data writing architecture is shown in the figure below.</p><p><img src=/gateway/v1.29.7/img/spark-write-to-gateway.jpg alt></p><p>After INFINI Gateway is used to receive write requests from Spark, the write throughput of the entire cluster is significantly improved. Spark accomplishes the data writing task in less than 15 minutes, and it takes only 20 minutes for the gateway to receive requests and write them into Elasticsearch.
The CPU resources of the server are fully utilized and all the CPU resources of each node are used.</p><h2 id=user-benefits>User Benefits
<a class=anchor href=#user-benefits>#</a></h2><blockquote><p>The Indexing Speed Is Improved by 20,000%</p></blockquote><p>After INFINI Gateway is used as the intermediate acceleration layer, the index rebuilding cycle of the group&rsquo;s policy service is reduced from 2–3 days to about 20 minutes, the 600 million pieces of daily incremental data can also be rebuilt very quickly, and the peak index write QPS can exceed 300,000.
In a word, INFINI Gateway greatly shortens the index rebuilding cycle, reduces data latency, enhances the consistency of online data, and ensures the normal use of the query service.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/gateway/v1.29.7/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li class=active><a href=/gateway/v1.29.7/ class="flex align-center"><img src=/gateway/v1.29.7/svg/translate.svg class=book-icon alt=Languages>
English</a></li><li><a href=/gateway/v1.29.7/zh/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/ class="flex align-center"><img src=/gateway/v1.29.7/svg/translate.svg class=book-icon alt=Languages>
简体中文</a></li></ul></div><div><a class="flex align-center" href=https://github.com/infinilabs/gateway/edit/v1.29.7/docs/content.en/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild.md target=_blank rel=noopener><img src=/gateway/v1.29.7/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script async src="https://www.googletagmanager.com/gtag/js?id=G-RJPTVP614C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-RJPTVP614C');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div><script type=module>
    import { searchbox } from "https://coco.infini.cloud/integration/cvn0g9ehpcehvsthrakg/widget";
    searchbox({container: "#searchbox"});
</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#how-an-insurance-group-improved-the-indexing-speed-by-200x-times>How an Insurance Group Improved the Indexing Speed by 200x Times</a><ul><li><a href=#challenges>Challenges</a></li><li><a href=#scenario>Scenario</a></li><li><a href=#user-benefits>User Benefits</a></li></ul></li></ul></nav></aside></main></body></html>