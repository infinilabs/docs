<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Rewrite Your Elasticsearch Requests OnTheFly #  In some cases, you may find that the QueryDSL generated by the service code is unreasonable. The general practice is to modify the service code and publish it online. If the launch of a new version takes a long time (for example, the put-into-production window is not reached, major network operation closure is in progress, or additional code needs to be submitted to go live), a large number of tests need to be performed."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Rewrite Your Elasticsearch Requests OnTheFly"><meta property="og:description" content="Rewrite Your Elasticsearch Requests OnTheFly #  In some cases, you may find that the QueryDSL generated by the service code is unreasonable. The general practice is to modify the service code and publish it online. If the launch of a new version takes a long time (for example, the put-into-production window is not reached, major network operation closure is in progress, or additional code needs to be submitted to go live), a large number of tests need to be performed."><meta property="og:type" content="article"><meta property="og:url" content="/gateway/main/docs/tutorial/online_query_rewrite/"><title>Rewrite Your Elasticsearch Requests OnTheFly | INFINI Gateway</title><link rel=manifest href=/gateway/main/manifest.json><link rel=icon href=/gateway/main/favicon.png type=image/x-icon><link rel=stylesheet href=/gateway/main/book.min.d80e87b12a4b49d9913d0bdd98bd83b7a44988be784760ba15522b377313dcf9.css integrity="sha256-2A6HsSpLSdmRPQvdmL2Dt6RJiL54R2C6FVIrN3MT3Pk="><script defer src=/gateway/main/js/jquery-2.x.min.js></script><script defer src=/gateway/main/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/gateway/main><img src=/gateway/main/img/logo-en.svg alt=Logo></a></h2><div class=heading><select class=version-selector>
<option value>main (latest)</option>
<option value=v1.28.0>v1.28.x</option>
<option value=v1.27.0>v1.27.x</option>
<option value=v1.26.1>v1.26.x</option></select></div><ul><li><a href=/gateway/main/docs/overview/>Overview</a><ul></ul></li><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>Getting Started</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/getting-started/install/>Installing the Gateway</a></li><li><a href=/gateway/main/docs/getting-started/configuration/>Configuring the Gateway</a></li><li><a href=/gateway/main/docs/getting-started/docker/>Container Deployment</a></li><li><a href=/gateway/main/docs/getting-started/helm/>Kubernetes Deployment</a></li><li><a href=/gateway/main/docs/getting-started/optimization/>System Optimization</a></li><li><a href=/gateway/main/docs/getting-started/benchmark/>Benchmark Testing</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a>References</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/references/entry/>Service Entry</a></li><li><a href=/gateway/main/docs/references/router/>Service Router</a></li><li><a href=/gateway/main/docs/references/flow/>Handling Flow</a></li><li><a href=/gateway/main/docs/references/elasticsearch/>Elasticsearch</a></li><li><a href=/gateway/main/docs/references/context/>Request Context</a></li><li><input type=checkbox id=section-a53d1bd91095fa28aef70cee327a5121 class=toggle>
<label for=section-a53d1bd91095fa28aef70cee327a5121 class="flex justify-between"><a href=/gateway/main/docs/references/filters/>Online Filter</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/references/filters/echo/>echo</a></li><li><a href=/gateway/main/docs/references/filters/auto_generate_doc_id/>auto_generate_doc_id</a></li><li><a href=/gateway/main/docs/references/filters/basic_auth/>basic_auth</a></li><li><a href=/gateway/main/docs/references/filters/bulk_request_mutate/>bulk_request_mutate</a></li><li><a href=/gateway/main/docs/references/filters/bulk_request_throttle/>bulk_request_throttle</a></li><li><a href=/gateway/main/docs/references/filters/bulk_reshuffle/>bulk_reshuffle</a></li><li><a href=/gateway/main/docs/references/filters/bulk_response_process/>bulk_response_process</a></li><li><a href=/gateway/main/docs/references/filters/cache/>cache</a></li><li><a href=/gateway/main/docs/references/filters/clone/>clone</a></li><li><a href=/gateway/main/docs/references/filters/context_filter/>context_filter</a></li><li><a href=/gateway/main/docs/references/filters/context_limiter/>context_limiter</a></li><li><a href=/gateway/main/docs/references/filters/context_parse/>context_parse</a></li><li><a href=/gateway/main/docs/references/filters/context_regex_replace/>context_regex_replace</a></li><li><a href=/gateway/main/docs/references/filters/context_switch/>context_switch</a></li><li><a href=/gateway/main/docs/references/filters/date_range_precision_tuning/>date_range_precision_tuning</a></li><li><a href=/gateway/main/docs/references/filters/drop/>drop</a></li><li><a href=/gateway/main/docs/references/filters/dump/>dump</a></li><li><a href=/gateway/main/docs/references/filters/elasticsearch/>elasticsearch</a></li><li><a href=/gateway/main/docs/references/filters/elasticsearch_health_check/>elasticsearch_health_check</a></li><li><a href=/gateway/main/docs/references/filters/flow/>flow</a></li><li><a href=/gateway/main/docs/references/filters/hash_mod/>hash_mod</a></li><li><a href=/gateway/main/docs/references/filters/http/>http</a></li><li><a href=/gateway/main/docs/references/filters/javascript/>javascript</a></li><li><a href=/gateway/main/docs/references/filters/ldap_auth/>ldap_auth</a></li><li><a href=/gateway/main/docs/references/filters/logging/>logging</a></li><li><a href=/gateway/main/docs/references/filters/queue/>queue</a></li><li><a href=/gateway/main/docs/references/filters/ratio/>ratio</a></li><li><a href=/gateway/main/docs/references/filters/record/>record</a></li><li><a href=/gateway/main/docs/references/filters/redirect/>redirect</a></li><li><a href=/gateway/main/docs/references/filters/redis_pubsub/>redis_pubsub</a></li><li><a href=/gateway/main/docs/references/filters/request_api_key_filter/>request_api_key_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_api_key_limiter/>request_api_key_limiter</a></li><li><a href=/gateway/main/docs/references/filters/request_body_json_del/>request_body_json_del</a></li><li><a href=/gateway/main/docs/references/filters/request_body_json_set/>request_body_json_set</a></li><li><a href=/gateway/main/docs/references/filters/request_body_regex_replace/>request_body_regex_replace</a></li><li><a href=/gateway/main/docs/references/filters/request_client_ip_filter/>request_client_ip_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_client_ip_limiter/>request_client_ip_limiter</a></li><li><a href=/gateway/main/docs/references/filters/request_header_filter/>request_header_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_host_filter/>request_host_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_host_limiter/>request_host_limiter</a></li><li><a href=/gateway/main/docs/references/filters/request_method_filter/>request_method_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_path_filter/>request_path_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_path_limiter/>request_path_limiter</a></li><li><a href=/gateway/main/docs/references/filters/request_reshuffle/>request_reshuffle</a></li><li><a href=/gateway/main/docs/references/filters/request_user_filter/>request_user_filter</a></li><li><a href=/gateway/main/docs/references/filters/request_user_limiter/>request_user_limiter</a></li><li><a href=/gateway/main/docs/references/filters/response_body_regex_replace/>response_body_regex_replace</a></li><li><a href=/gateway/main/docs/references/filters/response_header_filter/>response_header_filter</a></li><li><a href=/gateway/main/docs/references/filters/response_header_format/>response_header_format</a></li><li><a href=/gateway/main/docs/references/filters/response_status_filter/>response_status_filter</a></li><li><a href=/gateway/main/docs/references/filters/retry_limiter/>retry_limiter</a></li><li><a href=/gateway/main/docs/references/filters/rewrite_to_bulk/>rewrite_to_bulk</a></li><li><a href=/gateway/main/docs/references/filters/sample/>sample</a></li><li><a href=/gateway/main/docs/references/filters/set_basic_auth/>set_basic_auth</a></li><li><a href=/gateway/main/docs/references/filters/set_context/>set_context</a></li><li><a href=/gateway/main/docs/references/filters/set_hostname/>set_hostname</a></li><li><a href=/gateway/main/docs/references/filters/set_request_header/>set_request_header</a></li><li><a href=/gateway/main/docs/references/filters/set_request_query_args/>set_request_query_args</a></li><li><a href=/gateway/main/docs/references/filters/set_response/>set_response</a></li><li><a href=/gateway/main/docs/references/filters/set_response_header/>set_response_header</a></li><li><a href=/gateway/main/docs/references/filters/sleep/>sleep</a></li><li><a href=/gateway/main/docs/references/filters/switch/>switch</a></li><li><a href=/gateway/main/docs/references/filters/translog/>translog</a></li></ul></li><li><input type=checkbox id=section-82db29a871579194764c352cfff582f2 class=toggle>
<label for=section-82db29a871579194764c352cfff582f2 class="flex justify-between"><a href=/gateway/main/docs/references/processors/>Offline Processor</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/references/processors/bulk_indexing/>bulk_indexing</a></li><li><a href=/gateway/main/docs/references/processors/consumer/>consumer</a></li><li><a href=/gateway/main/docs/references/processors/dag/>dag</a></li><li><a href=/gateway/main/docs/references/processors/dump_hash/>dump_hash</a></li><li><a href=/gateway/main/docs/references/processors/flow_replay/>flow_replay</a></li><li><a href=/gateway/main/docs/references/processors/flow_runner/>flow_runner</a></li><li><a href=/gateway/main/docs/references/processors/index_diff/>index_diff</a></li><li><a href=/gateway/main/docs/references/processors/indexing_merge/>indexing_merge</a></li><li><a href=/gateway/main/docs/references/processors/json_indexing/>json_indexing</a></li><li><a href=/gateway/main/docs/references/processors/merge_to_bulk/>merge_to_bulk</a></li><li><a href=/gateway/main/docs/references/processors/queue_consumer/>queue_consumer</a></li><li><a href=/gateway/main/docs/references/processors/replay/>replay</a></li><li><a href=/gateway/main/docs/references/processors/smtp/>smtp</a></li></ul></li><li><input type=checkbox id=section-3de6688eceb9f20db2f0270adccf76e2 class=toggle>
<label for=section-3de6688eceb9f20db2f0270adccf76e2 class="flex justify-between"><a>Functional Component</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/references/modules/floating_ip/>Floating IP</a></li><li><a href=/gateway/main/docs/references/modules/force_merge/>Index Segment Merging</a></li></ul></li><li><a href=/gateway/main/docs/references/config/>Other Configurations</a></li></ul></li><li><input type=checkbox id=section-391bcaab6cc03bd87e3373752bfd390e class=toggle checked>
<label for=section-391bcaab6cc03bd87e3373752bfd390e class="flex justify-between"><a>Tutorials</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/tutorial/log4j2_filtering/>Protect Elasticsearch from Apache Log4j Vulnerability</a></li><li><a href=/gateway/main/docs/tutorial/online_query_rewrite/ class=active>Rewrite Your Elasticsearch Requests OnTheFly</a></li><li><a href=/gateway/main/docs/tutorial/request-logging/>Elasticsearch Search Requests Analysis/Audit</a></li><li><a href=/gateway/main/docs/tutorial/index_diff/>Document-Level Index Diff Between Two Elasticsearch Clusters</a></li><li><a href=/gateway/main/docs/tutorial/proxy_kibana/>Adding a TLS and Basic Security for Kibana</a></li><li><a href=/gateway/main/docs/tutorial/proxy_elasticsearch/>Enable HTTPS/TLS + Basic Auth for Elasticsearch easily</a></li><li><a href=/gateway/main/docs/tutorial/fix_count_in_search_response/>Handle Count Structure of Different Elasticsearch Versions</a></li><li><a href=/gateway/main/docs/tutorial/es-hadoop_integration/>Integrate with Elasticsearch-Hadoop</a></li><li><a href=/gateway/main/docs/tutorial/prometheus_integration/>Integration with Prometheus</a></li><li><a href=/gateway/main/docs/tutorial/routing_to_cluser_by_index/>Unified access indexes from different clusters in Kibana</a></li><li><a href=/gateway/main/docs/tutorial/path_rewrite_by_javascript/>Use JavaScript for complex query rewriting</a></li></ul></li><li><input type=checkbox id=section-7e4e95606453deb85437b78d9c3f2d72 class=toggle>
<label for=section-7e4e95606453deb85437b78d9c3f2d72 class="flex justify-between"><a href=/gateway/main/docs/user-cases/>User Cases</a>
<span>▾</span></label><ul><li><a href=/gateway/main/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/>How an Insurance Group Improved the Indexing Speed by 200x Times</a></li><li><a href=/gateway/main/docs/user-cases/stories/a_cross_region_cluster_access_locality/>Nearest Cluster Access Across Two Cloud Providers</a></li></ul></li><li><a href=/gateway/main/docs/troubleshooting/>FAQs</a><ul></ul></li><li><a href=/gateway/main/docs/release-notes/>Release Notes</a><ul></ul></li></ul><ul><li><a href=https://github.com/infinilabs/gateway target=_blank rel=noopener>Github</a></li></ul><ul><a class=download-btn href=https://release.infinilabs.com/gateway/>Download</a></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/gateway/main/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Rewrite Your Elasticsearch Requests OnTheFly</strong>
<label for=toc-control><img src=/gateway/main/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#rewrite-your-elasticsearch-requests-onthefly>Rewrite Your Elasticsearch Requests OnTheFly</a><ul><li><a href=#example>Example</a></li><li><a href=#another-example>Another Example</a></li><li><a href=#another-example-1>Another Example</a></li><li><a href=#further-improvement>Further Improvement</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=rewrite-your-elasticsearch-requests-onthefly>Rewrite Your Elasticsearch Requests OnTheFly
<a class=anchor href=#rewrite-your-elasticsearch-requests-onthefly>#</a></h1><p>In some cases, you may find that the QueryDSL generated by the service code is unreasonable.
The general practice is to modify the service code and publish it online. If the launch of a new version takes a long time (for example, the put-into-production window is not reached, major network operation closure is in progress, or additional code needs to be submitted to go live), a large number of tests need to be performed.
However, faults in the production environment need to be rectified immediately and customers have no time to wait. What should be done in that case?</p><p>Don&rsquo;t worry. You can use INFINI Gateway to dynamically repair queries.</p><h2 id=example>Example
<a class=anchor href=#example>#</a></h2><p>See the following query example:</p><pre><code>GET _search
{
 &quot;size&quot;: 1000000
 , &quot;explain&quot;: true
}
</code></pre><p>The <code>size</code> parameter is set to a very large value and the problem is not found at the beginning. With more and more data generated, too much returned data is bound to cause a sharp decline in performance.
In addition, enabling the <code>explain</code> parameter will create unnecessary performance overhead and this function is generally used only during development and debugging.</p><p>By adding the <code>request_body_json_set</code> filter to the gateway, you can dynamically replace the value of the specified request body JSON PATH. The configuration for the above example is as follows:</p><pre><code>flow:
- name: rewrite_query
  filter:
    - request_body_json_set:
       path:
         - explain -&gt; false
         - size -&gt; 10
   - dump_request_body:
   - elasticsearch:
       elasticsearch: dev
</code></pre><p>Set the <code>explain</code> and <code>size</code> parameters again. The query is rewritten in the following format before it is sent to Elasticsearch:</p><pre><code>{
 &quot;size&quot;: 10, &quot;explain&quot;: false
}
</code></pre><p>The problem is successfully fixed in in-service mode.</p><h2 id=another-example>Another Example
<a class=anchor href=#another-example>#</a></h2><p>Look at the following query example. The programmer who writes the code writes the name of the field to be queried by mistake. The name should be <code>name</code> but is written as <code>name1</code>. The <code>size</code> parameter is set to a very large value.</p><pre><code>GET medcl/_search
{
  &quot;aggs&quot;: {
    &quot;total_num&quot;: {
      &quot;terms&quot;: {
        &quot;field&quot;: &quot;name1&quot;,
        &quot;size&quot;: 1000000
      }
    }
  }
}
</code></pre><p>The system goes live but a problem arises when a query is conducted.
For this problem, you can add the following filter configuration to the gateway request flow:</p><pre><code>flow:
- name: rewrite_query
  filter:
    - request_body_json_set:
       path:
         - aggs.total_num.terms.field -&gt; &quot;name&quot;
         - aggs.total_num.terms.size -&gt; 10
         - size -&gt; 0
   - dump_request_body:
   - elasticsearch:
       elasticsearch: dev
</code></pre><p>In the above configuration, we can replace the data of the JSON request body through its path, and add one parameter not to return the query document because only aggregated results are required.</p><h2 id=another-example-1>Another Example
<a class=anchor href=#another-example-1>#</a></h2><p>The user query is as follows:</p><pre><code>{
  &quot;query&quot;:{
	&quot;bool&quot;:{
	   &quot;should&quot;:[{&quot;term&quot;:{&quot;isDel&quot;:0}},{&quot;match&quot;:{&quot;type&quot;:&quot;order&quot;}}]
	}
}
}
</code></pre><p>Now you want to replace the term query with the equivalent range query as follows:</p><pre><code>{
  &quot;query&quot;:{
	&quot;bool&quot;:{
	   &quot;should&quot;:[{ &quot;range&quot;: { &quot;isDel&quot;: {&quot;gte&quot;: 0,&quot;lte&quot;: 0 }}},{&quot;match&quot;:{&quot;type&quot;:&quot;order&quot;}}]
	}
}
}
</code></pre><p>Use the following configuration:</p><pre><code>flow:
  - name: rewrite_query
    filter:
      - request_body_json_del:
          path:
            - query.bool.should.[0]
      - request_body_json_set:
          path:
            - query.bool.should.[1].range.isDel.gte -&gt; 0
            - query.bool.should.[1].range.isDel.lte -&gt; 0
      - dump_request_body:
      - elasticsearch:
          elasticsearch: dev
</code></pre><p>In the above configuration, one <code>request_body_json_del</code> filter is used to delete the first element from the Should query, that is, the Term subquery to be replaced.
There is only one Match query left. One Should subquery is added, and the added subscript should be <code>1</code>. Set the attributes of the Range query.</p><h2 id=further-improvement>Further Improvement
<a class=anchor href=#further-improvement>#</a></h2><p>In the above examples, queries are directly replaced. In general, you may need to make a judgment about whether to replace the query, for example, replacement may only be performed when the <code>_ctx.request.body_json.query.bool.should.[0].term.isDel</code> JSON field exists.
The
<a href=/gateway/main/docs/references/flow/#%e6%9d%a1%e4%bb%b6%e5%ae%9a%e4%b9%89>conditional judgment</a> of the gateway is very flexible and the configuration is as follows:</p><pre><code>flow:
  - name: cache_first
    filter:
      - if:
          and:
            - exists: ['_ctx.request.body_json.query.bool.should.[0].term.isDel']
        then:
          - request_body_json_del:
              path:
                - query.bool.should.[0]
          - request_body_json_set:
              path:
                - query.bool.should.[1].range.isDel.gte -&gt; 0
                - query.bool.should.[1].range.isDel.lte -&gt; 0
          - dump_request_body:
      - elasticsearch:
          elasticsearch: dev
</code></pre><p>The feature is superb!</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/infinilabs/gateway/edit/main/docs/content.en/docs/tutorial/online_query_rewrite.md target=_blank rel=noopener><img src=/gateway/main/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script>(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:2567416,hjsv:6};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RJPTVP614C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-RJPTVP614C');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#rewrite-your-elasticsearch-requests-onthefly>Rewrite Your Elasticsearch Requests OnTheFly</a><ul><li><a href=#example>Example</a></li><li><a href=#another-example>Another Example</a></li><li><a href=#another-example-1>Another Example</a></li><li><a href=#further-improvement>Further Improvement</a></li></ul></li></ul></nav></aside></main></body></html>