<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Benchmark Testing #  INFINI Loadgen is a lightweight performance testing tool specifically designed for Easysearch, Elasticsearch, and OpenSearch.
Features of Loadgen:
 Robust performance Lightweight and dependency-free Supports template-based parameter randomization Supports high concurrency Supports balanced traffic control at the benchmark end Supports server response validation   Download link: https://release.infinilabs.com/loadgen/
 Loadgen #  Loadgen is easy to use. After the tool is downloaded and decompressed, you will get three files: an executable program, a configuration file loadgen."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Benchmark Testing"><meta property="og:description" content="Benchmark Testing #  INFINI Loadgen is a lightweight performance testing tool specifically designed for Easysearch, Elasticsearch, and OpenSearch.
Features of Loadgen:
 Robust performance Lightweight and dependency-free Supports template-based parameter randomization Supports high concurrency Supports balanced traffic control at the benchmark end Supports server response validation   Download link: https://release.infinilabs.com/loadgen/
 Loadgen #  Loadgen is easy to use. After the tool is downloaded and decompressed, you will get three files: an executable program, a configuration file loadgen."><meta property="og:type" content="article"><meta property="og:url" content="/loadgen/main/docs/getting-started/benchmark/"><title>Benchmark Testing | INFINI Loadgen</title><link rel=manifest href=/loadgen/main/manifest.json><link rel=icon href=/loadgen/main/favicon.png type=image/x-icon><link rel=alternate hreflang=zh href=/loadgen/main/zh/docs/getting-started/benchmark/ title=性能测试><link rel=stylesheet href=/loadgen/main/book.min.d80e87b12a4b49d9913d0bdd98bd83b7a44988be784760ba15522b377313dcf9.css integrity="sha256-2A6HsSpLSdmRPQvdmL2Dt6RJiL54R2C6FVIrN3MT3Pk="><script defer src=/loadgen/main/js/jquery-2.x.min.js></script><script defer src=/loadgen/main/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/loadgen/main><img src=/loadgen/main/img/logo-en.svg alt=Logo></a></h2><div id=searchbox style=margin-bottom:10px></div><div class=heading><select class=version-selector>
<option value>main (latest)</option>
<option value=v1.29.2>v1.29.2</option>
<option value=v1.29.1>v1.29.1</option>
<option value=v1.29.0>v1.29.0</option>
<option value=v1.28.2>v1.28.2</option>
<option value=v1.28.0>v1.28.0</option>
<option value=v1.27.0>v1.27.0</option></select></div><ul><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle checked>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>Getting Started</a>
<span>▾</span></label><ul><li><a href=/loadgen/main/docs/getting-started/install/>Installing the Loadgen</a></li><li><a href=/loadgen/main/docs/getting-started/benchmark/ class=active>Benchmark Testing</a></li></ul></li><li><a href=/loadgen/main/docs/release-notes/>Release Notes</a><ul></ul></li></ul><ul><li><a href=https://github.com/infinilabs/loadgen target=_blank rel=noopener>Github</a></li></ul><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/loadgen/main/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li class=active><a href=/loadgen/main/ class="flex align-center"><img src=/loadgen/main/svg/translate.svg class=book-icon alt=Languages>
English</a></li><li><a href=/loadgen/main/zh/docs/getting-started/benchmark/ class="flex align-center"><img src=/loadgen/main/svg/translate.svg class=book-icon alt=Languages>
简体中文</a></li></ul></div></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/loadgen/main/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Benchmark Testing</strong>
<label for=toc-control><img src=/loadgen/main/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#benchmark-testing>Benchmark Testing</a><ul><li><a href=#loadgen>Loadgen</a><ul><li><a href=#running-mode-settings>Running Mode Settings</a></li><li><a href=#http-header-handling>HTTP Header Handling</a></li></ul></li><li><a href=#usage-of-variables>Usage of Variables</a><ul><li><a href=#variable-usage-example>Variable Usage Example</a></li><li><a href=#environment-variables>Environment Variables</a></li></ul></li><li><a href=#request-definition>Request Definition</a><ul><li><a href=#simulating-bulk-ingestion>Simulating Bulk Ingestion</a></li><li><a href=#response-assertions>Response Assertions</a></li><li><a href=#dynamic-variable-registration>Dynamic Variable Registration</a></li></ul></li><li><a href=#running-the-benchmark>Running the Benchmark</a><ul><li><a href=#command-line-parameters>Command Line Parameters</a></li><li><a href=#limiting-client-workload>Limiting Client Workload</a></li><li><a href=#limiting-the-total-number-of-requests>Limiting the Total Number of Requests</a></li><li><a href=#using-auto-incremental-ids-to-ensure-the-document-sequence>Using Auto Incremental IDs to Ensure the Document Sequence</a></li><li><a href=#reuse-variables-in-request-context>Reuse Variables in Request Context</a></li><li><a href=#customize-header>Customize Header</a></li></ul></li><li><a href=#running-test-suites>Running Test Suites</a><ul><li><a href=#environment-variables-configuration>Environment Variables Configuration</a></li><li><a href=#test-case-configuration>Test Case Configuration</a></li><li><a href=#running-test-suites-1>Running Test Suites</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=benchmark-testing>Benchmark Testing
<a class=anchor href=#benchmark-testing>#</a></h1><p>INFINI Loadgen is a lightweight performance testing tool specifically designed for Easysearch, Elasticsearch, and OpenSearch.</p><p>Features of Loadgen:</p><ul><li>Robust performance</li><li>Lightweight and dependency-free</li><li>Supports template-based parameter randomization</li><li>Supports high concurrency</li><li>Supports balanced traffic control at the benchmark end</li><li>Supports server response validation</li></ul><blockquote><p>Download link: <a href=https://release.infinilabs.com/loadgen/>https://release.infinilabs.com/loadgen/</a></p></blockquote><h2 id=loadgen>Loadgen
<a class=anchor href=#loadgen>#</a></h2><p>Loadgen is easy to use. After the tool is downloaded and decompressed, you will get three files: an executable program, a configuration file <code>loadgen.yml</code>, and a test file <code>loadgen.dsl</code>. The configuration file example is as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>env</span>:
  <span style=color:#f92672>ES_USERNAME</span>: <span style=color:#ae81ff>elastic</span>
  <span style=color:#f92672>ES_PASSWORD</span>: <span style=color:#ae81ff>elastic</span>
  <span style=color:#f92672>ES_ENDPOINT</span>: <span style=color:#ae81ff>http://localhost:8000</span>
</code></pre></div><p>The test file example is as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># runner: {
#   // total_rounds: 1
#   no_warm: false,
#   // Whether to log all requests
#   log_requests: false,
#   // Whether to log all requests with the specified response status
#   log_status_codes: [0, 500],
#   assert_invalid: false,
#   assert_error: false,
# },
# variables: [
#   {
#     name: &#34;ip&#34;,
#     type: &#34;file&#34;,
#     path: &#34;dict/ip.txt&#34;,
#     // Replace special characters in the value
#     replace: {
#       &#39;&#34;&#39;: &#39;\\&#34;&#39;,
#       &#39;\\&#39;: &#39;\\\\&#39;,
#     },
#   },
#   {
#     name: &#34;id&#34;,
#     type: &#34;sequence&#34;,
#   },
#   {
#     name: &#34;id64&#34;,
#     type: &#34;sequence64&#34;,
#   },
#   {
#     name: &#34;uuid&#34;,
#     type: &#34;uuid&#34;,
#   },
#   {
#     name: &#34;now_local&#34;,
#     type: &#34;now_local&#34;,
#   },
#   {
#     name: &#34;now_utc&#34;,
#     type: &#34;now_utc&#34;,
#   },
#   {
#     name: &#34;now_utc_lite&#34;,
#     type: &#34;now_utc_lite&#34;,
#   },
#   {
#     name: &#34;now_unix&#34;,
#     type: &#34;now_unix&#34;,
#   },
#   {
#     name: &#34;now_with_format&#34;,
#     type: &#34;now_with_format&#34;,
#     // https://programming.guide/go/format-parse-string-time-date-example.html
#     format: &#34;2006-01-02T15:04:05-0700&#34;,
#   },
#   {
#     name: &#34;suffix&#34;,
#     type: &#34;range&#34;,
#     from: 10,
#     to: 1000,
#   },
#   {
#     name: &#34;bool&#34;,
#     type: &#34;range&#34;,
#     from: 0,
#     to: 1,
#   },
#   {
#     name: &#34;list&#34;,
#     type: &#34;list&#34;,
#     data: [&#34;medcl&#34;, &#34;abc&#34;, &#34;efg&#34;, &#34;xyz&#34;],
#   },
#   {
#     name: &#34;id_list&#34;,
#     type: &#34;random_array&#34;,
#     variable_type: &#34;number&#34;, // number/string
#     variable_key: &#34;suffix&#34;, // variable key to get array items
#     square_bracket: false,
#     size: 10, // how many items for array
#   },
#   {
#     name: &#34;str_list&#34;,
#     type: &#34;random_array&#34;,
#     variable_type: &#34;number&#34;, // number/string
#     variable_key: &#34;suffix&#34;, // variable key to get array items
#     square_bracket: true,
#     size: 10, // how many items for array
#     replace: {
#       // Use &#39; instead of &#34; for string quotes
#       &#39;&#34;&#39;: &#34;&#39;&#34;,
#       // Use {} instead of [] as array brackets
#       &#34;[&#34;: &#34;{&#34;,
#       &#34;]&#34;: &#34;}&#34;,
#     },
#   },
# ],

POST $[[env.ES_ENDPOINT]]/medcl/_search
{ &#34;track_total_hits&#34;: true, &#34;size&#34;: 0, &#34;query&#34;: { &#34;terms&#34;: { &#34;patent_id&#34;: [ $[[id_list]] ] } } }
# request: {
#   runtime_variables: {batch_no: &#34;uuid&#34;},
#   runtime_body_line_variables: {routing_no: &#34;uuid&#34;},
#   basic_auth: {
#     username: &#34;$[[env.ES_USERNAME]]&#34;,
#     password: &#34;$[[env.ES_PASSWORD]]&#34;,
#   },
# },
</code></pre></div><h3 id=running-mode-settings>Running Mode Settings
<a class=anchor href=#running-mode-settings>#</a></h3><p>By default, Loadgen runs in performance testing mode, repeating all requests in <code>requests</code> for the specified duration (<code>-d</code>). If you only need to check the test results once, you can set the number of executions of <code>requests</code> by <code>runner.total_rounds</code>.</p><h3 id=http-header-handling>HTTP Header Handling
<a class=anchor href=#http-header-handling>#</a></h3><p>By default, Loadgen will automatically format the HTTP response headers (<code>user-agent: xxx</code> -> <code>User-Agent: xxx</code>). If you need to precisely determine the response headers returned by the server, you can disable this behavior by setting <code>runner.disable_header_names_normalizing</code>.</p><h2 id=usage-of-variables>Usage of Variables
<a class=anchor href=#usage-of-variables>#</a></h2><p>In the above configuration, <code>variables</code> is used to define variable parameters, identified by <code>name</code>. In a constructed request, <code>$[[Variable name]]</code> can be used to access the value of the variable. The currently supported variable types are:</p><table><thead><tr><th>Type</th><th>Description</th><th>Parameters</th></tr></thead><tbody><tr><td><code>file</code></td><td>Load variables from file</td><td><code>path</code>: the path of the data files<br><code>data</code>: a list of values, will get appended to the end of the data specified by <code>path</code> file</td></tr><tr><td><code>list</code></td><td>Defined variables inline</td><td>use <code>data</code> to define a string array</td></tr><tr><td><code>sequence</code></td><td>32-bit Variable of the auto incremental numeric type</td><td><code>from</code>: the minimum of the values<br><code>to</code>: the maximum of the values</td></tr><tr><td><code>sequence64</code></td><td>64-bit Variable of the auto incremental numeric type</td><td><code>from</code>: the minimum of the values<br><code>to</code>: the maximum of the values</td></tr><tr><td><code>range</code></td><td>Variable of the range numbers, support parameters <code>from</code> and <code>to</code> to define the range</td><td><code>from</code>: the minimum of the values<br><code>to</code>: the maximum of the values</td></tr><tr><td><code>random_array</code></td><td>Generate a random array, data elements come from the variable specified by <code>variable_key</code></td><td><code>variable_key</code>: data source variable<br><code>size</code>: length of the output array<br><code>square_bracket</code>: <code>true/false</code>, whether the output value needs <code>[</code> and <code>]</code><br><code>string_bracket</code>: string, the specified string will be attached before and after the output element</td></tr><tr><td><code>uuid</code></td><td>UUID string type variable</td><td></td></tr><tr><td><code>now_local</code></td><td>Current time, local time zone</td><td></td></tr><tr><td><code>now_utc</code></td><td>Current time, UTC time zone. Output format: <code>2006-01-02 15:04:05.999999999 -0700 MST</code></td><td></td></tr><tr><td><code>now_utc_lite</code></td><td>Current time, UTC time zone. Output format: <code>2006-01-02T15:04:05.000</code></td><td></td></tr><tr><td><code>now_unix</code></td><td>Current time, Unix timestamp</td><td></td></tr><tr><td><code>now_with_format</code></td><td>Current time, supports custom <code>format</code> parameter to format the time string, such as: <code>2006-01-02T15:04:05-0700</code></td><td><code>format</code>: output time format (
<a href=https://www.geeksforgeeks.org/time-formatting-in-golang/>example</a>)</td></tr></tbody></table><h3 id=variable-usage-example>Variable Usage Example
<a class=anchor href=#variable-usage-example>#</a></h3><p>Variable parameters of the <code>file</code> type are loaded from an external text file. One variable parameter occupies one line. When one variable of the file type is accessed, one variable value is taken randomly. An example of the variable format is as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># test/user.txt
medcl
elastic
</code></pre></div><p>Tips about how to generate a random string of fixed length, such as 1024 per line:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>LC_CTYPE<span style=color:#f92672>=</span>C tr -dc A-Za-z0-9_<span style=color:#ae81ff>\!\@\#\$\%\^\&amp;\*\(\)</span>-+<span style=color:#f92672>=</span> &lt; /dev/random | head -c <span style=color:#ae81ff>1024</span> &gt;&gt; 1k.txt
</code></pre></div><h3 id=environment-variables>Environment Variables
<a class=anchor href=#environment-variables>#</a></h3><p>Loadgen supports loading and using environment variables. You can specify the default values in the <code>loadgen.dsl</code> configuration. Loadgen will overwrite the variables at runtime if they are also specified by the command-line environment.</p><p>The environment variables can be accessed by <code>$[[env.ENV_KEY]]</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>#// Configure default values for environment variables
# env: {
#   ES_USERNAME: &#34;elastic&#34;,
#   ES_PASSWORD: &#34;elastic&#34;,
#   ES_ENDPOINT: &#34;http://localhost:8000&#34;,
# },

#// Use runtime variables
GET $[[env.ES_ENDPOINT]]/medcl/_search
{&#34;query&#34;: {&#34;match&#34;: {&#34;name&#34;: &#34;$[[user]]&#34;}}}
# request: {
#   // Use runtime variables
#   basic_auth: {
#     username: &#34;$[[env.ES_USERNAME]]&#34;,
#     password: &#34;$[[env.ES_PASSWORD]]&#34;,
#   },
# },
</code></pre></div><h2 id=request-definition>Request Definition
<a class=anchor href=#request-definition>#</a></h2><p>The <code>requests</code> node is used to set requests to be executed by Loadgen in sequence. Loadgen supports fixed-parameter requests and requests constructed using template-based variable parameters. The following is an example of a common query request:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>GET http://localhost:8000/medcl/_search?q=name:$[[user]]
# request: {
#   username: elastic,
#   password: pass,
# },
</code></pre></div><p>In the above query, Loadgen conducts queries based on the <code>medcl</code> index and executes one query based on the <code>name</code> field. The value of each request is from the random variable <code>user</code>.</p><h3 id=simulating-bulk-ingestion>Simulating Bulk Ingestion
<a class=anchor href=#simulating-bulk-ingestion>#</a></h3><p>It is very easy to use Loadgen to simulate bulk ingestion. Configure one index operation in the request body and then use the <code>body_repeat_times</code> parameter to randomly replicate several parameterized requests to complete the preparation of a batch of requests. See the following example.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>POST http://localhost:8000/_bulk
{&#34;index&#34;: {&#34;_index&#34;: &#34;medcl-y4&#34;, &#34;_type&#34;: &#34;doc&#34;, &#34;_id&#34;: &#34;$[[uuid]]&#34;}}
{&#34;id&#34;: &#34;$[[id]]&#34;, &#34;field1&#34;: &#34;$[[user]]&#34;, &#34;ip&#34;: &#34;$[[ip]]&#34;, &#34;now_local&#34;: &#34;$[[now_local]]&#34;, &#34;now_unix&#34;: &#34;$[[now_unix]]&#34;}
# request: {
#   basic_auth: {
#     username: &#34;test&#34;,
#     password: &#34;testtest&#34;,
#  },
#  body_repeat_times: 1000,
# },
</code></pre></div><h3 id=response-assertions>Response Assertions
<a class=anchor href=#response-assertions>#</a></h3><p>You can use the <code>assert</code> configuration to check the response values. <code>assert</code> now supports most of all the
<a href=https://docs.infinilabs.com/gateway/main/docs/references/flow/#condition-type>condition checkers</a> of INFINI Gateway.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>GET http://localhost:8000/medcl/_search?q=name:$[[user]]
# request: {
#   basic_auth: {
#     username: &#34;test&#34;,
#     password: &#34;testtest&#34;,
#  },
# },
# assert: {
#   _ctx.response.status: 201,
# },
</code></pre></div><p>The</p><p>response value can be accessed from the <code>_ctx</code> value, currently it contains these values:</p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>_ctx.response.status</code></td><td>HTTP response status code</td></tr><tr><td><code>_ctx.response.header</code></td><td>HTTP response headers</td></tr><tr><td><code>_ctx.response.body</code></td><td>HTTP response body text</td></tr><tr><td><code>_ctx.response.body_json</code></td><td>If the HTTP response body is a valid JSON string, you can access the JSON fields by <code>body_json</code></td></tr><tr><td><code>_ctx.elapsed</code></td><td>The time elapsed since request sent to the server (milliseconds)</td></tr></tbody></table><p>If the request failed (e.g. the host is not reachable), Loadgen will record it under <code>Number of Errors</code> as part of the testing output. If you configured <code>runner.assert_error: true</code>, Loadgen will exit as <code>exit(2)</code> when there&rsquo;re any requests failed.</p><p>If the assertion failed, Loadgen will record it under <code>Number of Invalid</code> as part of the testing output and skip the subsequent requests in this round. If you configured <code>runner.assert_invalid: true</code>, Loadgen will exit as <code>exit(1)</code> when there&rsquo;re any assertions failed.</p><h3 id=dynamic-variable-registration>Dynamic Variable Registration
<a class=anchor href=#dynamic-variable-registration>#</a></h3><p>Each request can use <code>register</code> to dynamically set the variables based on the response value, a common usage is to update the parameters of the later requests based on the previous responses.</p><p>In the below example, we&rsquo;re registering the response value <code>_ctx.response.body_json.test.settings.index.uuid</code> of the <code>$[[env.ES_ENDPOINT]]/test</code> to the <code>index_id</code> variable, then we can access it by <code>$[[index_id]]</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>GET $[[env.ES_ENDPOINT]]/test
# register: [
#   {index_id: &#34;_ctx.response.body_json.test.settings.index.uuid&#34;},
# ],
# assert: (200, {}),
</code></pre></div><h2 id=running-the-benchmark>Running the Benchmark
<a class=anchor href=#running-the-benchmark>#</a></h2><p>Run the Loadgen program to perform the benchmark test as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ loadgen -d 30 -c 100 -compress -run

loadgen.dsl


   __   ___  _      ___  ___   __    __
  / /  /___\/_\    /   \/ _ \ /__\/\ \ \
 / /  //  ///_\\  / /\ / /_\//_\ /  \/ /
/ /__/ \_//  _  \/ /_// /_\\//__/ /\  /
\____|___/\_/ \_/___,&#39;\____/\__/\_\ \/

[LOADGEN] A http load generator and testing suit.
[LOADGEN] 1.0.0_SNAPSHOT, 83f2cb9, Sun Jul 4 13:52:42 2021 +0800, medcl, support single item in dict files
[07-19 16:15:00] [INF] [instance.go:24] workspace: data/loadgen/nodes/0
[07-19 16:15:00] [INF] [loader.go:312] warmup started
[07-19 16:15:00] [INF] [app.go:306] loadgen now started.
[07-19 16:15:00] [INF] [loader.go:316] [GET] http://localhost:8000/medcl/_search
[07-19 16:15:00] [INF] [loader.go:317] status: 200,&lt;nil&gt;,{&#34;took&#34;:1,&#34;timed_out&#34;:false,&#34;_shards&#34;:{&#34;total&#34;:1,&#34;successful&#34;:1,&#34;skipped&#34;:0,&#34;failed&#34;:0},&#34;hits&#34;:{&#34;total&#34;:{&#34;value&#34;:0,&#34;relation&#34;:&#34;eq&#34;},&#34;max_score&#34;:null,&#34;hits&#34;:[]}}
[07-19 16:15:00] [INF] [loader.go:316] [GET] http://localhost:8000/medcl/_search?q=name:medcl
[07-19 16:15:00] [INF] [loader.go:317] status: 200,&lt;nil&gt;,{&#34;took&#34;:1,&#34;timed_out&#34;:false,&#34;_shards&#34;:{&#34;total&#34;:1,&#34;successful&#34;:1,&#34;skipped&#34;:0,&#34;failed&#34;:0},&#34;hits&#34;:{&#34;total&#34;:{&#34;value&#34;:0,&#34;relation&#34;:&#34;eq&#34;},&#34;max_score&#34;:null,&#34;hits&#34;:[]}}
[07-19 16:15:01] [INF] [loader.go:316] [POST] http://localhost:8000/_bulk
[07-19 16:15:01] [INF] [loader.go:317] status: 200,&lt;nil&gt;,{&#34;took&#34;:120,&#34;errors&#34;:false,&#34;items&#34;:[{&#34;index&#34;:{&#34;_index&#34;:&#34;medcl-y4&#34;,&#34;_type&#34;:&#34;doc&#34;,&#34;_id&#34;:&#34;c3qj9123r0okahraiej0&#34;,&#34;_version&#34;:1,&#34;result&#34;:&#34;created&#34;,&#34;_shards&#34;:{&#34;total&#34;:2,&#34;successful&#34;:1,&#34;failed&#34;:0},&#34;_seq_no&#34;:5735852,&#34;_primary_term&#34;:3,&#34;status&#34;:201}}]}
[07-19 16:15:01] [INF] [loader.go:325] warmup finished

5253 requests in 32.756483336s, 524.61KB sent, 2.49MB received

[Loadgen Client Metrics]
Requests/sec:		175.10
Request Traffic/sec:	17.49KB
Total Transfer/sec:	102.34KB
Avg Req Time:		5.711022ms
Fastest Request:	440.448µs
Slowest Request:	3.624302658s
Number of Errors:	0
Number of Invalid:	0
Status 200:		5253

[Estimated Server Metrics]
Requests/sec:		160.37
Transfer/sec:		93.73KB
Avg Req Time:		623.576686ms
</code></pre></div><p>Before the formal benchmark, Loadgen will execute all requests once for warm-up. If an error occurs, it will prompt whether to continue. The warm-up request results will also be output to the terminal. After execution, a summary of the execution will be output. You can skip this check phase by setting <code>runner.no_warm</code>.</p><blockquote><p>Since the final result of Loadgen is the cumulative statistics after all requests are completed, there may be inaccuracies. It is recommended to monitor Elasticsearch&rsquo;s various operating indicators in real-time through the Kibana monitoring dashboard.</p></blockquote><h3 id=command-line-parameters>Command Line Parameters
<a class=anchor href=#command-line-parameters>#</a></h3><p>Loadgen will loop through the requests defined in the configuration file. By default, Loadgen will only run for <code>5s</code> and then automatically exit. If you want to extend the runtime or increase concurrency, you can control it by setting parameters at startup. Check the help command as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ loadgen -help
Usage of loadgen:
  -c int
      Number of concurrent threads (default 1)
  -compress
      Compress requests with gzip
  -config string
      the location of config file (default &#34;loadgen.yml&#34;)
  -cpu int
      the number of CPUs to use (default -1)
  -d int
      Duration of tests in seconds (default 5)
  -debug
      run in debug mode, loadgen will quit on panic immediately with full stack trace
  -dial-timeout int
      Connection dial timeout in seconds, default 3s (default 3)
  -gateway-log string
      Log level of Gateway (default &#34;debug&#34;)
  -l int
      Limit total requests (default -1)
  -log string
      the log level, options: trace,debug,info,warn,error,off
  -mem int
      the max size of Memory to use, soft limit in megabyte (default -1)
  -plugin value
      load additional plugins
  -r int
      Max requests per second (fixed QPS) (default -1)
  -read-timeout int
      Connection read timeout in seconds, default 0s (use -timeout)
  -run string
      DSL config to run tests (default &#34;loadgen.dsl&#34;)
  -service string
      service management, options: install,uninstall,start,stop
  -timeout int
      Request timeout in seconds, default 60s (default 60)
  -v  version
  -write-timeout int
      Connection write timeout in seconds, default 0s (use -timeout)
</code></pre></div><h3 id=limiting-client-workload>Limiting Client Workload
<a class=anchor href=#limiting-client-workload>#</a></h3><p>Using Loadgen and setting the command line parameter <code>-r</code> can limit the number of requests sent by the client per second, thereby evaluating the response time and load of Elasticsearch under fixed pressure, as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>loadgen -d <span style=color:#ae81ff>30</span> -c <span style=color:#ae81ff>100</span> -r <span style=color:#ae81ff>100</span>
</code></pre></div><blockquote><p>Note: The client throughput limit may not be accurate enough in the case of massive concurrencies.</p></blockquote><h3 id=limiting-the-total-number-of-requests>Limiting the Total Number of Requests
<a class=anchor href=#limiting-the-total-number-of-requests>#</a></h3><p>By setting the parameter <code>-l</code>, you can control the total number of requests sent by the client to generate fixed documents. Modify the configuration as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>#// loadgen-gw.dsl
POST http://localhost:8000/medcl-test/doc2/_bulk
{&#34;index&#34;: {&#34;_index&#34;: &#34;medcl-test&#34;, &#34;_id&#34;: &#34;$[[uuid]]&#34;}}
{&#34;id&#34;: &#34;$[[id]]&#34;, &#34;field1&#34;: &#34;$[[user]]&#34;, &#34;ip&#34;: &#34;$[[ip]]&#34;}
# request: {
#   basic_auth: {
#     username: &#34;test&#34;,
#     password: &#34;testtest&#34;,
#   },
#   body_repeat_times: 1,
# },
</code></pre></div><p>Each request contains only one document, then execute Loadgen</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>loadgen -run loadgen-gw.dsl -d <span style=color:#ae81ff>600</span> -c <span style=color:#ae81ff>100</span> -l <span style=color:#ae81ff>50000</span>
</code></pre></div><p>After execution, the Elasticsearch index <code>medcl-test</code> will have <code>50000</code> more records.</p><h3 id=using-auto-incremental-ids-to-ensure-the-document-sequence>Using Auto Incremental IDs to Ensure the Document Sequence
<a class=anchor href=#using-auto-incremental-ids-to-ensure-the-document-sequence>#</a></h3><p>If you want the generated document IDs to increase regularly for easy comparison, you can use the <code>sequence</code> type auto incremental ID as the primary key and avoid using random numbers in the content, as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>POST http://localhost:8000/medcl-test/doc2/_bulk
{&#34;index&#34;: {&#34;_index&#34;: &#34;medcl-test&#34;, &#34;_id&#34;: &#34;$[[id]]&#34;}}
{&#34;id&#34;: &#34;$[[id]]&#34;}
# request: {
#   basic_auth: {
#     username: &#34;test&#34;,
#     password: &#34;testtest&#34;,
#   },
#   body_repeat_times: 1,
# },
</code></pre></div><h3 id=reuse-variables-in-request-context>Reuse Variables in Request Context
<a class=anchor href=#reuse-variables-in-request-context>#</a></h3><p>In a request, we might want to use the same variable value, such as the <code>routing</code> parameter to control the shard destination, also store the field in the JSON document. You can use <code>runtime_variables</code> to set request-level variables, or <code>runtime_body_line_variables</code> to define request-body-level variables. If the request body is replicated N times, each line will be different, as shown in the following example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># variables: [
#   {name: &#34;id&#34;, type: &#34;sequence&#34;},
#   {name: &#34;uuid&#34;, type: &#34;uuid&#34;},
#   {name: &#34;now_local&#34;, type: &#34;now_local&#34;},
#   {name: &#34;now_utc&#34;, type: &#34;now_utc&#34;},
#   {name: &#34;now_unix&#34;, type: &#34;now_unix&#34;},
#   {name: &#34;suffix&#34;, type: &#34;range&#34;, from: 10, to 15},
# ],

POST http://192.168.3.188:9206/_bulk
{&#34;create&#34;: {&#34;_index&#34;: &#34;test-$[[suffix]]&#34;, &#34;_type&#34;: &#34;doc&#34;, &#34;_id&#34;: &#34;$[[uuid]]&#34;, &#34;routing&#34;: &#34;$[[routing_no]]&#34;}}
{&#34;id&#34;: &#34;$[[uuid]]&#34;, &#34;routing_no&#34;: &#34;$[[routing_no]]&#34;, &#34;batch_number&#34;: &#34;$[[batch_no]]&#34;, &#34;random_no&#34;: &#34;$[[suffix]]&#34;, &#34;ip&#34;: &#34;$[[ip]]&#34;, &#34;now_local&#34;: &#34;$[[now_local]]&#34;, &#34;now_unix&#34;: &#34;$[[now_unix]]&#34;}
# request: {
#   runtime_variables: {
#     batch_no: &#34;id&#34;,
#   },
#   runtime_body_line_variables: {
#     routing_no: &#34;uuid&#34;,
#   },
#   basic_auth: {
#     username: &#34;ingest&#34;,
#     password: &#34;password&#34;,
#   },
#   body_repeat_times: 10,
# },
</code></pre></div><p>We defined the <code>batch_no</code> variable to represent the same batch number in a batch of documents, and the <code>routing_no</code> variable to represent the routing value at each document level.</p><h3 id=customize-header>Customize Header
<a class=anchor href=#customize-header>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>GET http://localhost:8000/test/_search
# request: {
#   headers: [
#     {Agent: &#34;Loadgen-1&#34;},
#   ],
#   disable_header_names_normalizing: false,
# },
</code></pre></div><p>By default, Loadgen will canonilize the HTTP header keys in the configuration (<code>user-agent: xxx</code> -> <code>User-Agent: xxx</code>). If you need to set the HTTP header keys exactly, you can disable this behavior by setting <code>disable_header_names_normalizing: true</code>.</p><h2 id=running-test-suites>Running Test Suites
<a class=anchor href=#running-test-suites>#</a></h2><p>Loadgen supports running test cases in batches without writing test cases repeatedly. You can quickly test different environment configurations by switching suite configurations:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># loadgen.yml</span>
<span style=color:#f92672>env</span>:
  <span style=color:#75715e># Set up environments to run test suite</span>
  <span style=color:#f92672>LR_TEST_DIR</span>: <span style=color:#ae81ff>./testing</span> <span style=color:#75715e># The path to the test cases.</span>
  <span style=color:#75715e># If you want to start gateway dynamically and automatically:</span>
  <span style=color:#f92672>LR_GATEWAY_CMD</span>: <span style=color:#ae81ff>./bin/gateway</span> <span style=color:#75715e># The path to the executable of INFINI Gateway</span>
  <span style=color:#f92672>LR_GATEWAY_HOST</span>: <span style=color:#ae81ff>0.0.0.0</span>:<span style=color:#ae81ff>18000</span> <span style=color:#75715e># The binding host of the INFINI Gateway</span>
  <span style=color:#f92672>LR_GATEWAY_API_HOST</span>: <span style=color:#ae81ff>0.0.0.0</span>:<span style=color:#ae81ff>19000</span> <span style=color:#75715e># The binding host of the INFINI Gateway API server</span>
  <span style=color:#75715e># Set up other environments for the gateway and loadgen</span>
  <span style=color:#f92672>LR_ELASTICSEARCH_ENDPOINT</span>: <span style=color:#ae81ff>http://localhost:19201</span>
  <span style=color:#f92672>CUSTOM_ENV</span>: <span style=color:#ae81ff>myenv</span>
<span style=color:#f92672>tests</span>:
  <span style=color:#75715e># The relative path of test cases under `LR_TEST_DIR`</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># - gateway.yml: (Optional) the configuration to start the INFINI Gateway dynamically.</span>
  <span style=color:#75715e># - loadgen.dsl: the configuration to run the loadgen tool.</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># The environments set in `env` section will be passed to the INFINI Gateway and loadgen.</span>
  - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>cases/gateway/echo/echo_with_context</span>
</code></pre></div><h3 id=environment-variables-configuration>Environment Variables Configuration
<a class=anchor href=#environment-variables-configuration>#</a></h3><p>Loadgen dynamically configures INFINI Gateway through environment variables specified in <code>env</code>. The following environment variables are required:</p><table><thead><tr><th>Variable Name</th><th>Description</th></tr></thead><tbody><tr><td><code>LR_TEST_DIR</code></td><td>Directory of test cases</td></tr></tbody></table><p>If you need <code>loadgen</code> to dynamically start INFINI Gateway based on the configuration, you need to set the following environment variables:</p><table><thead><tr><th>Variable Name</th><th>Description</th></tr></thead><tbody><tr><td><code>LR_GATEWAY_CMD</code></td><td>Path to the executable of INFINI Gateway</td></tr><tr><td><code>LR_GATEWAY_HOST</code></td><td>Binding host:port of INFINI Gateway</td></tr><tr><td><code>LR_GATEWAY_API_HOST</code></td><td>Binding host:port of INFINI Gateway API</td></tr></tbody></table><h3 id=test-case-configuration>Test Case Configuration
<a class=anchor href=#test-case-configuration>#</a></h3><p>Test cases are configured in <code>tests</code>, each path points to a directory of a test case. Each test case needs to configure a <code>gateway.yml</code> (optional) and a <code>loadgen.dsl</code>. Configuration files can use environment variables configured in <code>env</code> (<code>$[[env.ENV_KEY]]</code>).</p><p>Example <code>gateway.yml</code> configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>path.data</span>: <span style=color:#ae81ff>data</span>
<span style=color:#f92672>path.logs</span>: <span style=color:#ae81ff>log</span>

<span style=color:#f92672>entry</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my_es_entry</span>
    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>router</span>: <span style=color:#ae81ff>my_router</span>
    <span style=color:#f92672>max_concurrency</span>: <span style=color:#ae81ff>200000</span>
    <span style=color:#f92672>network</span>:
      <span style=color:#f92672>binding</span>: <span style=color:#ae81ff>$[[env.LR_GATEWAY_HOST]]</span>

<span style=color:#f92672>flow</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hello_world</span>
    <span style=color:#f92672>filter</span>:
      - <span style=color:#f92672>echo</span>:
          <span style=color:#f92672>message</span>: <span style=color:#e6db74>&#34;hello world&#34;</span>
<span style=color:#f92672>router</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my_router</span>
    <span style=color:#f92672>default_flow</span>: <span style=color:#ae81ff>hello_world</span>
</code></pre></div><p>Example <code>loadgen.dsl</code> configuration:</p><pre><code># runner: {
#   total_rounds: 1,
#   no_warm: true,
#   log_requests: true,
#   assert_invalid: true,
#   assert_error: true,
# },

GET http://$[[env.LR_GATEWAY_HOST]]/
# assert: {
#   _ctx.response: {
#     status: 200,
#     body: &quot;hello world&quot;,
#   },
# },
</code></pre><h3 id=running-test-suites-1>Running Test Suites
<a class=anchor href=#running-test-suites-1>#</a></h3><p>After configuring <code>loadgen.yml</code>, you can run Loadgen with the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>loadgen -config loadgen.yml
</code></pre></div><p>Loadgen will run all the test cases specified in the configuration and output the test results:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ loadgen -config loadgen.yml
   __   ___  _      ___  ___   __    __
  / /  /___\/_\    /   \/ _ \ /__\/\ \ \
 / /  //  ///_\\  / /\ / /_\//_\ /  \/ /
/ /__/ \_//  _  \/ /_// /_\\//__/ /\  /
\____|___/\_/ \_/___,&#39;\____/\__/\_\ \/

[LOADGEN] A http load generator and testing suit.
[LOADGEN] 1.0.0_SNAPSHOT, 83f2cb9, Sun Jul 4 13:52:42 2021 +0800, medcl, support single item in dict files
[02-21 10:50:05] [INF] [app.go:192] initializing loadgen
[02-21 10:50:05] [INF] [app.go:193] using config: /Users/kassian/Workspace/infini/src/infini.sh/testing/suites/dev.yml
[02-21 10:50:05] [INF] [instance.go:78] workspace: /Users/kassian/Workspace/infini/src/infini.sh/testing/data/loadgen/nodes/cfpihf15k34iqhpd4d00
[02-21 10:50:05] [INF] [app.go:399] loadgen is up and running now.
[2023-02-21 10:50:05][TEST][SUCCESS] [setup/loadgen/cases/dummy] duration: 105(ms)

1 requests in 68.373875ms, 0.00bytes sent, 0.00bytes received

[Loadgen Client Metrics]
Requests/sec:   0.20
Request Traffic/sec:  0.00bytes
Total Transfer/sec: 0.00bytes
Avg Req Time:   5s
Fastest Request:  68.373875ms
Slowest Request:  68.373875ms
Number of Errors: 0
Number of Invalid:  0
Status 200:   1

[Estimated Server Metrics]
Requests/sec:   14.63
Transfer/sec:   0.00bytes
Avg Req Time:   68.373875ms


[2023-02-21 10:50:06][TEST][FAILED] [setup/gateway/cases/echo/echo_with_context/] duration: 1274(ms)
#0 request, GET http://$[[env.LR_GATEWAY_HOST]]/any/, assertion failed, skiping subsequent requests
1 requests in 1.255678s, 0.00bytes sent, 0.00bytes received

[Loadgen Client Metrics]
Requests/sec:   0.20
Request Traffic/sec:  0.00bytes
Total Transfer/sec: 0.00bytes
Avg Req Time:   5s
Fastest Request:  1.255678s
Slowest Request:  1.255678s
Number of Errors: 1
Number of Invalid:  1
Status 0:   1

[Estimated Server Metrics]
Requests/sec:   0.80
Transfer/sec:   0.00bytes
Avg Req Time:   1.255678s

</code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/loadgen/main/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li class=active><a href=/loadgen/main/ class="flex align-center"><img src=/loadgen/main/svg/translate.svg class=book-icon alt=Languages>
English</a></li><li><a href=/loadgen/main/zh/docs/getting-started/benchmark/ class="flex align-center"><img src=/loadgen/main/svg/translate.svg class=book-icon alt=Languages>
简体中文</a></li></ul></div><div><a class="flex align-center" href=https://github.com/infinilabs/loadgen/edit/main/docs/content.en/docs/getting-started/benchmark.md target=_blank rel=noopener><img src=/loadgen/main/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script>(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:2567416,hjsv:6};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RJPTVP614C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-RJPTVP614C');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div><script type=module>
    import { searchbox } from "https://coco.infini.cloud/integration/cvn0g9ehpcehvsthrakg/widget";
    searchbox({container: "#searchbox"});
</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#benchmark-testing>Benchmark Testing</a><ul><li><a href=#loadgen>Loadgen</a><ul><li><a href=#running-mode-settings>Running Mode Settings</a></li><li><a href=#http-header-handling>HTTP Header Handling</a></li></ul></li><li><a href=#usage-of-variables>Usage of Variables</a><ul><li><a href=#variable-usage-example>Variable Usage Example</a></li><li><a href=#environment-variables>Environment Variables</a></li></ul></li><li><a href=#request-definition>Request Definition</a><ul><li><a href=#simulating-bulk-ingestion>Simulating Bulk Ingestion</a></li><li><a href=#response-assertions>Response Assertions</a></li><li><a href=#dynamic-variable-registration>Dynamic Variable Registration</a></li></ul></li><li><a href=#running-the-benchmark>Running the Benchmark</a><ul><li><a href=#command-line-parameters>Command Line Parameters</a></li><li><a href=#limiting-client-workload>Limiting Client Workload</a></li><li><a href=#limiting-the-total-number-of-requests>Limiting the Total Number of Requests</a></li><li><a href=#using-auto-incremental-ids-to-ensure-the-document-sequence>Using Auto Incremental IDs to Ensure the Document Sequence</a></li><li><a href=#reuse-variables-in-request-context>Reuse Variables in Request Context</a></li><li><a href=#customize-header>Customize Header</a></li></ul></li><li><a href=#running-test-suites>Running Test Suites</a><ul><li><a href=#environment-variables-configuration>Environment Variables Configuration</a></li><li><a href=#test-case-configuration>Test Case Configuration</a></li><li><a href=#running-test-suites-1>Running Test Suites</a></li></ul></li></ul></li></ul></nav></aside></main></body></html>