<!doctype html><html lang=zh><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="管道聚合 #  使用管道聚合，可以通过将一个聚合的结果作为输入管道传输到另一个聚合来链接聚合，以获得更细微的输出。
可以使用管道聚合来计算复杂的统计和数学度量值，如导数、移动平均值、累积总和等。
管道聚合语法 #  管道聚合使用 buckets_path 属性访问其他聚合的结果。 buckets_path 属性具有特定的语法：
buckets_path = <AGG_NAME>[<AGG_SEPARATOR>,<AGG_NAME>]*[<METRIC_SEPARATOR>, <METRIC>]; 分别是:
 AGG_NAME 是聚合的名称。 AGG_SEPARATOR 分隔聚合，表示为 > 。 METRIC_SEPARATOR 将聚合与 metrics 分开，表示为 . 。 METRIC 指标名称，如果是多值指标聚合。  例如，my_sum.sum 选择名为 my_sum 的聚合的 sum 指标。popular_tags>my_sum.sum 将 my_sum.sum 嵌套到 popular_tags 聚合中。
您还可以指定以下附加参数：
 gap_policy: 真实世界数据可以包含间隙或空值。您可以使用 gap_policy 属性指定处理此类丢失数据的策略。您可以将 gap_policy 属性设置为 skip ，以跳过丢失的数据并从下一个可用值继续，或将 insert_zeros 设置为零，以将丢失的值替换为零并继续运行。 format: 输出值的格式类型。例如，yyyy-MM-dd 表示日期值。  样例 #  要对 sum_total_memory 聚合返回的所有存储桶求和，请执行以下操作：
GET kibana_sample_data_logs/_search { &#34;size&#34;: 0, &#34;aggs&#34;: { &#34;number_of_bytes&#34;: { &#34;histogram&#34;: { &#34;field&#34;: &#34;bytes&#34;, &#34;interval&#34;: 10000 }, &#34;aggs&#34;: { &#34;sum_total_memory&#34;: { &#34;sum&#34;: { &#34;field&#34;: &#34;phpmemory&#34; } } } }, &#34;sum_copies&#34;: { &#34;sum_bucket&#34;: { &#34;buckets_path&#34;: &#34;number_of_bytes>sum_total_memory&#34; } } } } 返回示例 #  ."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="管道聚合"><meta property="og:description" content="管道聚合 #  使用管道聚合，可以通过将一个聚合的结果作为输入管道传输到另一个聚合来链接聚合，以获得更细微的输出。
可以使用管道聚合来计算复杂的统计和数学度量值，如导数、移动平均值、累积总和等。
管道聚合语法 #  管道聚合使用 buckets_path 属性访问其他聚合的结果。 buckets_path 属性具有特定的语法：
buckets_path = <AGG_NAME>[<AGG_SEPARATOR>,<AGG_NAME>]*[<METRIC_SEPARATOR>, <METRIC>]; 分别是:
 AGG_NAME 是聚合的名称。 AGG_SEPARATOR 分隔聚合，表示为 > 。 METRIC_SEPARATOR 将聚合与 metrics 分开，表示为 . 。 METRIC 指标名称，如果是多值指标聚合。  例如，my_sum.sum 选择名为 my_sum 的聚合的 sum 指标。popular_tags>my_sum.sum 将 my_sum.sum 嵌套到 popular_tags 聚合中。
您还可以指定以下附加参数：
 gap_policy: 真实世界数据可以包含间隙或空值。您可以使用 gap_policy 属性指定处理此类丢失数据的策略。您可以将 gap_policy 属性设置为 skip ，以跳过丢失的数据并从下一个可用值继续，或将 insert_zeros 设置为零，以将丢失的值替换为零并继续运行。 format: 输出值的格式类型。例如，yyyy-MM-dd 表示日期值。  样例 #  要对 sum_total_memory 聚合返回的所有存储桶求和，请执行以下操作：
GET kibana_sample_data_logs/_search { &#34;size&#34;: 0, &#34;aggs&#34;: { &#34;number_of_bytes&#34;: { &#34;histogram&#34;: { &#34;field&#34;: &#34;bytes&#34;, &#34;interval&#34;: 10000 }, &#34;aggs&#34;: { &#34;sum_total_memory&#34;: { &#34;sum&#34;: { &#34;field&#34;: &#34;phpmemory&#34; } } } }, &#34;sum_copies&#34;: { &#34;sum_bucket&#34;: { &#34;buckets_path&#34;: &#34;number_of_bytes>sum_total_memory&#34; } } } } 返回示例 #  ."><meta property="og:type" content="article"><meta property="og:url" content="/easysearch/v1.12.2/docs/references/aggregation/pipeline-agg/"><title>管道聚合 | INFINI Easysearch</title><link rel=manifest href=/easysearch/v1.12.2/manifest.json><link rel=icon href=/easysearch/v1.12.2/favicon.png type=image/x-icon><link rel=stylesheet href=/easysearch/v1.12.2/book.min.d80e87b12a4b49d9913d0bdd98bd83b7a44988be784760ba15522b377313dcf9.css integrity="sha256-2A6HsSpLSdmRPQvdmL2Dt6RJiL54R2C6FVIrN3MT3Pk="><link rel=stylesheet type=text/css href=/easysearch/v1.12.2/css/asciinema-player.css><script defer src=/easysearch/v1.12.2/js/jquery-2.x.min.js></script><script defer src=/easysearch/v1.12.2/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/easysearch/v1.12.2><img src=/easysearch/v1.12.2/img/logo-zh.svg alt=Logo></a></h2><div id=searchbox style=margin-bottom:10px;outline:none></div><div class=heading><select class=version-selector>
<option value>main (latest)</option>
<option value=v1.12.2>v1.12.2</option>
<option value=v1.12.1>v1.12.1</option>
<option value=v1.12.0>v1.12.0</option>
<option value=v1.11.1>v1.11.1</option>
<option value=v1.11.0>v1.11.0</option>
<option value=v1.9.1>v1.9.1</option>
<option value=v1.8.3>v1.8.3</option>
<option value=v1.8.2>v1.8.2</option>
<option value=v1.8.0>v1.8.0</option>
<option value=v1.7.1>v1.7.1</option>
<option value=v1.7.0>v1.7.0</option>
<option value=v1.6.2>v1.6.2</option>
<option value=v1.6.1>v1.6.1</option>
<option value=v1.6.0>v1.6.0</option>
<option value=v1.5.0>v1.5.0</option>
<option value=v1.4.0>v1.4.0</option>
<option value=v1.3.0>v1.3.0</option>
<option value=v1.2.0>v1.2.0</option>
<option value=v1.1.1>v1.1.1</option>
<option value=v1.1.0>v1.1.0</option>
<option value=v1.0.1>v1.0.1</option>
<option value=v1.0.0>v1.0.0</option></select></div><ul><li><a href=/easysearch/v1.12.2/docs/overview/>产品概述</a><ul></ul></li><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>入门指南</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-e622c8a7dea0dd02f82a836e861475c5 class=toggle>
<label for=section-e622c8a7dea0dd02f82a836e861475c5 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/getting-started/install/>安装指南</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/getting-started/install/docker/>Docker</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/docker-compose/>Docker Compose</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/helm/>Helm Chart</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/linux/>Linux</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/windows/>Windows</a></li><li><input type=checkbox id=section-8df7e740f0b8d44e94e2d5f3851aef83 class=toggle>
<label for=section-8df7e740f0b8d44e94e2d5f3851aef83 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/>Operator</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/deploy_operator/>部署 Operator</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/deploy_easysearch/>部署 Easysearch</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/resource_manager/>资源扩容</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/node_scale/>节点扩容</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/update_password/>密码修改</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/upgrade/>版本升级</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/cert_manager/>证书管理</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/s3_snapshot/>s3 备份</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/install/operator/FAQ/>FAQ</a></li></ul></li></ul></li><li><a href=/easysearch/v1.12.2/docs/getting-started/settings/>系统调优</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/configuration/>常用配置</a></li><li><a href=/easysearch/v1.12.2/docs/getting-started/configuration_file/>配置说明</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle checked>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a>功能手册</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-dd5a2f6dc33fa990f542566f7a908106 class=toggle>
<label for=section-dd5a2f6dc33fa990f542566f7a908106 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/>文档建模</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-7d4ce65a4422588ac64ff568cfa9eb9e class=toggle>
<label for=section-7d4ce65a4422588ac64ff568cfa9eb9e class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/>文档映射</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/analyzer/>分词器参数</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/dynamic/>动态映射参数</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/copy_to/>字段复制参数</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/coerce/>强制类型转换参数</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/doc_values/>文档列值参数</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/enabled/>是否启用参数</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/mapping-parameters/boost/>权重参数设置</a></li></ul></li><li><input type=checkbox id=section-f879c6c2aa847411ec53259bcf512a91 class=toggle>
<label for=section-f879c6c2aa847411ec53259bcf512a91 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/>字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/rank/>Rank 字段类型</a></li><li><input type=checkbox id=section-cd8ebeffb1e1eb5dcc529f4edbad93fc class=toggle>
<label for=section-cd8ebeffb1e1eb5dcc529f4edbad93fc class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/geo-filed-type/>地理字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/geo-filed-type/geo-point/>Geopoint 地理点字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/geo-filed-type/geo-shape/>Geoshape 地理形状字段类型</a></li></ul></li><li><input type=checkbox id=section-f94b121fac5f49bed5028d50034cc3cf class=toggle>
<label for=section-f94b121fac5f49bed5028d50034cc3cf class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/string-field-type/>字符串字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/string-field-type/keyword/>Keyword 字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/string-field-type/text/>Text 字段类型</a></li></ul></li><li><input type=checkbox id=section-37ac2b2e61a91ff3354b11d860ec66cf class=toggle>
<label for=section-37ac2b2e61a91ff3354b11d860ec66cf class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/object-field-type/>对象字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/object-field-type/flattened/>Flat 对象字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/object-field-type/flattened_text/>Flat 对象字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/object-field-type/join/>Join 字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/object-field-type/nested/>Nested 字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/object-field-type/object/>Object 对象字段类型</a></li></ul></li><li><input type=checkbox id=section-4f4e977370cb5a089a66f2d06c0cf2fc class=toggle>
<label for=section-4f4e977370cb5a089a66f2d06c0cf2fc class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/date-field-type/>日期字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/date-field-type/date-nanos/>Date nanoseconds 字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/date-field-type/date/>Date 字段类型</a></li></ul></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/ip/>IP 地址字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/match_only_text/>match_only_text 字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/percolator/>Percolator 过滤器字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/binary/>二进制字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/alias/>别名字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/knn/>向量字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/boolean/>布尔字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/numeric-field/>数值字段类型</a></li><li><input type=checkbox id=section-d087fbeb67c721ac6618bf4ae5f3be20 class=toggle>
<label for=section-d087fbeb67c721ac6618bf4ae5f3be20 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/autocomplete-field-type/>自动补全字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/autocomplete-field-type/search-as-you-type/>Search-as-you-type 字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/autocomplete-field-type/completion/>自动补全字段类型</a></li></ul></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/range-field-type/>范围字段类型</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/field-types/wildcard/>Wildcard 字段类型</a></li></ul></li><li><input type=checkbox id=section-92a866d9a34e707f209ba1cdbeaba985 class=toggle>
<label for=section-92a866d9a34e707f209ba1cdbeaba985 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/>元数据字段</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/id/>ID 属性</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/meta/>元数据属性</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/field-names/>字段名称</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/ignored/>忽略属性</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/source/>源文档属性</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/>索引属性</a></li><li><a href=/easysearch/v1.12.2/docs/references/mappings-and-field-types/metadata-field/routing/>路由属性</a></li></ul></li></ul></li><li><input type=checkbox id=section-232f0668f3be6ea64e1c220baec34dfc class=toggle>
<label for=section-232f0668f3be6ea64e1c220baec34dfc class="flex justify-between"><a>文档操作</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/document/index-data/>增删改查</a></li><li><a href=/easysearch/v1.12.2/docs/references/document/index-alias/>别名操作</a></li><li><a href=/easysearch/v1.12.2/docs/references/document/index-compression/>索引压缩</a></li></ul></li><li><input type=checkbox id=section-6b02990358c7382bac3f39043e5fd437 class=toggle>
<label for=section-6b02990358c7382bac3f39043e5fd437 class="flex justify-between"><a>搜索操作</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/search/term/>词项查询</a></li><li><a href=/easysearch/v1.12.2/docs/references/search/full-text/>全文查询</a></li><li><a href=/easysearch/v1.12.2/docs/references/search/knn_api/>向量查询</a></li><li><a href=/easysearch/v1.12.2/docs/references/search/bool/>布尔查询</a></li><li><a href=/easysearch/v1.12.2/docs/references/search/search-template/>查询模版</a></li><li><a href=/easysearch/v1.12.2/docs/references/search/async_search/>异步搜索</a></li><li><a href=/easysearch/v1.12.2/docs/references/search/pit_api/>定点查询</a></li></ul></li><li><input type=checkbox id=section-69a0462c4990a8b0bf6189289fb56e8a class=toggle checked>
<label for=section-69a0462c4990a8b0bf6189289fb56e8a class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/aggregation/>聚合操作</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/aggregation/metric-agg/>指标聚合</a></li><li><a href=/easysearch/v1.12.2/docs/references/aggregation/bucket-agg/>分桶聚合</a></li><li><a href=/easysearch/v1.12.2/docs/references/aggregation/pipeline-agg/ class=active>管道聚合</a></li></ul></li><li><input type=checkbox id=section-86e828ca7e30e9d2e35881b956319411 class=toggle>
<label for=section-86e828ca7e30e9d2e35881b956319411 class="flex justify-between"><a>SQL 查询</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/sql/sql-jdbc/>SQL-JDBC</a></li><li><a href=/easysearch/v1.12.2/docs/references/sql/aggregations/>聚合查询</a></li><li><a href=/easysearch/v1.12.2/docs/references/sql/fulltext/>全文搜索</a></li><li><a href=/easysearch/v1.12.2/docs/references/sql/complex/>复杂查询</a></li><li><a href=/easysearch/v1.12.2/docs/references/sql/basics/>基础查询</a></li></ul></li><li><input type=checkbox id=section-1c80046b8a7d2b6f02509e78096b1388 class=toggle>
<label for=section-1c80046b8a7d2b6f02509e78096b1388 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/security/>安全模块</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-4c0acfad57ce0b1db83571ad903a192e class=toggle>
<label for=section-4c0acfad57ce0b1db83571ad903a192e class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/security/configuration/>配置说明</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/security/configuration/yaml/>本地配置</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/configuration/backend/>后端配置</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/configuration/tls/>证书配置</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/configuration/system-indices/>系统索引</a></li></ul></li><li><input type=checkbox id=section-4854412a16ac224d9851d23b7bf6bdea class=toggle>
<label for=section-4854412a16ac224d9851d23b7bf6bdea class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/security/access-control/>权限控制</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/users-roles/>用户角色</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/document-level-security/>文档权限</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/field-level-security/>字段权限</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/field-masking/>数据脱敏</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/run-as/>身份模拟</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/cross-cluster-search/>跨集群搜索</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/api/>API 接口</a></li><li><a href=/easysearch/v1.12.2/docs/references/security/access-control/permissions/>权限列表</a></li></ul></li></ul></li><li><input type=checkbox id=section-4632348aa5cba7d33c080167da2f13b6 class=toggle>
<label for=section-4632348aa5cba7d33c080167da2f13b6 class="flex justify-between"><a>文本分词</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-13c9df598f113d7537eff14f9f5147e3 class=toggle>
<label for=section-13c9df598f113d7537eff14f9f5147e3 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/>分词器</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/ik-analyzer/>IK 分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/stop-analyzer/>停用词分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/keyword-analyzer/>关键词分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/creating-a-custom-analyzer/>创建一个自定义分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/pattern-analyzer/>匹配模式分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/language-analyzer/>各类语种分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/fingerprint-analyzer/>指纹分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/search-analyzers/>搜索分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/standard-analyzer/>标准分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/whitespace-analyzer/>空格分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/simple-analyzer/>简单分词器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/analyzers/index-analyzers/>索引分词器</a></li></ul></li><li><input type=checkbox id=section-8066f3918cdd51465da4720002ab0bb5 class=toggle>
<label for=section-8066f3918cdd51465da4720002ab0bb5 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/>分词过滤器</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/ascii-folding/>ASCII 折叠分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/cjk-bigram/>CJK 二元分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/cjk-width/>CJK 宽度分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/kstem/>KStem 分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/kuromoji-completion/>Kuromoji 补全分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/n-gram/>n-gram 分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/keep-types/>保留类型分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/trim/>修剪词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/stop/>停用词词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/keyword-marker/>关键词标记分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/keyword-repeat/>关键词重复分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/delimited-payload/>分隔式负载分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/pattern-replace/>匹配替换词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/decimal-digit/>十进制数字分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/word-delimiter-graph/>单词分隔符图词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/word-delimiter/>单词分隔符词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/remove-duplicates/>去重词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/reverse/>反转词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/synonym-graph/>同义词图词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/synonym/>同义词词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/unique/>唯一词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/multiplexer/>多路复用分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/uppercase/>大写词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/lowercase/>小写分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/common-grams/>常用词组分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/flatten-graph/>平图化分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/normalization/>归一化词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/truncate/>截断词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/fingerprint/>指纹分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/pattern-capture/>捕获匹配词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/min-hash/>最小哈希分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/condition/>条件分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/porter-stem/>波特词干词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/apostrophe/>省略符号分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/elision/>省略词分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/classic/>经典分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/keep-words/>词保留分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/dictionary-decompounder/>词典复合词分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/stemmer/>词干提取词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/stemmer-override/>词干覆盖词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/shingle/>词片词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/predicate-token-filter/>谓词词元过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/edge-n-gram/>边缘 n 元分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/length/>长度分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/limit/>限制分词过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/token-filters/snowball/>雪球算法词元过滤器</a></li></ul></li><li><input type=checkbox id=section-d6e4a0d07abe0df202540482628fd24b class=toggle>
<label for=section-d6e4a0d07abe0df202540482628fd24b class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/text-analysis/character-filters/>字符过滤器</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/character-filters/html-strip/>HTML 剥离字符过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/character-filters/pattern-replace/>匹配替换字符过滤器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/character-filters/mapping/>映射字符过滤器</a></li></ul></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/normalizers/>规范化</a></li><li><input type=checkbox id=section-71b540c4dd821da562660864e8601756 class=toggle>
<label for=section-71b540c4dd821da562660864e8601756 class="flex justify-between"><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/>词元生成器</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/n-gram/>N-gram 词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/uax-url-email/>UAX URL 邮件词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/keyword/>关键词词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/edge-n-gram/>前缀 n 元词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/pattern/>匹配词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/letter/>字母词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/character-group/>字符组词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/lowercase/>小写词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/standard/>标准词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/whitespace/>空格词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/simple-pattern-split/>简单分割匹配词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/classic/>经典词元生成器</a></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/tokenizers/path-hierarchy/>路径词元分词器</a></li></ul></li><li><a href=/easysearch/v1.12.2/docs/references/text-analysis/stemming/>词干提取</a></li></ul></li><li><input type=checkbox id=section-52d7e2e9abce80d3dc7a6a56a0089b77 class=toggle>
<label for=section-52d7e2e9abce80d3dc7a6a56a0089b77 class="flex justify-between"><a>管理模块</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/management/cluster/>搭建集群</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/catapis/>CAT API</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/logs/>系统日志</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/index-templates/>索引模板</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/reindex-data/>重建数据</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/tasksapis/>任务管理</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/slm_api/>快照生命周期管理</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/ilm_api/>索引生命周期管理</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/ccr_api/>跨集群复制</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/snapshot-restore/>备份还原</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/throttling/>写入限流</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/searchable_snapshot/>可搜索快照</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/time-series-Index-optimization/>使用时间范围合并策略优化时序索引</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/rollup_api/>数据汇总</a></li><li><a href=/easysearch/v1.12.2/docs/references/management/popular-api/>其它常用 API</a></li></ul></li><li><input type=checkbox id=section-b34adbce31bce6650a0099282b315617 class=toggle>
<label for=section-b34adbce31bce6650a0099282b315617 class="flex justify-between"><a>客户端</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/client/java-client/>快速开始</a></li><li><a href=/easysearch/v1.12.2/docs/references/client/client-api/>API 使用</a></li></ul></li><li><input type=checkbox id=section-c1faee20470feef7857c444179fe54aa class=toggle>
<label for=section-c1faee20470feef7857c444179fe54aa class="flex justify-between"><a>AI 集成</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/references/AI-Integration/text-embeddings/>文本向量化</a></li></ul></li></ul></li><li><input type=checkbox id=section-1adc738e7351809ea378ec7e9730bd1f class=toggle>
<label for=section-1adc738e7351809ea378ec7e9730bd1f class="flex justify-between"><a>版本历史</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.12.2/docs/release-notes/client/>Easysearch-client</a></li><li><a href=/easysearch/v1.12.2/docs/release-notes/easysearch/>Easysearch</a></li></ul></li><li><a href=/easysearch/v1.12.2/docs/resources/>其它资源</a><ul></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/easysearch/v1.12.2/svg/menu.svg class=book-icon alt=Menu></label>
<strong>管道聚合</strong>
<label for=toc-control><img src=/easysearch/v1.12.2/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#管道聚合>管道聚合</a><ul><li><a href=#管道聚合语法>管道聚合语法</a></li><li><a href=#样例>样例</a><ul><li></li></ul></li><li><a href=#管道聚合类型>管道聚合类型</a><ul><li><a href=#同级聚合>同级聚合</a></li><li><a href=#父级聚合>父级聚合</a></li></ul></li><li><a href=#avg_bucket-sum_bucket-min_bucket-max_bucket>avg_bucket, sum_bucket, min_bucket, max_bucket</a><ul><li></li></ul></li><li><a href=#stats_bucket-extended_stats_bucket>stats_bucket, extended_stats_bucket</a><ul><li></li></ul></li><li><a href=#bucket_script-bucket_selector>bucket_script, bucket_selector</a><ul><li></li></ul></li><li><a href=#bucket_sort>bucket_sort</a><ul><li></li></ul></li><li><a href=#cumulative_sum>cumulative_sum</a><ul><li></li></ul></li><li><a href=#derivative>derivative</a><ul><li></li></ul></li><li><a href=#moving_avg>moving_avg</a><ul><li></li></ul></li><li><a href=#serial_diff>serial_diff</a><ul><li></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=管道聚合>管道聚合
<a class=anchor href=#%e7%ae%a1%e9%81%93%e8%81%9a%e5%90%88>#</a></h1><p>使用管道聚合，可以通过将一个聚合的结果作为输入管道传输到另一个聚合来链接聚合，以获得更细微的输出。</p><p>可以使用管道聚合来计算复杂的统计和数学度量值，如导数、移动平均值、累积总和等。</p><h2 id=管道聚合语法>管道聚合语法
<a class=anchor href=#%e7%ae%a1%e9%81%93%e8%81%9a%e5%90%88%e8%af%ad%e6%b3%95>#</a></h2><p>管道聚合使用 <code>buckets_path</code> 属性访问其他聚合的结果。
<code>buckets_path</code> 属性具有特定的语法：</p><pre><code>buckets_path = &lt;AGG_NAME&gt;[&lt;AGG_SEPARATOR&gt;,&lt;AGG_NAME&gt;]*[&lt;METRIC_SEPARATOR&gt;, &lt;METRIC&gt;];
</code></pre><p>分别是:</p><ul><li><code>AGG_NAME</code> 是聚合的名称。</li><li><code>AGG_SEPARATOR</code> 分隔聚合，表示为 <code>></code> 。</li><li><code>METRIC_SEPARATOR</code> 将聚合与 metrics 分开，表示为 <code>.</code> 。</li><li><code>METRIC</code> 指标名称，如果是多值指标聚合。</li></ul><p>例如，<code>my_sum.sum</code> 选择名为 <code>my_sum</code> 的聚合的 <code>sum</code> 指标。<code>popular_tags>my_sum.sum</code> 将 <code>my_sum.sum</code> 嵌套到 <code>popular_tags</code> 聚合中。</p><p>您还可以指定以下附加参数：</p><ul><li><code>gap_policy</code>: 真实世界数据可以包含间隙或空值。您可以使用 <code>gap_policy</code> 属性指定处理此类丢失数据的策略。您可以将 <code>gap_policy</code> 属性设置为 <code>skip</code> ，以跳过丢失的数据并从下一个可用值继续，或将 <code>insert_zeros</code> 设置为零，以将丢失的值替换为零并继续运行。</li><li><code>format</code>: 输出值的格式类型。例如，<code>yyyy-MM-dd</code> 表示日期值。</li></ul><h2 id=样例>样例
<a class=anchor href=#%e6%a0%b7%e4%be%8b>#</a></h2><p>要对 <code>sum_total_memory</code> 聚合返回的所有存储桶求和，请执行以下操作：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;number_of_bytes&#34;</span>: {
      <span style=color:#f92672>&#34;histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>,
        <span style=color:#f92672>&#34;interval&#34;</span>: <span style=color:#ae81ff>10000</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_total_memory&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;phpmemory&#34;</span>
          }
        }
      }
    },
    <span style=color:#f92672>&#34;sum_copies&#34;</span>: {
      <span style=color:#f92672>&#34;sum_bucket&#34;</span>: {
        <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;number_of_bytes&gt;sum_total_memory&#34;</span>
      }
    }
  }
}
</code></pre></div><h4 id=返回示例>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>0.0</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>13372</span>,
        <span style=color:#f92672>&#34;sum_total_memory&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9.12664E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>10000.0</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>702</span>,
        <span style=color:#f92672>&#34;sum_total_memory&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>0.0</span>
        }
      }
    ]
  },
  <span style=color:#f92672>&#34;sum_copies&#34;</span> : {
    <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9.12664E7</span>
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><h2 id=管道聚合类型>管道聚合类型
<a class=anchor href=#%e7%ae%a1%e9%81%93%e8%81%9a%e5%90%88%e7%b1%bb%e5%9e%8b>#</a></h2><p>管道聚合有两种类型：</p><h3 id=同级聚合>同级聚合
<a class=anchor href=#%e5%90%8c%e7%ba%a7%e8%81%9a%e5%90%88>#</a></h3><p>同级聚合接受嵌套聚合的输出，并在与嵌套桶相同的级别上生成新桶或新聚合。</p><p>同级聚合必须是多存储桶聚合（特定字段具有多个分组值），并且指标必须是数值。</p><p><code>min_bucket</code> , <code>max_bucket</code> , <code>sum_bucket</code> , and <code>avg_bucket</code> 是常用的同级聚合。</p><h3 id=父级聚合>父级聚合
<a class=anchor href=#%e7%88%b6%e7%ba%a7%e8%81%9a%e5%90%88>#</a></h3><p>父聚合采用外部聚合的输出，并在与现有存储桶相同的级别生成新存储桶或新聚合。</p><p>父聚合必须将 <code>min_doc_count</code> 设置为 0 （ <code>histogram</code> 聚合的默认值），并且指定的度量必须是数值。如果 <code>min_doc_count</code> 大于 <code>0</code> ，则会忽略某些存储桶，这可能会导致错误的结果。</p><p><code>derivatives</code> 和 <code>cumulative_sum</code> 是常见的父聚合。</p><h2 id=avg_bucket-sum_bucket-min_bucket-max_bucket>avg_bucket, sum_bucket, min_bucket, max_bucket
<a class=anchor href=#avg_bucket-sum_bucket-min_bucket-max_bucket>#</a></h2><p><code>avg_bucket</code> 、 <code>sum_bucket</code> 、 <code>min_bucket</code> 和 <code>max_bucket</code> 聚合是同级聚合，用于计算上一个聚合的每个存储桶中指标的平均值、总和、最小值和最大值。</p><p>下面的示例创建一个间隔为一个月的日期直方图。 <code>sum</code> 子聚合计算每个月所有字节的总和。最后， <code>avg_bucket</code> 聚合使用此总和来计算每月的平均字节数：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;visits_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        }
      }
    },
    <span style=color:#f92672>&#34;avg_monthly_bytes&#34;</span>: {
      <span style=color:#f92672>&#34;avg_bucket&#34;</span>: {
        <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;visits_per_month&gt;sum_of_bytes&#34;</span>
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-1>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-1>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;visits_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        }
      }
    ]
  },
  <span style=color:#f92672>&#34;avg_monthly_bytes&#34;</span> : {
    <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>以类似的方式，您可以计算每月字节数的 <code>sum_bucket</code> 、 <code>min_bucket</code> 和 <code>max_bucket</code> 值。</p><h2 id=stats_bucket-extended_stats_bucket>stats_bucket, extended_stats_bucket
<a class=anchor href=#stats_bucket-extended_stats_bucket>#</a></h2><p>聚合是一个同级聚合，它返回前一个聚合的存储桶的各种统计信息（<code>count</code> , <code>min</code> , <code>max</code> , <code>avg</code> , <code>sum</code> ）。</p><p>以下示例返回嵌套在 <code>visits_per_month</code> 聚合中的 <code>sum_of_bytes</code> 聚合返回的存储桶的基本统计信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;visits_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        }
      }
    },
    <span style=color:#f92672>&#34;stats_monthly_bytes&#34;</span>: {
      <span style=color:#f92672>&#34;stats_bucket&#34;</span>: {
        <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;visits_per_month&gt;sum_of_bytes&#34;</span>
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-2>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-2>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;stats_monthly_bytes&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;count&#34;</span> : <span style=color:#ae81ff>3</span>,
  <span style=color:#f92672>&#34;min&#34;</span> : <span style=color:#ae81ff>9400200.0</span>,
  <span style=color:#f92672>&#34;max&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>,
  <span style=color:#f92672>&#34;avg&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>,
  <span style=color:#f92672>&#34;sum&#34;</span> : <span style=color:#ae81ff>7.9725689E7</span>
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p><code>extended_stats</code> 聚合是 <code>stats</code> 聚合的扩展版本。除了包括基本统计数据外， <code>extended_stats</code> 还提供 <code>sum_of_squares</code> 、 <code>variance</code> 和 <code>std_deviation</code> 等统计数据。</p><h4 id=返回示例-3>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-3>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;stats_monthly_visits&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;count&#34;</span> : <span style=color:#ae81ff>3</span>,
  <span style=color:#f92672>&#34;min&#34;</span> : <span style=color:#ae81ff>9400200.0</span>,
  <span style=color:#f92672>&#34;max&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>,
  <span style=color:#f92672>&#34;avg&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>,
  <span style=color:#f92672>&#34;sum&#34;</span> : <span style=color:#ae81ff>7.9725689E7</span>,
  <span style=color:#f92672>&#34;sum_of_squares&#34;</span> : <span style=color:#ae81ff>2.588843392021381E15</span>,
  <span style=color:#f92672>&#34;variance&#34;</span> : <span style=color:#ae81ff>1.5670496550438025E14</span>,
  <span style=color:#f92672>&#34;variance_population&#34;</span> : <span style=color:#ae81ff>1.5670496550438025E14</span>,
  <span style=color:#f92672>&#34;variance_sampling&#34;</span> : <span style=color:#ae81ff>2.3505744825657038E14</span>,
  <span style=color:#f92672>&#34;std_deviation&#34;</span> : <span style=color:#ae81ff>1.251818539183616E7</span>,
  <span style=color:#f92672>&#34;std_deviation_population&#34;</span> : <span style=color:#ae81ff>1.251818539183616E7</span>,
  <span style=color:#f92672>&#34;std_deviation_sampling&#34;</span> : <span style=color:#ae81ff>1.5331583357780447E7</span>,
  <span style=color:#f92672>&#34;std_deviation_bounds&#34;</span> : {
    <span style=color:#f92672>&#34;upper&#34;</span> : <span style=color:#ae81ff>5.161160045033899E7</span>,
    <span style=color:#f92672>&#34;lower&#34;</span> : <span style=color:#ae81ff>1538858.8829943463</span>,
    <span style=color:#f92672>&#34;upper_population&#34;</span> : <span style=color:#ae81ff>5.161160045033899E7</span>,
    <span style=color:#f92672>&#34;lower_population&#34;</span> : <span style=color:#ae81ff>1538858.8829943463</span>,
    <span style=color:#f92672>&#34;upper_sampling&#34;</span> : <span style=color:#ae81ff>5.723839638222756E7</span>,
    <span style=color:#f92672>&#34;lower_sampling&#34;</span> : <span style=color:#ae81ff>-4087937.0488942266</span>
   }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><h2 id=bucket_script-bucket_selector>bucket_script, bucket_selector
<a class=anchor href=#bucket_script-bucket_selector>#</a></h2><p><code>bucket_script</code> 聚合是一个父聚合，它通过脚本执行上一个聚合的每个桶的计算。确保指标为数值类型，并且返回的值也是数值。</p><p>使用 <code>script</code> 参数添加脚本。脚本可以是内联的、文件中的或索引中的。要启用内联脚本，请将以下行添加到 <code>config</code> 文件夹中的 <code>easysearch.yml</code> 文件中：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>script.inline</span>: <span style=color:#66d9ef>on</span>
</code></pre></div><p><code>buckets_path</code> 属性由多个条目组成。每个条目都是一个键和一个值。键是可在脚本中使用的值的名称。</p><p>基本语法为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;bucket_script&#34;</span>: {
    <span style=color:#f92672>&#34;buckets_path&#34;</span>: {
      <span style=color:#f92672>&#34;my_var1&#34;</span>: <span style=color:#e6db74>&#34;the_sum&#34;</span>,
      <span style=color:#f92672>&#34;my_var2&#34;</span>: <span style=color:#e6db74>&#34;the_value_count&#34;</span>
    },
    <span style=color:#f92672>&#34;script&#34;</span>: <span style=color:#e6db74>&#34;params.my_var1 / params.my_var2&#34;</span>
  }
}
</code></pre></div><p>以下示例对日期直方图生成的存储桶使用“sum”聚合。根据生成的存储桶值，RAM 的百分比在 zip 扩展的上下文中以 10， 000 字节的间隔计算：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;sales_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>,
        <span style=color:#f92672>&#34;interval&#34;</span>: <span style=color:#e6db74>&#34;10000&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;total_ram&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;machine.ram&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;ext-type&#34;</span>: {
          <span style=color:#f92672>&#34;filter&#34;</span>: {
            <span style=color:#f92672>&#34;term&#34;</span>: {
              <span style=color:#f92672>&#34;extension.keyword&#34;</span>: <span style=color:#e6db74>&#34;zip&#34;</span>
            }
          },
          <span style=color:#f92672>&#34;aggs&#34;</span>: {
            <span style=color:#f92672>&#34;total_ram&#34;</span>: {
              <span style=color:#f92672>&#34;sum&#34;</span>: {
                <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;machine.ram&#34;</span>
              }
            }
          }
        },
        <span style=color:#f92672>&#34;ram-percentage&#34;</span>: {
          <span style=color:#f92672>&#34;bucket_script&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: {
              <span style=color:#f92672>&#34;machineRam&#34;</span>: <span style=color:#e6db74>&#34;ext-type&gt;total_ram&#34;</span>,
              <span style=color:#f92672>&#34;totalRam&#34;</span>: <span style=color:#e6db74>&#34;total_ram&#34;</span>
            },
            <span style=color:#f92672>&#34;script&#34;</span>: <span style=color:#e6db74>&#34;params.machineRam / params.totalRam&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-4>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-4>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;sales_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>0.0</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>13372</span>,
        <span style=color:#f92672>&#34;os-type&#34;</span> : {
          <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1558</span>,
          <span style=color:#f92672>&#34;total_ram&#34;</span> : {
            <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.0090783268864E13</span>
          }
        },
        <span style=color:#f92672>&#34;total_ram&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>1.7214228922368E14</span>
        },
        <span style=color:#f92672>&#34;ram-percentage&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>0.11671032934131736</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>10000.0</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>702</span>,
        <span style=color:#f92672>&#34;os-type&#34;</span> : {
          <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>116</span>,
          <span style=color:#f92672>&#34;total_ram&#34;</span> : {
            <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>1.622423896064E12</span>
          }
        },
        <span style=color:#f92672>&#34;total_ram&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9.015136354304E12</span>
        },
        <span style=color:#f92672>&#34;ram-percentage&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>0.17996665078608862</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>RAM percentage 在每个存储桶的末尾计算并追加。</p><p><code>bucket_selector</code> 聚合是基于脚本的聚合，它选择由 <code>histogram</code> （或 <code>date_histogram</code> ）聚合返回的桶。在您不希望根据您提供的条件在输出中使用某些存储桶的情况下使用它。</p><p><code>bucket_selector</code> 聚合执行脚本，以确定 bucket 是否保留在父多存储桶聚合中。</p><p>基本语法为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;bucket_selector&#34;</span>: {
    <span style=color:#f92672>&#34;buckets_path&#34;</span>: {
      <span style=color:#f92672>&#34;my_var1&#34;</span>: <span style=color:#e6db74>&#34;the_sum&#34;</span>,
      <span style=color:#f92672>&#34;my_var2&#34;</span>: <span style=color:#e6db74>&#34;the_value_count&#34;</span>
    },
    <span style=color:#f92672>&#34;script&#34;</span>: <span style=color:#e6db74>&#34;params.my_var1 / params.my_var2&#34;</span>
  }
}
</code></pre></div><p>下面的示例计算字节的总和，然后计算此总和是否大于 20,000。如果为 true，则存储桶将保留在存储桶列表中。否则，它将从最终输出中删除。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;bytes_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;total_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;bytes_bucket_filter&#34;</span>: {
          <span style=color:#f92672>&#34;bucket_selector&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: {
              <span style=color:#f92672>&#34;totalBytes&#34;</span>: <span style=color:#e6db74>&#34;total_bytes&#34;</span>
            },
            <span style=color:#f92672>&#34;script&#34;</span>: <span style=color:#e6db74>&#34;params.totalBytes &gt; 20000&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-5>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-5>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;bytes_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;total_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;total_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;total_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><h2 id=bucket_sort>bucket_sort
<a class=anchor href=#bucket_sort>#</a></h2><p>The <code>bucket_sort</code> 聚合是父聚合，用于对先前聚合的桶进行排序。</p><p>您可以指定多个排序字段以及相应的排序顺序。此外，您还可以根据每个存储桶的键、计数或其子聚合对每个存储桶进行排序。您还可以通过设置 <code>from</code> 和 <code>size</code> 参数来截断存储桶。</p><p>Syntax</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;bucket_sort&#34;</span>: {
    <span style=color:#f92672>&#34;sort&#34;</span>: [
      { <span style=color:#f92672>&#34;sort_field_1&#34;</span>: { <span style=color:#f92672>&#34;order&#34;</span>: <span style=color:#e6db74>&#34;asc&#34;</span> } },
      { <span style=color:#f92672>&#34;sort_field_2&#34;</span>: { <span style=color:#f92672>&#34;order&#34;</span>: <span style=color:#e6db74>&#34;desc&#34;</span> } },
      <span style=color:#e6db74>&#34;sort_field_3&#34;</span>
    ],
    <span style=color:#f92672>&#34;from&#34;</span>: <span style=color:#ae81ff>1</span>,
    <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>3</span>
  }
}
</code></pre></div><p>以下示例根据计算的 <code>total_sum</code> 值对 <code>date_histogram</code> 聚合的桶进行排序。我们按降序对桶进行排序，以便首先返回字节数最多的桶。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;sales_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;total_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;bytes_bucket_sort&#34;</span>: {
          <span style=color:#f92672>&#34;bucket_sort&#34;</span>: {
            <span style=color:#f92672>&#34;sort&#34;</span>: [
              { <span style=color:#f92672>&#34;total_bytes&#34;</span>: { <span style=color:#f92672>&#34;order&#34;</span>: <span style=color:#e6db74>&#34;desc&#34;</span> } }
            ],
            <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>3</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-6>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-6>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;sales_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;total_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;total_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;total_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>您还可以使用此聚合截断生成的桶而不进行排序。为此，只需使用 <code>from</code> 和 / 或 <code>size</code> 参数而不使用 <code>sort</code> 。</p><h2 id=cumulative_sum>cumulative_sum
<a class=anchor href=#cumulative_sum>#</a></h2><p><code>accumulate_sum</code> 聚合是一个父聚合，它计算上一个聚合的每个桶的累积和。</p><p>累积和是给定序列的部分和的序列。例如，序列 <code>{a，b，c,...}</code> 的累积和是 <code>a</code> ， <code>a+b</code> ， <code>a+b+c</code> 等等。您可以使用累积总和来可视化字段随时间的变化率。</p><p>以下示例计算每月的累积字节数：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;sales_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;no-of-bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;cumulative_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;cumulative_sum&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;no-of-bytes&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-7>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-7>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;sales_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;no-of-bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        },
        <span style=color:#f92672>&#34;cumulative_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;no-of-bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;cumulative_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>4.8280634E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;no-of-bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;cumulative_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>7.9725689E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><h2 id=derivative>derivative
<a class=anchor href=#derivative>#</a></h2><p>The <code>derivative</code> 聚合是一个父聚合，计算前一个聚合的每个桶的一阶和二阶衍生。</p><p>在数学中，一个函数的导数衡量其对变化的敏感性。换句话说，导数评估的是某个函数相对于某个变量的变化率。要了解更多关于导数的信息，请参阅[维基百科]（https://en.wikipedia.org/wiki/Derivative）。</p><p>你可以使用导数来计算数字值与它之前的时间段相比的变化率。</p><p>一阶导数表示一个指标是在增加还是减少，以及增加或减少的程度。</p><p>下面的例子计算了每个月的字节数之和的一阶导数。一阶导数是当前月的字节数与上月的字节数之差。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;sales_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;bytes_deriv&#34;</span>: {
          <span style=color:#f92672>&#34;derivative&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;number_of_bytes&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-8>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-8>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;sales_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;bytes_deriv&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.9480234E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;bytes_deriv&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>-7435379.0</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>二阶导数是一个双导数或导数的导数。
它表明一个量的变化率本身是如何变化的。它是相邻桶的一阶导数之差。</p><p>要计算二阶导数，要把一个导数聚合链到另一个。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;sales_per_month&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;bytes_deriv&#34;</span>: {
          <span style=color:#f92672>&#34;derivative&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;number_of_bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;bytes_2nd_deriv&#34;</span>: {
          <span style=color:#f92672>&#34;derivative&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;bytes_deriv&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-9>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-9>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;sales_per_month&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;bytes_deriv&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.9480234E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;number_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;bytes_deriv&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>-7435379.0</span>
        },
        <span style=color:#f92672>&#34;bytes_2nd_deriv&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>-3.6915613E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>第一个桶没有一阶导数，因为导数需要至少两个点进行比较。第一个和第二个桶没有二阶导数，因为二阶导数需要至少两个一阶导数的数据点。</p><p>&ldquo;2020-11-01&rdquo; 桶的一阶导数是 2.9480234E7，&ldquo;2020-12-01&rdquo; 桶是 -7435379。因此，&ldquo;2020-12-01&rdquo; 桶的二阶导数是 -3.6915613E7（-7435379-2.9480234E7）。</p><p>理论上，你可以继续用链式导数聚合来计算三阶、四阶，甚至更高阶的导数。然而，这对大多数数据集来说，几乎没有任何价值。</p><h2 id=moving_avg>moving_avg
<a class=anchor href=#moving_avg>#</a></h2><p>A <code>moving_avg</code> 聚合是一个计算移动平均指标的父聚合。</p><p>The <code>moving_avg</code> 聚合找到数据集的不同窗口（子集）的平均数系列。一个窗口的大小代表了每个迭代中窗口所覆盖的数据点的数量（由 <code>window</code> 属性指定，默认设置为 5）。在每次迭代中，算法计算适合窗口的所有数据点的平均值，然后通过排除前一个窗口的第一个成员并包括下一个窗口的第一个成员来向前滑动。</p><p>例如，给定数据 <code>[1, 5, 8, 23, 34, 28, 7, 23, 20, 19]</code> ，你可以计算出窗口大小为 5 的简单移动平均线，如下所示。</p><pre><code>(1 + 5 + 8 + 23 + 34) / 5 = 14.2
(5 + 8 + 23 + 34+ 28) / 5 = 19.6
(8 + 23 + 34 + 28 + 7) / 5 = 20
so on...
</code></pre><p>更多信息，见
<a href=https://en.wikipedia.org/wiki/Moving_average>维基百科</a>。</p><p>你可以使用 <code>moving_avg</code> 聚合来平滑短期波动，或者突出时间序列数据中的长期趋势或周期。</p><p>指定一个紧跟数据的小窗口大小（例如， <code>window</code> ：10），以平滑小范围的波动。
或者，指定一个较大的窗口尺寸（例如， <code>window</code> ：100），滞后于实际数据很多，以平滑所有高频率的波动或随机噪音，使低频率的趋势更加明显。</p><p>下面的例子将一个 <code>moving_avg</code> 聚合嵌套到一个 <code>date_histogram</code> 聚合中。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;my_date_histogram&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: { <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span> }
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;moving_avg&#34;</span>: { <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;sum_of_bytes&#34;</span> }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-10>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-10>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;my_date_histogram&#34;</span> : {

    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.4140317E7</span>
        }
      }
    ]
  }
 }
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>你也可以使用 <code>moving_avg</code> 聚合来预测未来的桶。
要预测水桶，添加 <code>predict</code> 属性，并将其设置为你想看到的预测数量。</p><p>下面的例子在前面的查询中增加了五个预测值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;my_date_histogram&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;moving_avg&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;sum_of_bytes&#34;</span>,
            <span style=color:#f92672>&#34;predict&#34;</span>: <span style=color:#ae81ff>5</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-11>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-11>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;my_date_histogram&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.4140317E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2021-01-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1609459200000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2021-02-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1612137600000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2021-03-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1614556800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2021-04-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1617235200000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2021-05-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1619827200000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.6575229666666668E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p><code>moving_avg</code> 聚合支持五种模型 - <code>simple</code> , <code>linear</code> , <code>exponentially weighted</code> , <code>holt-linear</code> , 和 <code>holt-winters</code> 。这些模型的不同之处在于如何对窗口的值进行加权。随着数据点变得 &ldquo;older&rdquo;（即窗口从它们身上滑过），它们的权重可能不同。你可以通过设置 <code>model</code> 属性来指定你选择的模型。 <code>model</code> 属性持有模型的名称和 <code>settings</code> 对象，你可以用它来提供模型属性。关于这些模型的更多信息，请参阅
<a href=https://en.wikipedia.org/wiki/Moving_average>Wikipedia</a>。</p><p>一个 <code>simple</code> 模型首先计算窗口中所有数据点的总和，然后将这个总和除以窗口的大小。换句话说， <code>simple</code> 模型为你的数据集中的每个窗口计算一个简单的算术平均值。</p><p>下面的例子使用了一个窗口大小为 30 的简单模型。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;my_date_histogram&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;moving_avg&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;sum_of_bytes&#34;</span>,
            <span style=color:#f92672>&#34;window&#34;</span>: <span style=color:#ae81ff>30</span>,
            <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#e6db74>&#34;simple&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-12>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-12>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;my_date_histogram&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.4140317E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>下面的例子使用了一个 <code>holt</code> 模型。你可以通过 <code>alpha</code> 和 <code>beta</code> 的设置来设置重要性衰减的速度。 <code>alpha</code> 的默认值是 0.3 ， <code>beta</code> 是 0.1 。你可以指定 0-1（含）之间的任何浮动值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
  <span style=color:#f92672>&#34;aggs&#34;</span>: {
    <span style=color:#f92672>&#34;my_date_histogram&#34;</span>: {
      <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
        <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
        <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
      },
      <span style=color:#f92672>&#34;aggs&#34;</span>: {
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;sum&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
          }
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span>: {
          <span style=color:#f92672>&#34;moving_avg&#34;</span>: {
            <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;sum_of_bytes&#34;</span>,
            <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#e6db74>&#34;holt&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
              <span style=color:#f92672>&#34;alpha&#34;</span>: <span style=color:#ae81ff>0.6</span>,
              <span style=color:#f92672>&#34;beta&#34;</span>: <span style=color:#ae81ff>0.4</span>
            }
          }
        }
      }
    }
  }
}
</code></pre></div><h4 id=返回示例-13>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-13>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;my_date_histogram&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        },
        <span style=color:#f92672>&#34;moving_avg_of_sum_of_bytes&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>2.70883404E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><h2 id=serial_diff>serial_diff
<a class=anchor href=#serial_diff>#</a></h2><p><code>serial_diff</code> 聚合是一个父管道聚合，它计算了一系列来自以前聚合的桶的时间滞后的值差异。</p><p>你可以使用 <code>serial_diff</code> 聚合来查找时间段之间的数据变化，而不是查找整个值。</p><p>通过 <code>lag</code> 参数（一个正的、非零的整数值），你可以告诉你要从当前的桶中减去哪个前一个桶。如果你不指定 <code>lag</code> 参数， Easysearch 将它设置为 1。</p><p>假设一个城市的人口随时间增长。如果你使用以一天为周期的序列差分聚合，你可以看到每天的增长。例如，你可以计算一个总价格的每周平均变化的一系列差值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>GET</span> <span style=color:#960050;background-color:#1e0010>kibana_sample_data_logs/_search</span>
{
   <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
   <span style=color:#f92672>&#34;aggs&#34;</span>: {
      <span style=color:#f92672>&#34;my_date_histogram&#34;</span>: {
         <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
            <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
            <span style=color:#f92672>&#34;calendar_interval&#34;</span>: <span style=color:#e6db74>&#34;month&#34;</span>
         },
         <span style=color:#f92672>&#34;aggs&#34;</span>: {
            <span style=color:#f92672>&#34;the_sum&#34;</span>: {
               <span style=color:#f92672>&#34;sum&#34;</span>: {
                  <span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;bytes&#34;</span>
               }
            },
            <span style=color:#f92672>&#34;thirtieth_difference&#34;</span>: {
               <span style=color:#f92672>&#34;serial_diff&#34;</span>: {
                  <span style=color:#f92672>&#34;buckets_path&#34;</span>: <span style=color:#e6db74>&#34;the_sum&#34;</span>,
                  <span style=color:#f92672>&#34;lag&#34;</span> : <span style=color:#ae81ff>30</span>
               }
            }
         }
      }
   }
}
</code></pre></div><h4 id=返回示例-14>返回示例
<a class=anchor href=#%e8%bf%94%e5%9b%9e%e7%a4%ba%e4%be%8b-14>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>...</span>
<span style=color:#e6db74>&#34;aggregations&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;my_date_histogram&#34;</span> : {
    <span style=color:#f92672>&#34;buckets&#34;</span> : [
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-10-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1601510400000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1635</span>,
        <span style=color:#f92672>&#34;the_sum&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>9400200.0</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-11-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1604188800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6844</span>,
        <span style=color:#f92672>&#34;the_sum&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.8880434E7</span>
        }
      },
      {
        <span style=color:#f92672>&#34;key_as_string&#34;</span> : <span style=color:#e6db74>&#34;2020-12-01T00:00:00.000Z&#34;</span>,
        <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>1606780800000</span>,
        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>5595</span>,
        <span style=color:#f92672>&#34;the_sum&#34;</span> : {
          <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>3.1445055E7</span>
        }
      }
    ]
  }
}
<span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script async src="https://www.googletagmanager.com/gtag/js?id=G-RJPTVP614C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-RJPTVP614C');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div><script type=module>
    import { searchbox } from "https://coco.infini.cloud/integration/cvn0g9ehpcehvsthrakg/widget";
    searchbox({container: "#searchbox"});
</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#管道聚合>管道聚合</a><ul><li><a href=#管道聚合语法>管道聚合语法</a></li><li><a href=#样例>样例</a><ul><li></li></ul></li><li><a href=#管道聚合类型>管道聚合类型</a><ul><li><a href=#同级聚合>同级聚合</a></li><li><a href=#父级聚合>父级聚合</a></li></ul></li><li><a href=#avg_bucket-sum_bucket-min_bucket-max_bucket>avg_bucket, sum_bucket, min_bucket, max_bucket</a><ul><li></li></ul></li><li><a href=#stats_bucket-extended_stats_bucket>stats_bucket, extended_stats_bucket</a><ul><li></li></ul></li><li><a href=#bucket_script-bucket_selector>bucket_script, bucket_selector</a><ul><li></li></ul></li><li><a href=#bucket_sort>bucket_sort</a><ul><li></li></ul></li><li><a href=#cumulative_sum>cumulative_sum</a><ul><li></li></ul></li><li><a href=#derivative>derivative</a><ul><li></li></ul></li><li><a href=#moving_avg>moving_avg</a><ul><li></li></ul></li><li><a href=#serial_diff>serial_diff</a><ul><li></li></ul></li></ul></li></ul></nav></aside></main><script src=/easysearch/v1.12.2/js/asciinema-player.js></script></body></html>