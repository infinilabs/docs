<!doctype html><html lang=zh><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="数据汇总 #  数据汇总或上卷（Rollup），对于时序场景类的数据，往往会有大量的非常详细的聚合指标，随着时间的图推移，存储将持续增长。汇总功能可以将旧的、细粒度的数据汇总为粗粒度格式以进行长期存储。通过将数据汇总到一个单一的文档中，可以大大降低历史数据的存储成本。 Easysearch 的 rollup 具备一些独特的优势，可以自动对 rollup 索引进行滚动而不用依赖其他 API 去单独设置，并且在进行聚合查询时支持直接搜索原始索引，做到了对业务端的搜索代码完全兼容，从而对用户无感知。
支持的聚合类型 #  对数值类型字段支持的聚合
 avg sum max min value_count percentiles  对 keyword 类型字段提供 terms 聚合。
对 date 类型字段 除了 date_histogram 聚合，还支持 date_range 聚合。(v1.10.0)
查询 rollup 数据时，增加支持 Filter aggregation，某些场景可以用来替代 query 过滤数据。(v1.10.1)
增加针对个别字段自定义 special_metrics 指标的配置项。 (v1.10.1)
增加支持 Bucket sort aggregation。 (v1.10.1)
混合查询原始索引和 rollup 索引时，返回的 response 里增加了 origin 参数，表示包含 rollup 数据。(v1.10.1)
Rollup 查询 API 提供了 debug 参数，显示 Easysearch 内部执行的查询语句。(v1.10.1)"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="数据汇总"><meta property="og:description" content="数据汇总 #  数据汇总或上卷（Rollup），对于时序场景类的数据，往往会有大量的非常详细的聚合指标，随着时间的图推移，存储将持续增长。汇总功能可以将旧的、细粒度的数据汇总为粗粒度格式以进行长期存储。通过将数据汇总到一个单一的文档中，可以大大降低历史数据的存储成本。 Easysearch 的 rollup 具备一些独特的优势，可以自动对 rollup 索引进行滚动而不用依赖其他 API 去单独设置，并且在进行聚合查询时支持直接搜索原始索引，做到了对业务端的搜索代码完全兼容，从而对用户无感知。
支持的聚合类型 #  对数值类型字段支持的聚合
 avg sum max min value_count percentiles  对 keyword 类型字段提供 terms 聚合。
对 date 类型字段 除了 date_histogram 聚合，还支持 date_range 聚合。(v1.10.0)
查询 rollup 数据时，增加支持 Filter aggregation，某些场景可以用来替代 query 过滤数据。(v1.10.1)
增加针对个别字段自定义 special_metrics 指标的配置项。 (v1.10.1)
增加支持 Bucket sort aggregation。 (v1.10.1)
混合查询原始索引和 rollup 索引时，返回的 response 里增加了 origin 参数，表示包含 rollup 数据。(v1.10.1)
Rollup 查询 API 提供了 debug 参数，显示 Easysearch 内部执行的查询语句。(v1.10.1)"><meta property="og:type" content="article"><meta property="og:url" content="/easysearch/v1.11.1/docs/references/management/rollup_api/"><title>数据汇总 | INFINI Easysearch</title><link rel=manifest href=/easysearch/v1.11.1/manifest.json><link rel=icon href=/easysearch/v1.11.1/favicon.png type=image/x-icon><link rel=stylesheet href=/easysearch/v1.11.1/book.min.d80e87b12a4b49d9913d0bdd98bd83b7a44988be784760ba15522b377313dcf9.css integrity="sha256-2A6HsSpLSdmRPQvdmL2Dt6RJiL54R2C6FVIrN3MT3Pk="><link rel=stylesheet type=text/css href=/easysearch/v1.11.1/css/asciinema-player.css><script defer src=/easysearch/v1.11.1/js/jquery-2.x.min.js></script><script defer src=/easysearch/v1.11.1/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/easysearch/v1.11.1><img src=/easysearch/v1.11.1/img/logo-zh.svg alt=Logo></a></h2><div class=heading><select class=version-selector>
<option value>main (latest)</option>
<option value=v1.11.1>v1.11.1</option>
<option value=v1.11.0>v1.11.0</option>
<option value=v1.9.1>v1.9.1</option>
<option value=v1.8.3>v1.8.3</option>
<option value=v1.8.2>v1.8.2</option>
<option value=v1.8.0>v1.8.0</option>
<option value=v1.7.1>v1.7.1</option>
<option value=v1.7.0>v1.7.0</option>
<option value=v1.6.2>v1.6.2</option>
<option value=v1.6.1>v1.6.1</option>
<option value=v1.6.0>v1.6.0</option>
<option value=v1.5.0>v1.5.0</option>
<option value=v1.4.0>v1.4.0</option>
<option value=v1.3.0>v1.3.0</option>
<option value=v1.2.0>v1.2.0</option>
<option value=v1.1.1>v1.1.1</option>
<option value=v1.1.0>v1.1.0</option>
<option value=v1.0.1>v1.0.1</option>
<option value=v1.0.0>v1.0.0</option></select></div><ul><li><a href=/easysearch/v1.11.1/docs/overview/>产品概述</a><ul></ul></li><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>入门指南</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-e622c8a7dea0dd02f82a836e861475c5 class=toggle>
<label for=section-e622c8a7dea0dd02f82a836e861475c5 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/getting-started/install/>安装指南</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/getting-started/install/docker/>Docker</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/docker-compose/>Docker Compose</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/helm/>Helm Chart</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/linux/>Linux</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/windows/>Windows</a></li><li><input type=checkbox id=section-8df7e740f0b8d44e94e2d5f3851aef83 class=toggle>
<label for=section-8df7e740f0b8d44e94e2d5f3851aef83 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/>Operator</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/deploy_operator/>部署 Operator</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/deploy_easysearch/>部署 Easysearch</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/resource_manager/>资源扩容</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/node_scale/>节点扩容</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/update_password/>密码修改</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/upgrade/>版本升级</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/cert_manager/>证书管理</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/s3_snapshot/>s3 备份</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/install/operator/FAQ/>FAQ</a></li></ul></li></ul></li><li><a href=/easysearch/v1.11.1/docs/getting-started/settings/>系统调优</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/configuration/>常用配置</a></li><li><a href=/easysearch/v1.11.1/docs/getting-started/configuration_file/>配置说明</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle checked>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a>功能手册</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-dd5a2f6dc33fa990f542566f7a908106 class=toggle>
<label for=section-dd5a2f6dc33fa990f542566f7a908106 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/>文档建模</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-7d4ce65a4422588ac64ff568cfa9eb9e class=toggle>
<label for=section-7d4ce65a4422588ac64ff568cfa9eb9e class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/>文档映射</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/analyzer/>分析器参数</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/dynamic/>动态映射参数</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/copy_to/>字段复制参数</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/coerce/>强制类型转换参数</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/doc_values/>文档列值参数</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/enabled/>是否启用参数</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/mapping-parameters/boost/>权重参数设置</a></li></ul></li><li><input type=checkbox id=section-f879c6c2aa847411ec53259bcf512a91 class=toggle>
<label for=section-f879c6c2aa847411ec53259bcf512a91 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/>字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/rank/>Rank 字段类型</a></li><li><input type=checkbox id=section-cd8ebeffb1e1eb5dcc529f4edbad93fc class=toggle>
<label for=section-cd8ebeffb1e1eb5dcc529f4edbad93fc class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/geo-filed-type/>地理字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/geo-filed-type/geo-point/>Geopoint 地理点字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/geo-filed-type/geo-shape/>Geoshape 地理形状字段类型</a></li></ul></li><li><input type=checkbox id=section-f94b121fac5f49bed5028d50034cc3cf class=toggle>
<label for=section-f94b121fac5f49bed5028d50034cc3cf class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/string-field-type/>字符串字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/string-field-type/keyword/>Keyword 字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/string-field-type/text/>Text 字段类型</a></li></ul></li><li><input type=checkbox id=section-37ac2b2e61a91ff3354b11d860ec66cf class=toggle>
<label for=section-37ac2b2e61a91ff3354b11d860ec66cf class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/object-field-type/>对象字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/object-field-type/flattened/>Flat 对象字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/object-field-type/flattened_text/>Flat 对象字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/object-field-type/join/>Join 字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/object-field-type/nested/>Nested 字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/object-field-type/object/>Object 对象字段类型</a></li></ul></li><li><input type=checkbox id=section-4f4e977370cb5a089a66f2d06c0cf2fc class=toggle>
<label for=section-4f4e977370cb5a089a66f2d06c0cf2fc class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/date-field-type/>日期字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/date-field-type/date-nanos/>Date nanoseconds 字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/date-field-type/date/>Date 字段类型</a></li></ul></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/ip/>IP 地址字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/match_only_text/>match_only_text 字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/percolator/>Percolator 过滤器字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/binary/>二进制字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/alias/>别名字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/knn/>向量字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/boolean/>布尔字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/numeric-field/>数值字段类型</a></li><li><input type=checkbox id=section-d087fbeb67c721ac6618bf4ae5f3be20 class=toggle>
<label for=section-d087fbeb67c721ac6618bf4ae5f3be20 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/autocomplete-field-type/>自动补全字段类型</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/autocomplete-field-type/search-as-you-type/>Search-as-you-type 字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/autocomplete-field-type/completion/>自动补全字段类型</a></li></ul></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/range-field-type/>范围字段类型</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/field-types/wildcard/>Wildcard 字段类型</a></li></ul></li><li><input type=checkbox id=section-92a866d9a34e707f209ba1cdbeaba985 class=toggle>
<label for=section-92a866d9a34e707f209ba1cdbeaba985 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/>元数据字段</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/id/>ID 属性</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/meta/>元数据属性</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/field-names/>字段名称</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/ignored/>忽略属性</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/source/>源文档属性</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/index1/>索引属性</a></li><li><a href=/easysearch/v1.11.1/docs/references/mappings-and-field-types/metadata-field/routing/>路由属性</a></li></ul></li></ul></li><li><input type=checkbox id=section-232f0668f3be6ea64e1c220baec34dfc class=toggle>
<label for=section-232f0668f3be6ea64e1c220baec34dfc class="flex justify-between"><a>文档操作</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/document/index-data/>增删改查</a></li><li><a href=/easysearch/v1.11.1/docs/references/document/index-alias/>别名操作</a></li><li><a href=/easysearch/v1.11.1/docs/references/document/index-compression/>索引压缩</a></li></ul></li><li><input type=checkbox id=section-6b02990358c7382bac3f39043e5fd437 class=toggle>
<label for=section-6b02990358c7382bac3f39043e5fd437 class="flex justify-between"><a>搜索操作</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/search/term/>词项查询</a></li><li><a href=/easysearch/v1.11.1/docs/references/search/full-text/>全文查询</a></li><li><a href=/easysearch/v1.11.1/docs/references/search/knn_api/>向量查询</a></li><li><a href=/easysearch/v1.11.1/docs/references/search/bool/>布尔查询</a></li><li><a href=/easysearch/v1.11.1/docs/references/search/search-template/>查询模版</a></li><li><a href=/easysearch/v1.11.1/docs/references/search/async_search/>异步搜索</a></li><li><a href=/easysearch/v1.11.1/docs/references/search/pit_api/>定点查询 API</a></li></ul></li><li><input type=checkbox id=section-69a0462c4990a8b0bf6189289fb56e8a class=toggle>
<label for=section-69a0462c4990a8b0bf6189289fb56e8a class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/aggregation/>聚合操作</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/aggregation/metric-agg/>指标聚合</a></li><li><a href=/easysearch/v1.11.1/docs/references/aggregation/bucket-agg/>分桶聚合</a></li><li><a href=/easysearch/v1.11.1/docs/references/aggregation/pipeline-agg/>管道聚合</a></li></ul></li><li><input type=checkbox id=section-86e828ca7e30e9d2e35881b956319411 class=toggle>
<label for=section-86e828ca7e30e9d2e35881b956319411 class="flex justify-between"><a>SQL 查询</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/sql/sql-jdbc/>SQL-JDBC</a></li><li><a href=/easysearch/v1.11.1/docs/references/sql/aggregations/>聚合查询</a></li><li><a href=/easysearch/v1.11.1/docs/references/sql/fulltext/>全文搜索</a></li><li><a href=/easysearch/v1.11.1/docs/references/sql/complex/>复杂查询</a></li><li><a href=/easysearch/v1.11.1/docs/references/sql/basics/>基础查询</a></li></ul></li><li><input type=checkbox id=section-1c80046b8a7d2b6f02509e78096b1388 class=toggle>
<label for=section-1c80046b8a7d2b6f02509e78096b1388 class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/security/>安全模块</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-4c0acfad57ce0b1db83571ad903a192e class=toggle>
<label for=section-4c0acfad57ce0b1db83571ad903a192e class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/security/configuration/>配置说明</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/security/configuration/yaml/>本地配置</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/configuration/backend/>后端配置</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/configuration/tls/>证书配置</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/configuration/system-indices/>系统索引</a></li></ul></li><li><input type=checkbox id=section-4854412a16ac224d9851d23b7bf6bdea class=toggle>
<label for=section-4854412a16ac224d9851d23b7bf6bdea class="flex justify-between"><a href=/easysearch/v1.11.1/docs/references/security/access-control/>权限控制</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/users-roles/>用户角色</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/document-level-security/>文档权限</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/field-level-security/>字段权限</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/field-masking/>数据脱敏</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/run-as/>身份模拟</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/cross-cluster-search/>跨集群搜索</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/api/>API 接口</a></li><li><a href=/easysearch/v1.11.1/docs/references/security/access-control/permissions/>权限列表</a></li></ul></li></ul></li><li><input type=checkbox id=section-52d7e2e9abce80d3dc7a6a56a0089b77 class=toggle checked>
<label for=section-52d7e2e9abce80d3dc7a6a56a0089b77 class="flex justify-between"><a>管理模块</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/management/cluster/>搭建集群</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/catapis/>CAT API</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/logs/>系统日志</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/index-templates/>索引模板</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/reindex-data/>重建数据</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/tasksapis/>任务管理</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/slm_api/>快照生命周期管理</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/ilm_api/>索引生命周期管理</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/ccr_api/>跨集群复制</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/snapshot-restore/>备份还原</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/throttling/>写入限流</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/searchable_snapshot/>可搜索快照</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/rollup_api/ class=active>数据汇总</a></li><li><a href=/easysearch/v1.11.1/docs/references/management/popular-api/>其它常用 API</a></li></ul></li><li><input type=checkbox id=section-b34adbce31bce6650a0099282b315617 class=toggle>
<label for=section-b34adbce31bce6650a0099282b315617 class="flex justify-between"><a>客户端</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/references/client/java-client/>快速开始</a></li><li><a href=/easysearch/v1.11.1/docs/references/client/client-api/>API 使用</a></li></ul></li></ul></li><li><input type=checkbox id=section-1adc738e7351809ea378ec7e9730bd1f class=toggle>
<label for=section-1adc738e7351809ea378ec7e9730bd1f class="flex justify-between"><a>版本历史</a>
<span>▾</span></label><ul><li><a href=/easysearch/v1.11.1/docs/release-notes/client/>Easysearch-client</a></li><li><a href=/easysearch/v1.11.1/docs/release-notes/easysearch/>Easysearch</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/easysearch/v1.11.1/svg/menu.svg class=book-icon alt=Menu></label>
<strong>数据汇总</strong>
<label for=toc-control><img src=/easysearch/v1.11.1/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#数据汇总>数据汇总</a><ul><li><a href=#支持的聚合类型>支持的聚合类型</a></li><li><a href=#使用汇总rollup的先决条件>使用汇总（rollup）的先决条件</a></li><li><a href=#全局启用或禁用-rollup-搜索的设置>全局启用或禁用 rollup 搜索的设置</a></li><li><a href=#通配符方式批量启动停止-rollup-job>通配符方式批量启动停止 rollup job</a></li><li><a href=#设置-rollup-索引自动滚动的条数>设置 rollup 索引自动滚动的条数</a></li><li><a href=#新增-rollup_search_max_count-配置>新增 <code>ROLLUP_SEARCH_MAX_COUNT</code> 配置</a></li><li><a href=#设置-rollup-查询的时间范围上限>设置 Rollup 查询的时间范围上限</a><ul><li></li></ul></li><li><a href=#汇总rollup-api>汇总（rollup） API：</a><ul><li><a href=#创建或更新索引汇总任务>创建或更新索引汇总任务</a></li><li><a href=#获取索引汇总任务>获取索引汇总任务</a></li><li><a href=#删除索引汇总任务>删除索引汇总任务</a></li><li><a href=#启动或停止索引汇总任务>启动或停止索引汇总任务</a></li><li><a href=#解释索引汇总任务>解释索引汇总任务</a></li></ul></li><li><a href=#如何使用-rollup-索引进行搜索>如何使用 rollup 索引进行搜索</a><ul><li><a href=#注意>注意</a></li></ul></li><li><a href=#为自定义用户赋予rollup-权限>为自定义用户赋予rollup 权限</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=数据汇总>数据汇总
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e6%b1%87%e6%80%bb>#</a></h1><p>数据汇总或上卷（Rollup），对于时序场景类的数据，往往会有大量的非常详细的聚合指标，随着时间的图推移，存储将持续增长。汇总功能可以将旧的、细粒度的数据汇总为粗粒度格式以进行长期存储。通过将数据汇总到一个单一的文档中，可以大大降低历史数据的存储成本。<br>Easysearch 的 rollup 具备一些独特的优势，可以自动对 rollup 索引进行滚动而不用依赖其他 API 去单独设置，并且在进行聚合查询时支持直接搜索原始索引，做到了对业务端的搜索代码完全兼容，从而对用户无感知。</p><h2 id=支持的聚合类型>支持的聚合类型
<a class=anchor href=#%e6%94%af%e6%8c%81%e7%9a%84%e8%81%9a%e5%90%88%e7%b1%bb%e5%9e%8b>#</a></h2><p>对数值类型字段支持的聚合</p><ul><li>avg</li><li>sum</li><li>max</li><li>min</li><li>value_count</li><li>percentiles</li></ul><p>对 keyword 类型字段提供 terms 聚合。</p><p>对 date 类型字段 除了 date_histogram 聚合，还支持 date_range 聚合。(v1.10.0)</p><p>查询 rollup 数据时，增加支持 Filter aggregation，某些场景可以用来替代 query 过滤数据。(v1.10.1)</p><p>增加针对个别字段自定义 special_metrics 指标的配置项。 (v1.10.1)</p><p>增加支持 Bucket sort aggregation。 (v1.10.1)</p><p>混合查询原始索引和 rollup 索引时，返回的 response 里增加了 <code>origin</code> 参数，表示包含 rollup 数据。(v1.10.1)</p><p>Rollup 查询 API 提供了 debug 参数，显示 Easysearch 内部执行的查询语句。(v1.10.1)</p><h2 id=使用汇总rollup的先决条件>使用汇总（rollup）的先决条件
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e6%b1%87%e6%80%bbrollup%e7%9a%84%e5%85%88%e5%86%b3%e6%9d%a1%e4%bb%b6>#</a></h2><p>必须安装索引生命周期管理插件，rollup 属于该插件功能的一部分。</p><p>要汇总的指标索引必须具备 date 类型的字段。</p><h2 id=全局启用或禁用-rollup-搜索的设置>全局启用或禁用 rollup 搜索的设置
<a class=anchor href=#%e5%85%a8%e5%b1%80%e5%90%af%e7%94%a8%e6%88%96%e7%a6%81%e7%94%a8-rollup-%e6%90%9c%e7%b4%a2%e7%9a%84%e8%ae%be%e7%bd%ae>#</a></h2><p>rollup 功能在 index-management 插件里，
从 1.10.0 版本开始，索引生命周期管理插件不再默认启用 rollup 搜索功能，如果想启用搜索 rollup 搜索功能，需要设置</p><pre><code class=language-auto data-lang=auto>PUT /_cluster/settings
{
    &quot;transient&quot;: {
      &quot;rollup.search.enabled&quot;: true
    }
}

</code></pre><h2 id=通配符方式批量启动停止-rollup-job>通配符方式批量启动停止 rollup job
<a class=anchor href=#%e9%80%9a%e9%85%8d%e7%ac%a6%e6%96%b9%e5%bc%8f%e6%89%b9%e9%87%8f%e5%90%af%e5%8a%a8%e5%81%9c%e6%ad%a2-rollup-job>#</a></h2><p>从 1.10.0 版本开始，创建 rollup job 之后不再自动启动，需要手动启动，但是可以通过通配符的方式批量启动、停止 job</p><pre><code class=language-auto data-lang=auto>POST _rollup/jobs/rollup*/_start

POST _rollup/jobs/rollup*/_stop

</code></pre><h2 id=设置-rollup-索引自动滚动的条数>设置 rollup 索引自动滚动的条数
<a class=anchor href=#%e8%ae%be%e7%bd%ae-rollup-%e7%b4%a2%e5%bc%95%e8%87%aa%e5%8a%a8%e6%bb%9a%e5%8a%a8%e7%9a%84%e6%9d%a1%e6%95%b0>#</a></h2><p>达到此条数就会自动滚动新的索引</p><pre><code class=language-auto data-lang=auto>PUT /_cluster/settings
{
    &quot;transient&quot;: {
      &quot;rollup.max_docs&quot;: 10000000
    }
}

</code></pre><h2 id=新增-rollup_search_max_count-配置>新增 <code>ROLLUP_SEARCH_MAX_COUNT</code> 配置
<a class=anchor href=#%e6%96%b0%e5%a2%9e-rollup_search_max_count-%e9%85%8d%e7%bd%ae>#</a></h2><p>从 1.10.0 版本开始，新增了 <code>ROLLUP_SEARCH_MAX_COUNT</code> 配置项，用于控制 Rollup 在运行 Job 时收集历史数据的最大并发分片请求数。这个配置项可以帮助你优化 Rollup 任务的性能，并避免集群资源过载。</p><h2 id=设置-rollup-查询的时间范围上限>设置 Rollup 查询的时间范围上限
<a class=anchor href=#%e8%ae%be%e7%bd%ae-rollup-%e6%9f%a5%e8%af%a2%e7%9a%84%e6%97%b6%e9%97%b4%e8%8c%83%e5%9b%b4%e4%b8%8a%e9%99%90>#</a></h2><p>从 1.10.1 版本开始，可以通过 <code>rollup.hours_before</code> 集群配置项，设置 rollup 数据的查询时间范围上限，默认值是 1，表示 针对 rollup 数据的查询不会超过当前时间的 1 小时之前，
此参数的使用场景：</p><ol><li>在混合查询时将 rollup 数据和原始数据的查询分割，防止查询的时间范围和数据不匹配。</li><li>限制 rollup 数据的查询时间上限。</li></ol><p>使用示例：</p><pre><code class=language-auto data-lang=auto>PUT /_cluster/settings
{
  &quot;transient&quot;: {
    &quot;rollup.hours_before&quot;: 24

  }
}
</code></pre><p>设置后，对 rollup 数据的查询范围上限不会超过 24 小时之前。</p><h4 id=功能>功能：
<a class=anchor href=#%e5%8a%9f%e8%83%bd>#</a></h4><ul><li><strong>控制并发请求数</strong>：限制 Rollup 任务在执行搜索请求时的最大并发分片请求数。</li><li><strong>动态调整</strong>：支持在集群运行时动态调整，无需重启集群。</li><li><strong>默认值</strong>：<code>2</code>，即默认情况下，Rollup 任务最多会同时发送 2 个并发分片请求。</li></ul><h4 id=示例>示例：
<a class=anchor href=#%e7%a4%ba%e4%be%8b>#</a></h4><pre><code class=language-auto data-lang=auto>PUT /_cluster/settings
{
    &quot;transient&quot;: {
      &quot;rollup.search.max_count&quot;: 2
    }
}
</code></pre><p>在这个例子中，<code>ROLLUP_SEARCH_MAX_COUNT</code> 被设置为 <code>2</code>，表示 Rollup 任务在执行搜索请求时，最多会同时发送 2 个并发分片请求。</p><h4 id=配置建议>配置建议：
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e5%bb%ba%e8%ae%ae>#</a></h4><ul><li><strong>小规模集群</strong>：建议设置为较小的值（如 <code>2</code>），以避免资源竞争。</li><li><strong>大规模集群</strong>：可以适当增加该值（如 <code>4</code>），以提高并发性能。</li><li><strong>动态调整</strong>：根据集群负载情况动态调整该值，以优化性能和资源利用率。</li></ul><h4 id=rollup-自动滚动后的索引列表>rollup 自动滚动后的索引列表
<a class=anchor href=#rollup-%e8%87%aa%e5%8a%a8%e6%bb%9a%e5%8a%a8%e5%90%8e%e7%9a%84%e7%b4%a2%e5%bc%95%e5%88%97%e8%a1%a8>#</a></h4><pre><code>health status index                          uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   rollup1_.infini_metrics-000001 aNET5la8QBa8AtCAtplPAw   1   0     179783            0        1gb            1gb
green  open   rollup1_.infini_metrics-000002 7TDSIvWvSvKuKbB0DH-J0w   1   0     179170            0        1gb            1gb
green  open   rollup1_.infini_metrics-000003 MhtBEj_-RgCg29gAbkbg6g   1   0     178297            0        1gb            1gb
green  open   rollup1_.infini_metrics-000004 -Gfp80nUR5Cz-XnFy3F0rw   1   0     178297            0        1gb            1gb
green  open   rollup1_.infini_metrics-000005 CuhhEf9SQ--yzMkG0QgLQw   1   0     177665            0        1gb            1gb
green  open   rollup1_.infini_metrics-000006 9LqFJ28XRKexgwlMgIy3Bg   1   0     178624            0        1gb            1gb
green  open   rollup1_.infini_metrics-000007 XkrPz8DDSRSq8xhnWo3nbA   1   0     180581            0        1gb            1gb
green  open   rollup1_.infini_metrics-000008 xrfETulmT7OZnfcfVrIJTw   1   0     180050            0        1gb            1gb

</code></pre><h2 id=汇总rollup-api>汇总（rollup） API：
<a class=anchor href=#%e6%b1%87%e6%80%bbrollup-api>#</a></h2><ul><li>创建或替换索引汇总任务</li><li>获取索引汇总任务</li><li>删除索引汇总任务</li><li>启动或停止索引汇总任务</li><li>解释索引汇总任务</li></ul><h3 id=创建或更新索引汇总任务>创建或更新索引汇总任务
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e6%88%96%e6%9b%b4%e6%96%b0%e7%b4%a2%e5%bc%95%e6%b1%87%e6%80%bb%e4%bb%bb%e5%8a%a1>#</a></h3><p>创建或自动替换一个索引汇总任务</p><p>PUT _rollup/jobs/&lt;rollup_id>?replace</p><p>&lt;rollup_id>: 为您的 Rollup 任务指定一个唯一标识符。<br>?replace: 如果已存在同名任务，此参数允许替换现有任务。</p><h4 id=请求示例>请求示例
<a class=anchor href=#%e8%af%b7%e6%b1%82%e7%a4%ba%e4%be%8b>#</a></h4><p>下面的例子会创建一个自动滚动的 rollup 索引</p><pre><code class=language-auto data-lang=auto>PUT _rollup/jobs/rollup_node_stats
{
  &quot;rollup&quot;: {
    &quot;source_index&quot;: &quot;.infini_metrics&quot;,
    &quot;target_index&quot;: &quot;rollup_node_stats_{{ctx.source_index}}&quot;,
    &quot;timestamp&quot;: &quot;timestamp&quot;,
    &quot;continuous&quot;: true,
    &quot;page_size&quot;: 200,
    &quot;cron&quot;: &quot;*/5 1-23 * * *&quot;,
    &quot;timezone&quot;: &quot;UTC+8&quot;,
    &quot;stats&quot;: [
      {
        &quot;max&quot;: {}
      },
      {
        &quot;min&quot;: {}
      },
      {
        &quot;value_count&quot;: {}
      }
    ],
    &quot;interval&quot;: &quot;1m&quot;,
    &quot;identity&quot;: [
      &quot;metadata.labels.cluster_id&quot;,
      &quot;metadata.labels.cluster_uuid&quot;,
      &quot;metadata.category&quot;,
      &quot;metadata.labels.node_id&quot;,
      &quot;metadata.labels.transport_address&quot;
    ],
    &quot;attributes&quot;: [
      &quot;agent.*&quot;,
      &quot;metadata.*&quot;
    ],
    &quot;filter&quot;: {
      &quot;metadata.name&quot;: &quot;node_stats&quot;
    },
    &quot;metrics&quot;: [
      &quot;payload.elasticsearch.node_stats.*&quot;
    ],
    &quot;special_metrics&quot;: [
      {
        &quot;source_field&quot;: &quot;payload.elasticsearch.node_stats.jvm.mem.heap_used_in_bytes&quot;,
        &quot;metrics&quot;: [
          {
            &quot;avg&quot;: {}
          },
          {
            &quot;max&quot;: {}
          },
          {
            &quot;min&quot;: {}
          },
          {
            &quot;percentiles&quot;: {}
          }
        ]
      }
    ]
  }
}
</code></pre><h4 id=参数详细说明>参数详细说明
<a class=anchor href=#%e5%8f%82%e6%95%b0%e8%af%a6%e7%bb%86%e8%af%b4%e6%98%8e>#</a></h4><table><thead><tr><th>参数</th><th>解释</th><th>示例值说明</th></tr></thead><tbody><tr><td><code>source_index</code></td><td>源索引，数据将从此索引中收集</td><td><code>.infini_metrics</code>: 表示从名为 .infini_metrics 的索引中收集数据</td></tr><tr><td><code>target_index</code></td><td>目标索引，汇总数据将存储在此索引中</td><td><code>rollup1_{{ctx.source_index}}</code>: 动态生成目标索引名，使用源索引名作为一部分</td></tr><tr><td><code>timestamp</code></td><td>用于时间聚合的时间戳字段</td><td><code>timestamp</code>: 指定用于时间聚合的字段名</td></tr><tr><td><code>continuous</code></td><td>设置为 true，表示这是一个连续的 rollup 作业，默认为false</td><td><code>true</code>: 任务将持续运行，而不是一次性执行</td></tr><tr><td><code>page_size</code></td><td>每次处理的文档数量</td><td><code>1000</code>: 每批处理1000个文档，可根据系统性能调整</td></tr><tr><td><code>cron</code></td><td>作业运行的调度表达式</td><td><code>*/10 1-23 * * *</code>: 每10分钟执行一次，在1点到23点之间</td></tr><tr><td><code>timezone</code></td><td>用于 cron 表达式的时区</td><td><code>UTC+8</code>: 使用UTC+8时区（如北京时间）</td></tr><tr><td><code>stats</code></td><td>要计算的统计信息</td><td>示例中计算最大值和计数，可根据需求添加其他统计如avg, min等</td></tr><tr><td><code>interval</code></td><td>时间聚合的间隔</td><td><code>1m</code>: 每分钟聚合一次数据</td></tr><tr><td><code>identity</code></td><td>标识字段，用于分组聚合</td><td>列出的字段将用于创建唯一的聚合组</td></tr><tr><td><code>attributes</code></td><td>要包含在 rollup 中的属性字段</td><td><code>agent.*</code>, <code>metadata.*</code>: 包含所有以agent和metadata开头的字段</td></tr><tr><td><code>metrics</code></td><td>要汇总的指标字段</td><td><code>payload.elasticsearch.index_stats.*</code>: 汇总所有index_stats下的指标</td></tr><tr><td><code>special_metrics</code></td><td>对特别关注的指标配置更丰富的统计方式</td><td>专门对 JVM 堆内存使用量这个字段计算 <code>avg max min percentiles</code> 4 个指标，不再计算 <code>stats</code> 里的默认指标</td></tr><tr><td><code>exclude</code></td><td>要排除的指标字段</td><td><code>payload.elasticsearch.index_stats.routing.*</code>: metrics 会排除符合模式的字段</td></tr><tr><td><code>filter</code></td><td>用于过滤源文档的条件</td><td><code>{"metadata.name": "index_stats"}</code>: 只处理metadata.name为index_stats的文档</td></tr></tbody></table><h4 id=注意事项>注意事项
<a class=anchor href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9>#</a></h4><ol><li><code>cron</code> 表达式需要谨慎设置，确保不会对系统造成过大负担。</li><li><code>page_size</code> 应根据您的系统性能和数据量来调整。</li><li><code>identity</code> 字段的选择会影响聚合的粒度，请根据您的分析需求仔细选择。</li><li>使用通配符（如 <code>agent.*</code>）时要注意，这可能会包含大量字段，影响性能。</li><li><code>filter</code> 可以有效减少处理的数据量，提高效率。</li></ol><h3 id=获取索引汇总任务>获取索引汇总任务
<a class=anchor href=#%e8%8e%b7%e5%8f%96%e7%b4%a2%e5%bc%95%e6%b1%87%e6%80%bb%e4%bb%bb%e5%8a%a1>#</a></h3><p>请求</p><pre><code class=language-auto data-lang=auto>GET _rollup/jobs/&lt;rollup_id&gt;
</code></pre><p>响应</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;rollup4&#34;</span>,
  <span style=color:#f92672>&#34;_version&#34;</span>: <span style=color:#ae81ff>3</span>,
  <span style=color:#f92672>&#34;_seq_no&#34;</span>: <span style=color:#ae81ff>5</span>,
  <span style=color:#f92672>&#34;_primary_term&#34;</span>: <span style=color:#ae81ff>1</span>,
  <span style=color:#f92672>&#34;rollup&#34;</span>: {
    <span style=color:#f92672>&#34;rollup_id&#34;</span>: <span style=color:#e6db74>&#34;rollup4&#34;</span>,
    <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>false</span>,
    <span style=color:#f92672>&#34;schedule&#34;</span>: {
      <span style=color:#f92672>&#34;interval&#34;</span>: {
        <span style=color:#f92672>&#34;start_time&#34;</span>: <span style=color:#ae81ff>1718105163766</span>,
        <span style=color:#f92672>&#34;period&#34;</span>: <span style=color:#ae81ff>1</span>,
        <span style=color:#f92672>&#34;unit&#34;</span>: <span style=color:#e6db74>&#34;Minutes&#34;</span>,
        <span style=color:#f92672>&#34;schedule_delay&#34;</span>: <span style=color:#ae81ff>0</span>
      }
    },
    <span style=color:#f92672>&#34;last_updated_time&#34;</span>: <span style=color:#ae81ff>1718105163767</span>,
    <span style=color:#f92672>&#34;enabled_time&#34;</span>: <span style=color:#66d9ef>null</span>,
    <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Example rollup job&#34;</span>,
    <span style=color:#f92672>&#34;schema_version&#34;</span>: <span style=color:#ae81ff>17</span>,
    <span style=color:#f92672>&#34;source_index&#34;</span>: <span style=color:#e6db74>&#34;test-data&#34;</span>,
    <span style=color:#f92672>&#34;target_index&#34;</span>: <span style=color:#e6db74>&#34;rollup4-test&#34;</span>,
    <span style=color:#f92672>&#34;metadata_id&#34;</span>: <span style=color:#e6db74>&#34;nuMNB5ABnvQbLaVPM5qO&#34;</span>,
    <span style=color:#f92672>&#34;page_size&#34;</span>: <span style=color:#ae81ff>200</span>,
    <span style=color:#f92672>&#34;delay&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;continuous&#34;</span>: <span style=color:#66d9ef>false</span>,
    <span style=color:#f92672>&#34;dimensions&#34;</span>: [
      {
        <span style=color:#f92672>&#34;date_histogram&#34;</span>: {
          <span style=color:#f92672>&#34;fixed_interval&#34;</span>: <span style=color:#e6db74>&#34;1m&#34;</span>,
          <span style=color:#f92672>&#34;source_field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
          <span style=color:#f92672>&#34;target_field&#34;</span>: <span style=color:#e6db74>&#34;@timestamp&#34;</span>,
          <span style=color:#f92672>&#34;timezone&#34;</span>: <span style=color:#e6db74>&#34;UTC&#34;</span>
        }
      }
    ],
    <span style=color:#f92672>&#34;metrics&#34;</span>: [
      {
        <span style=color:#f92672>&#34;source_field&#34;</span>: <span style=color:#e6db74>&#34;passenger_count&#34;</span>,
        <span style=color:#f92672>&#34;metrics&#34;</span>: [
          {
            <span style=color:#f92672>&#34;avg&#34;</span>: {}
          },
          {
            <span style=color:#f92672>&#34;sum&#34;</span>: {}
          },
          {
            <span style=color:#f92672>&#34;max&#34;</span>: {}
          },
          {
            <span style=color:#f92672>&#34;min&#34;</span>: {}
          },
          {
            <span style=color:#f92672>&#34;value_count&#34;</span>: {}
          }
        ]
      }
    ]
  }
}
</code></pre></div><h3 id=删除索引汇总任务>删除索引汇总任务
<a class=anchor href=#%e5%88%a0%e9%99%a4%e7%b4%a2%e5%bc%95%e6%b1%87%e6%80%bb%e4%bb%bb%e5%8a%a1>#</a></h3><p>请求</p><pre><code class=language-auto data-lang=auto>DELETE _rollup/jobs/&lt;rollup_id&gt;
</code></pre><p>响应</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;_index&#34;</span>: <span style=color:#e6db74>&#34;.easysearch-ilm-config&#34;</span>,
  <span style=color:#f92672>&#34;_type&#34;</span>: <span style=color:#e6db74>&#34;_doc&#34;</span>,
  <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;rollup4&#34;</span>,
  <span style=color:#f92672>&#34;_version&#34;</span>: <span style=color:#ae81ff>7</span>,
  <span style=color:#f92672>&#34;result&#34;</span>: <span style=color:#e6db74>&#34;deleted&#34;</span>,
  <span style=color:#f92672>&#34;forced_refresh&#34;</span>: <span style=color:#66d9ef>true</span>,
  <span style=color:#f92672>&#34;_shards&#34;</span>: {
    <span style=color:#f92672>&#34;total&#34;</span>: <span style=color:#ae81ff>2</span>,
    <span style=color:#f92672>&#34;successful&#34;</span>: <span style=color:#ae81ff>1</span>,
    <span style=color:#f92672>&#34;failed&#34;</span>: <span style=color:#ae81ff>0</span>
  },
  <span style=color:#f92672>&#34;_seq_no&#34;</span>: <span style=color:#ae81ff>23</span>,
  <span style=color:#f92672>&#34;_primary_term&#34;</span>: <span style=color:#ae81ff>1</span>
}
</code></pre></div><h3 id=启动或停止索引汇总任务>启动或停止索引汇总任务
<a class=anchor href=#%e5%90%af%e5%8a%a8%e6%88%96%e5%81%9c%e6%ad%a2%e7%b4%a2%e5%bc%95%e6%b1%87%e6%80%bb%e4%bb%bb%e5%8a%a1>#</a></h3><p>请求</p><pre><code class=language-auto data-lang=auto>POST _rollup/jobs/&lt;rollup_id&gt;/_start
POST _rollup/jobs/&lt;rollup_id&gt;/_stop
</code></pre><p>响应</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;acknowledged&#34;</span>: <span style=color:#66d9ef>true</span>
}
</code></pre></div><h3 id=解释索引汇总任务>解释索引汇总任务
<a class=anchor href=#%e8%a7%a3%e9%87%8a%e7%b4%a2%e5%bc%95%e6%b1%87%e6%80%bb%e4%bb%bb%e5%8a%a1>#</a></h3><p>请求</p><pre><code class=language-auto data-lang=auto>GET _rollup/jobs/&lt;rollup_id&gt;/_explain
</code></pre><p>响应</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;rollup1&#34;</span>: {
    <span style=color:#f92672>&#34;metadata_id&#34;</span>: <span style=color:#e6db74>&#34;VCAnj5IBQpC3NDmZwgL7&#34;</span>,
    <span style=color:#f92672>&#34;rollup_metadata&#34;</span>: {
      <span style=color:#f92672>&#34;rollup_id&#34;</span>: <span style=color:#e6db74>&#34;rollup1&#34;</span>,
      <span style=color:#f92672>&#34;last_updated_time&#34;</span>: <span style=color:#ae81ff>1729151524871</span>,
      <span style=color:#f92672>&#34;continuous&#34;</span>: {
        <span style=color:#f92672>&#34;next_window_start_time&#34;</span>: <span style=color:#ae81ff>1728196860000</span>,
        <span style=color:#f92672>&#34;next_window_end_time&#34;</span>: <span style=color:#ae81ff>1728196920000</span>
      },
      <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;started&#34;</span>,
      <span style=color:#f92672>&#34;failure_reason&#34;</span>: <span style=color:#66d9ef>null</span>,
      <span style=color:#f92672>&#34;stats&#34;</span>: {
        <span style=color:#f92672>&#34;pages_processed&#34;</span>: <span style=color:#ae81ff>77014</span>,
        <span style=color:#f92672>&#34;documents_processed&#34;</span>: <span style=color:#ae81ff>135026197</span>,
        <span style=color:#f92672>&#34;rollups_indexed&#34;</span>: <span style=color:#ae81ff>26812185</span>,
        <span style=color:#f92672>&#34;index_time_in_millis&#34;</span>: <span style=color:#ae81ff>38094616</span>,
        <span style=color:#f92672>&#34;search_time_in_millis&#34;</span>: <span style=color:#ae81ff>88930100</span>
      }
    }
  }
}
</code></pre></div><table><thead><tr><th>字段名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>metadata_id</code></td><td>string</td><td>rollup 元数据的唯一标识符</td></tr><tr><td><code>rollup_metadata.rollup_id</code></td><td>string</td><td>rollup 作业的 ID</td></tr><tr><td><code>rollup_metadata.last_updated_time</code></td><td>long</td><td>上次更新时间的 Unix 时间戳（毫秒）</td></tr><tr><td><code>rollup_metadata.continuous.next_window_start_time</code></td><td>long</td><td>下一个 rollup 窗口的开始时间（Unix 时间戳，毫秒）</td></tr><tr><td><code>rollup_metadata.continuous.next_window_end_time</code></td><td>long</td><td>下一个 rollup 窗口的结束时间（Unix 时间戳，毫秒）</td></tr><tr><td><code>rollup_metadata.status</code></td><td>string</td><td>rollup 作业当前的状态</td></tr><tr><td><code>rollup_metadata.failure_reason</code></td><td>string</td><td>null</td></tr><tr><td><code>rollup_metadata.stats.pages_processed</code></td><td>long</td><td>已处理的页面数</td></tr><tr><td><code>rollup_metadata.stats.documents_processed</code></td><td>long</td><td>已处理的文档数</td></tr><tr><td><code>rollup_metadata.stats.rollups_indexed</code></td><td>long</td><td>已索引的 rollup 文档数</td></tr><tr><td><code>rollup_metadata.stats.index_time_in_millis</code></td><td>long</td><td>索引所用的总时间（毫秒）</td></tr><tr><td><code>rollup_metadata.stats.search_time_in_millis</code></td><td>long</td><td>搜索所用的总时间（毫秒）</td></tr></tbody></table><h2 id=如何使用-rollup-索引进行搜索>如何使用 rollup 索引进行搜索
<a class=anchor href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8-rollup-%e7%b4%a2%e5%bc%95%e8%bf%9b%e8%a1%8c%e6%90%9c%e7%b4%a2>#</a></h2><p>无需特意搜索 rollup 索引，只需使用标准的 search API 对原始目标索引进行搜索。查询时，请确保查询符合目标索引的约束条件。
例如，如果你没有在某个字段上设置 terms 聚合，那么你不会收到该字段的 terms 聚合结果。如果你没有设置 maximum 聚合，也不会收到 maximum 聚合的结果。</p><p>无法访问目标索引中数据的内部结构，因为插件会在后台自动重写查询以适应目标索引。这是为了确保对源索引和目标索引使用相同的查询。</p><p>请求示例</p><pre><code class=language-auto data-lang=auto>GET target-test/_search
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;a&quot;: {
      &quot;date_histogram&quot;: {
        &quot;field&quot;: &quot;@timestamp&quot;,
        &quot;fixed_interval&quot;: &quot;1h&quot;
      }
    },
    &quot;total_passenger_count&quot;: {
      &quot;sum&quot;: {
        &quot;field&quot;: &quot;passenger_count&quot;
      }
    }
  }
}
</code></pre><p>响应</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;took&#34;</span>: <span style=color:#ae81ff>3</span>,
  <span style=color:#f92672>&#34;timed_out&#34;</span>: <span style=color:#66d9ef>false</span>,
  <span style=color:#f92672>&#34;_shards&#34;</span>: {
    <span style=color:#f92672>&#34;total&#34;</span>: <span style=color:#ae81ff>1</span>,
    <span style=color:#f92672>&#34;successful&#34;</span>: <span style=color:#ae81ff>1</span>,
    <span style=color:#f92672>&#34;skipped&#34;</span>: <span style=color:#ae81ff>0</span>,
    <span style=color:#f92672>&#34;failed&#34;</span>: <span style=color:#ae81ff>0</span>
  },
  <span style=color:#f92672>&#34;hits&#34;</span>: {
    <span style=color:#f92672>&#34;total&#34;</span>: {
      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>2</span>,
      <span style=color:#f92672>&#34;relation&#34;</span>: <span style=color:#e6db74>&#34;eq&#34;</span>
    },
    <span style=color:#f92672>&#34;max_score&#34;</span>: <span style=color:#66d9ef>null</span>,
    <span style=color:#f92672>&#34;hits&#34;</span>: []
  },
  <span style=color:#f92672>&#34;aggregations&#34;</span>: {
    <span style=color:#f92672>&#34;a&#34;</span>: {
      <span style=color:#f92672>&#34;buckets&#34;</span>: [
        {
          <span style=color:#f92672>&#34;key_as_string&#34;</span>: <span style=color:#e6db74>&#34;2023-08-01T10:00:00.000Z&#34;</span>,
          <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#ae81ff>1690884000000</span>,
          <span style=color:#f92672>&#34;doc_count&#34;</span>: <span style=color:#ae81ff>10</span>
        }
      ]
    },
    <span style=color:#f92672>&#34;total_passenger_count&#34;</span>: {
      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>38</span>
    }
  }
}
</code></pre></div><h3 id=注意>注意
<a class=anchor href=#%e6%b3%a8%e6%84%8f>#</a></h3><p>不能使用同一个查询显示的同时搜索汇总索引和非汇总索引。</p><h2 id=为自定义用户赋予rollup-权限>为自定义用户赋予rollup 权限
<a class=anchor href=#%e4%b8%ba%e8%87%aa%e5%ae%9a%e4%b9%89%e7%94%a8%e6%88%b7%e8%b5%8b%e4%ba%88rollup-%e6%9d%83%e9%99%90>#</a></h2><p>以下示例表示创建了一个自定义用户，这个用户只对 test 开头的索引具备所有权限，并赋予他 rollup 的权限，授权后，test_user将可以创建 rollup job，并对rollup 开头的索引有查询权限。</p><pre><code class=language-auto data-lang=auto>PUT /_security/role/test_role
{
  &quot;indices&quot;: [
    {
      &quot;names&quot;: [ &quot;test*&quot;],
      &quot;privileges&quot;: [ &quot;*&quot; ]
    }
  ]
}

PUT /_security/user/test_user
{
  &quot;password&quot; : &quot;123456&quot;,
  &quot;roles&quot; : [ &quot;test_role&quot;,&quot;rollup_all&quot; ]
}
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/infinilabs/loadgen/edit/master/docs/content.zh/docs/references/management/rollup_api.md target=_blank rel=noopener><img src=/easysearch/v1.11.1/svg/edit.svg class=book-icon alt=Edit>
<span>编辑本页</span></a></div><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script>(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:2567416,hjsv:6};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RJPTVP614C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-RJPTVP614C');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#数据汇总>数据汇总</a><ul><li><a href=#支持的聚合类型>支持的聚合类型</a></li><li><a href=#使用汇总rollup的先决条件>使用汇总（rollup）的先决条件</a></li><li><a href=#全局启用或禁用-rollup-搜索的设置>全局启用或禁用 rollup 搜索的设置</a></li><li><a href=#通配符方式批量启动停止-rollup-job>通配符方式批量启动停止 rollup job</a></li><li><a href=#设置-rollup-索引自动滚动的条数>设置 rollup 索引自动滚动的条数</a></li><li><a href=#新增-rollup_search_max_count-配置>新增 <code>ROLLUP_SEARCH_MAX_COUNT</code> 配置</a></li><li><a href=#设置-rollup-查询的时间范围上限>设置 Rollup 查询的时间范围上限</a><ul><li></li></ul></li><li><a href=#汇总rollup-api>汇总（rollup） API：</a><ul><li><a href=#创建或更新索引汇总任务>创建或更新索引汇总任务</a></li><li><a href=#获取索引汇总任务>获取索引汇总任务</a></li><li><a href=#删除索引汇总任务>删除索引汇总任务</a></li><li><a href=#启动或停止索引汇总任务>启动或停止索引汇总任务</a></li><li><a href=#解释索引汇总任务>解释索引汇总任务</a></li></ul></li><li><a href=#如何使用-rollup-索引进行搜索>如何使用 rollup 索引进行搜索</a><ul><li><a href=#注意>注意</a></li></ul></li><li><a href=#为自定义用户赋予rollup-权限>为自定义用户赋予rollup 权限</a></li></ul></li></ul></nav></aside></main><script src=/easysearch/v1.11.1/js/asciinema-player.js></script></body></html>